 <!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>POS Tiendita</title>
  <style>
    :root { --green:#4caf50; --greenD:#2e7d32; --blue:#1e88e5; --red:#c62828; --bg:#f5f7fb }
    * { box-sizing: border-box }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: linear-gradient(135deg,var(--green),var(--greenD));
      min-height: 100vh; margin: 0; display:flex; align-items:center; justify-content:center; padding: 24px;
    }
    .card {
      width:100%; max-width: 980px; background:#fff; border-radius:16px; padding:24px;
      box-shadow: 0 20px 48px rgba(0,0,0,.25); animation: fade .35s ease;
    }
    h2 { margin: 0 0 10px; text-align:center }
    h3 { margin: 16px 0 12px }
    input, select, button {
      font-size: 15px;
    }
    input, select {
      width:100%; padding:12px; margin:6px 0; border:1px solid #e1e4ea; border-radius:10px; background:#fff;
    }
    button {
      padding:12px 14px; border:0; border-radius:10px; font-weight:700; cursor:pointer; background:var(--green); color:#fff;
    }
    button.secondary { background: var(--blue) }
    button.destructive { background: var(--red) }
    button.ghost { background:#e9eef8; color:#1a2a42 }
    button:hover { filter: brightness(.95) }
    .menu { display:flex; flex-wrap:wrap; gap:10px; margin: 12px 0 0 }
    .menu button { background:var(--blue) }
    .grid { display:grid; gap:12px }
    .col2 { grid-template-columns: 1fr 1fr }
    .col3 { grid-template-columns: 1fr 1fr 1fr }
    table { width:100%; border-collapse: collapse; margin-top: 10px; background:#fff }
    th, td { border: 1px solid #eef1f6; padding: 8px; text-align:center }
    th { background:#f7f9fe }
    .muted { color:#5f6b7a; font-size: 13px }
    .hidden { display:none }
    #resultado { min-height: 22px; margin-top:8px; }
    .ok { color: var(--greenD); font-weight: 700 }
    .warn { color: var(--red); font-weight: 700 }
    .low { background: #fff1f1 }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; background:#ecf3ff; color:#0c3a94 }
    .scan-flash { animation: flash .25s ease-in-out }
    @keyframes flash { from { background:#fff59d } to { background:transparent } }
    @keyframes fade { from{opacity:0; transform: translateY(-6px)} to {opacity:1; transform:none} }
    .section { background: var(--bg); border-radius: 12px; padding: 12px }
    video { width:100%; max-height: 240px; border-radius: 10px; background: #000 }
    pre.json { background:#0b1020; color:#c4d0ff; padding:12px; border-radius:10px; overflow:auto }
  </style>
</head>
<body>
  <div class="card">
    <h2>POS Tiendita</h2>

    <!-- LOGIN -->
    <div id="loginBox">
      <div class="grid">
        <input id="email" type="email" placeholder="Correo" autocomplete="username" />
        <input id="password" type="password" placeholder="Contrase√±a" autocomplete="current-password" />
        <button id="btnLogin">Iniciar sesi√≥n</button>
      </div>
      <div id="resultado" class="muted">Listo para iniciar sesi√≥n‚Ä¶</div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" class="hidden">
      <div class="grid col2">
        <div>
          <div id="userTitle" class="pill">üë§ ‚Äî</div>
          <div id="userRole" class="muted">Rol: ‚Äî</div>
        </div>
        <div style="text-align:right">
          <button id="btnLogout" class="destructive">Cerrar sesi√≥n</button>
        </div>
      </div>

      <div class="menu" id="menuOpciones"></div>

      <div id="vistas" style="margin-top:16px">
        <!-- PRODUCTOS -->
        <div id="vistaProductos" class="hidden section">
          <h3>üì¶ Gesti√≥n de Productos</h3>
          <form id="formProducto" class="grid col3">
            <input id="prodNombre" type="text" placeholder="Nombre" required />
            <input id="prodPrecio" type="number" step="0.01" placeholder="Precio" required />
            <input id="prodStock" type="number" placeholder="Stock inicial" required />
            <div class="grid col3" style="grid-column: 1 / -1; gap:8px;">
              <input id="prodCodigo" type="text" placeholder="C√≥digo de barras (opcional)" />
              <button type="button" id="btnScanProducto" class="ghost">üì∑ Escanear</button>
              <button type="submit" class="secondary">Guardar</button>
            </div>
          </form>
          <video id="previewProd" autoplay muted playsinline class="hidden"></video>

          <div style="margin-top:10px" class="grid col2">
            <div>
              <input id="csvFile" type="file" accept=".csv" />
              <button id="btnImport" class="ghost">Importar CSV</button>
              <div class="muted">Formato: <code>nombre,precio,stock,codigo_barras</code></div>
            </div>
            <div style="text-align:right">
              <span class="pill">üîî Alerta: stock &lt; stock_minimo</span>
            </div>
          </div>

          <table>
            <thead><tr><th>ID</th><th>Nombre</th><th>Precio</th><th>Stock</th><th>M√≠n.</th><th>C√≥digo</th></tr></thead>
            <tbody id="tablaProductos"></tbody>
          </table>
        </div>

        <!-- INVENTARIO -->
        <div id="vistaInventario" class="hidden section">
          <h3>üìä Movimientos de Inventario</h3>
          <form id="formEntrada" class="grid col3">
            <input id="invProducto" type="number" placeholder="Producto ID" required />
            <input id="invCantidad" type="number" placeholder="Cantidad" required />
            <button type="submit" class="secondary">Registrar Entrada</button>
          </form>
          <table>
            <thead><tr><th>Producto</th><th>Cantidad</th><th>Fecha</th><th>Motivo</th></tr></thead>
            <tbody id="tablaInventario"></tbody>
          </table>
        </div>

        <!-- REPORTES -->
        <div id="vistaReportes" class="hidden section">
          <h3>üìë Reporte Diario</h3>
          <button id="btnCargarReporte" class="secondary">Cargar Reporte</button>
          <pre id="reporteContenido" class="json" style="margin-top:10px"></pre>
        </div>

        <!-- VENTAS -->
        <div id="vistaVentas" class="hidden section">
          <h3>üõí Registrar Venta</h3>

          <!-- Buscar por c√≥digo + escanear -->
          <div class="grid col3">
            <input id="codigoBarras" type="text" placeholder="C√≥digo de barras" />
            <button id="btnBuscarCodigo" class="ghost">Buscar</button>
            <button id="btnStartScanner" class="ghost">üì∑ Escanear</button>
          </div>
          <video id="preview" autoplay muted playsinline class="hidden" style="margin-top:8px"></video>

          <!-- Selecci√≥n manual -->
          <form id="formVenta" class="grid col3" style="margin-top:10px">
            <select id="ventaProducto"></select>
            <input id="ventaCantidad" type="number" placeholder="Cantidad" required />
            <button type="submit" class="secondary">Agregar al Carrito</button>
          </form>

          <h4 style="margin:12px 0 6px">Carrito</h4>
          <table>
            <thead><tr><th>Producto</th><th>Cant</th><th>Precio</th><th>Subtotal</th></tr></thead>
            <tbody id="tablaCarrito"></tbody>
          </table>
          <div class="grid col3" style="align-items:center; margin-top:10px">
            <div class="muted">Total:</div>
            <div style="font-weight:800; font-size:18px">$<span id="totalVenta">0.00</span></div>
            <div style="text-align:right">
              <button id="btnFinalizarVenta">Finalizar Venta</button>
              <button id="btnImprimir" class="ghost">üñ®Ô∏è Imprimir Ticket</button>
            </div>
          </div>
        </div>

        <!-- CAJA -->
        <div id="vistaCaja" class="hidden section">
          <h3>üíµ Caja</h3>
          <form id="formCaja" class="grid col3">
            <input id="cajaMonto" type="number" step="0.01" placeholder="Monto" required />
            <select id="cajaTipo"><option value="ingreso">Ingreso</option><option value="egreso">Egreso</option></select>
            <button type="submit" class="secondary">Registrar</button>
          </form>
          <table>
            <thead><tr><th>Tipo</th><th>Monto</th><th>Fecha</th></tr></thead>
            <tbody id="tablaCaja"></tbody>
          </table>
        </div>

        <!-- HISTORIAL -->
        <div id="vistaHistorial" class="hidden section">
          <h3>üßæ Historial de Ventas</h3>
          <table>
            <thead><tr><th>ID</th><th>Fecha</th><th>Detalle</th></tr></thead>
            <tbody id="tablaHistorial"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Quagga fallback se cargar√° din√°micamente cuando haga falta -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    /*************** CONFIG: PON AQU√ç TUS CREDENCIALES ***************/
    const SUPABASE_URL = 'https://gnguvdqdhqrupkkrtdmp.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImduZ3V2ZHFkaHFydXBra3J0ZG1wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3NjEwNTIsImV4cCI6MjA3NTMzNzA1Mn0.a5XbjmM5eyREKI1j0HrZe36Gz52SAz0_3_jzjW8bYo0';
    /*****************************************************************/

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ------------ Estado ------------
    let carrito = [];
    let productosCache = new Map(); // id -> {nombre, precio, stock, stock_minimo, codigo_barras}

    // ------------ Utilidades UI ------------
    const $ = (id)=>document.getElementById(id);
    const beep = ()=> new Audio('https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg').play();
    const peso = (n)=> Number(n).toFixed(2);

    // ------------ Login ------------
    $('btnLogin').addEventListener('click', async ()=>{
      const email = $('email').value.trim();
      const password = $('password').value.trim();
      const out = $('resultado');
      out.textContent = 'Iniciando‚Ä¶';
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) { out.innerHTML = '<span class=\"warn\">'+error.message+'</span>'; return; }
      out.innerHTML = '<span class=\"ok\">Login OK</span>';
      await cargarPerfil(data.user.id);
    });

    $('btnLogout').addEventListener('click', async ()=>{
      await supabase.auth.signOut();
      $('dashboard').classList.add('hidden');
      $('loginBox').classList.remove('hidden');
      $('resultado').textContent = 'üëã Sesi√≥n cerrada.';
    });

    async function cargarPerfil(uid){
      const { data, error } = await supabase
        .from('profiles')
        .select('nombre, rol_id, rol:rol_id(nombre)')
        .eq('user_id', uid).single();

      if (error || !data) { $('resultado').innerHTML = '<span class=\"warn\">No se encontr√≥ perfil (profiles)</span>'; return; }

      $('loginBox').classList.add('hidden');
      $('dashboard').classList.remove('hidden');
      $('userTitle').textContent = 'üë§ ' + data.nombre;
      $('userRole').textContent  = 'Rol: ' + (data.rol?.nombre ?? '‚Äî');

      const menu = $('menuOpciones'); menu.innerHTML = '';
      if (data.rol?.nombre === 'admin') {
        menu.innerHTML += <button class="secondary" data-v="vistaProductos">üì¶ Productos</button>;
        menu.innerHTML += <button class="secondary" data-v="vistaInventario">üìä Inventario</button>;
        menu.innerHTML += <button class="secondary" data-v="vistaReportes">üìë Reportes</button>;
        menu.innerHTML += <button class="secondary" data-v="vistaVentas">üõí Ventas</button>;
        menu.innerHTML += <button class="secondary" data-v="vistaCaja">üíµ Caja</button>;
        menu.innerHTML += <button class="secondary" data-v="vistaHistorial">üßæ Historial</button>;
      } else {
        menu.innerHTML += <button class="secondary" data-v="vistaVentas">üõí Ventas</button>;
        menu.innerHTML += <button class="secondary" data-v="vistaCaja">üíµ Caja</button>;
        menu.innerHTML += <button class="secondary" data-v="vistaHistorial">üßæ Historial</button>;
      }
      menu.querySelectorAll('button').forEach(b=> b.addEventListener('click', ()=> abrirVista(b.dataset.v)));
      abrirVista('vistaVentas'); // abre ventas de inicio
    }

    function abrirVista(id){
      document.querySelectorAll('#vistas > div').forEach(d=>d.classList.add('hidden'));
      const el = $(id); if (!el) return;
      el.classList.remove('hidden');
      if (id==='vistaProductos') cargarProductos();
      if (id==='vistaInventario') cargarInventario();
      if (id==='vistaVentas') cargarProductosVenta();
      if (id==='vistaCaja') cargarCaja();
      if (id==='vistaHistorial') cargarHistorial();
    }

    // ============ Productos ============
    async function cargarProductos(){
      const { data, error } = await supabase.from('productos').select('*').order('id');
      if (error) { console.error(error); return; }
      productosCache.clear();
      $('tablaProductos').innerHTML = (data||[]).map(p=>{
        productosCache.set(p.id, p);
        const low = (p.stock < (p.stock_minimo ?? 5)) ? 'low' : '';
        return <tr class="${low}"><td>${p.id}</td><td>${p.nombre}</td><td>$${peso(p.precio)}</td><td>${p.stock}</td><td>${p.stock_minimo??5}</td><td>${p.codigo_barras||''}</td></tr>;
      }).join('');
    }

    // Guardar producto: si trae c√≥digo ‚Üí RPC upsert (admin)
    $('formProducto').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const nombre = $('prodNombre').value.trim();
      const precio = parseFloat($('prodPrecio').value);
      const stock = parseInt($('prodStock').value||'0',10);
      const codigo = $('prodCodigo').value.trim();

      try {
        if (codigo) {
          const { error } = await supabase.rpc('upsert_producto_por_codigo', {
            p_nombre: nombre, p_precio: precio, p_codigo: codigo, p_stock_inicial: stock
          });
          if (error) throw error;
        } else {
          const { error } = await supabase.from('productos').insert([{ nombre, precio, stock }]);
          if (error) throw error;
        }
        e.target.reset();
        await cargarProductos();
        alert('‚úÖ Producto guardado');
      } catch(err){ alert('‚ùå '+err.message) }
    });

    // CSV: nombre,precio,stock,codigo_barras
    $('btnImport').addEventListener('click', ()=>{
      const f = $('csvFile').files?.[0];
      if (!f) return alert('Selecciona un CSV');
      const r = new FileReader();
      r.onload = async ()=>{
        const rows = r.result.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
        for (const line of rows) {
          const [nombre,precio,stock,codigo] = line.split(',').map(s=>s?.trim());
          if (!nombre || !precio || !stock) continue;
          try {
            if (codigo) {
              await supabase.rpc('upsert_producto_por_codigo', {
                p_nombre: nombre, p_precio: parseFloat(precio), p_codigo: codigo, p_stock_inicial: parseInt(stock,10)
              });
            } else {
              await supabase.from('productos').insert([{ nombre, precio: parseFloat(precio), stock: parseInt(stock,10) }]);
            }
          } catch {}
        }
        await cargarProductos();
        alert('‚úÖ Importaci√≥n completada');
      };
      r.readAsText(f);
    });

    // Esc√°ner para el campo de producto (rellena #prodCodigo)
    let prodStream=null, prodDetector=null, prodScanning=false;
    $('btnScanProducto').addEventListener('click', async ()=>{
      if (prodScanning) return stopScanProd();
      await startScanProd();
    });
    async function startScanProd(){
      const video = $('previewProd');
      video.classList.remove('hidden');
      prodStream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode: { ideal:'environment' } }, audio:false });
      video.srcObject = prodStream;
      if ('BarcodeDetector' in window) {
        try { prodDetector = new window.BarcodeDetector({ formats:['ean_13','ean_8','upc_a','code_128','qr_code'] }); }
        catch { prodDetector = new window.BarcodeDetector(); }
        prodScanning = true;
        tickProd(video);
      } else { alert('Tu navegador no soporta el esc√°ner nativo aqu√≠. Usa Chrome Android.'); }
    }
    function stopScanProd(){
      prodScanning=false;
      if (prodStream) { prodStream.getTracks().forEach(t=>t.stop()); prodStream=null; }
      $('previewProd').classList.add('hidden');
    }
    async function tickProd(video){
      while (prodScanning && prodDetector) {
        try {
          const canvas = document.createElement('canvas');
          canvas.width = video.videoWidth; canvas.height = video.videoHeight;
          canvas.getContext('2d').drawImage(video,0,0,canvas.width,canvas.height);
          const bmp = await createImageBitmap(canvas);
          const codes = await prodDetector.detect(bmp);
          if (codes?.length) {
            const code = String(codes[0].rawValue||'');
            if (code) {
              stopScanProd(); $('prodCodigo').value = code; beep();
              break;
            }
          }
        } catch {}
        await new Promise(r=>setTimeout(r,200));
      }
    }

    // ============ Ventas ============
    // cargar productos al select (y cachearlos para precios)
    async function cargarProductosVenta(){
      const { data, error } = await supabase.from('productos').select('*').order('nombre');
      if (error) { console.error(error); return; }
      const sel = $('ventaProducto'); sel.innerHTML='';
      productosCache.clear();
      for (const p of (data||[])) {
        productosCache.set(p.id, p);
        sel.innerHTML += <option value="${p.id}">${p.nombre} ($${peso(p.precio)})</option>;
      }
      carrito=[]; renderCarrito();
    }

    // buscar por c√≥digo + agregar al carrito
    $('btnBuscarCodigo').addEventListener('click', async ()=>{
      const code = $('codigoBarras').value.trim(); if (!code) return;
      await buscarYAgregarPorCodigo(code); $('codigoBarras').value='';
    });

    async function buscarYAgregarPorCodigo(code){
      // intenta usar RPC (m√°s r√°pido); si falla, select directo
      let found=null;
      const rpc = await supabase.rpc('buscar_producto_por_codigo', { p_codigo: code });
      if (!rpc.error && rpc.data?.length) found = rpc.data[0];
      if (!found) {
        const { data } = await supabase.from('productos').select('id,nombre,precio,stock,stock_minimo').eq('codigo_barras', code).maybeSingle();
        found = data || null;
      }
      if (!found) { alert('No se encontr√≥ el producto'); return; }
      addToCart(found.id, 1, found.precio, found.nombre);
      // highlight fila en carrito
      const lastRow = $('tablaCarrito').lastElementChild; if (lastRow) lastRow.classList.add('scan-flash');
      beep();
    }

    // esc√°ner con c√°mara para ventas (BarcodeDetector ‚Üí Quagga)
    let stream=null, scanning=false, detector=null, quaggaLoaded=false;
    $('btnStartScanner').addEventListener('click', async ()=>{
      if (scanning) return stopScanner();
      await startScanner();
    });

    async function startScanner(){
      const video = $('preview');
      video.classList.remove('hidden');
      stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ ideal:'environment' } }, audio:false });
      video.srcObject = stream;

      if ('BarcodeDetector' in window) {
        try { detector = new window.BarcodeDetector({ formats:['ean_13','ean_8','upc_a','code_128','qr_code'] }); }
        catch { detector = new window.BarcodeDetector(); }
        scanning = true; tick(video);
      } else {
        await loadQuagga(); startQuagga(video);
      }
    }
    function stopScanner(){
      scanning=false;
      if (stream) { stream.getTracks().forEach(t=>t.stop()); stream=null; }
      $('preview').classList.add('hidden');
      if (window.Quagga) { try { window.Quagga.stop(); } catch {} }
    }
    async function tick(video){
      while (scanning && detector) {
        try {
          const canvas = document.createElement('canvas');
          canvas.width = video.videoWidth; canvas.height = video.videoHeight;
          canvas.getContext('2d').drawImage(video,0,0,canvas.width,canvas.height);
          const bmp = await createImageBitmap(canvas);
          const codes = await detector.detect(bmp);
          if (codes?.length) {
            const code = String(codes[0].rawValue||'');
            if (code) {
              stopScanner(); await buscarYAgregarPorCodigo(code); break;
            }
          }
        } catch {}
        await new Promise(r=>setTimeout(r,180));
      }
    }
    async function loadQuagga(){
      if (quaggaLoaded) return;
      await new Promise((res,rej)=>{
        const s=document.createElement('script');
        s.src='https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js';
        s.onload=()=>{ quaggaLoaded=true; res(); };
        s.onerror=rej; document.body.appendChild(s);
      });
    }
    function startQuagga(video){
      window.Quagga.init({
        inputStream:{ type:'LiveStream', target: video, constraints:{ facingMode:'environment' } },
        decoder:{ readers:['ean_reader','ean_8_reader','upc_reader','upc_e_reader','code_128_reader'] },
        locate:true
      }, (err)=>{
        if (err) { console.error(err); alert('No se pudo iniciar el esc√°ner'); return; }
        scanning=true; window.Quagga.start();
        window.Quagga.onDetected(async r=>{
          const code = r?.codeResult?.code; if (!code) return;
          window.Quagga.offDetected(); stopScanner(); await buscarYAgregarPorCodigo(code);
        });
      });
    }

    // carrito
    $('formVenta').addEventListener('submit', (e)=>{
      e.preventDefault();
      const id = parseInt($('ventaProducto').value,10);
      const cant = parseInt($('ventaCantidad').value,10);
      const p = productosCache.get(id);
      addToCart(id, cant, p?.precio, p?.nombre);
      e.target.reset();
    });

    function addToCart(id, cantidad=1, precio, nombre){
      if (!id || !cantidad || cantidad<=0) return;
      const i = carrito.findIndex(x=>x.id===id);
      if (i>=0) carrito[i].cantidad += cantidad;
      else carrito.push({ id, nombre: nombre??(#${id}), cantidad, precio: Number(precio??0) });
      renderCarrito();
    }
    function renderCarrito(){
      $('tablaCarrito').innerHTML = carrito.map(c=>
        <tr><td>${c.nombre}</td><td>${c.cantidad}</td><td>$${peso(c.precio)}</td><td>$${peso(c.cantidad*c.precio)}</td></tr>
      ).join('');
      $('totalVenta').textContent = peso( carrito.reduce((s,c)=>s+c.cantidad*c.precio,0) );
    }

    // finalizar venta: crea venta + ventas_items; trigger descuenta stock
    $('btnFinalizarVenta').addEventListener('click', async ()=>{
      if (!carrito.length) return alert('Carrito vac√≠o');
      const { data:venta, error:errV } = await supabase.from('ventas').insert({}).select('id').single();
      if (errV) { alert('Error creando venta: '+errV.message); return; }

      for (const c of carrito) {
        const precioUnit = Number(c.precio ?? productosCache.get(c.id)?.precio ?? 0);
        const { error } = await supabase.from('ventas_items').insert({
          venta_id: venta.id, producto_id: c.id, cantidad: c.cantidad, precio_unitario: precioUnit
        });
        if (error) { alert('Error agregando item: '+error.message); return; }
      }
      alert('‚úÖ Venta registrada (#'+venta.id+')');
      carrito=[]; renderCarrito();
      await Promise.all([cargarProductosVenta(), cargarProductos(), cargarHistorial()]);
    });

    // imprimir ticket
    $('btnImprimir').addEventListener('click', ()=>{
      const lines = carrito.map(c=>${c.nombre} x${c.cantidad} = $${peso(c.cantidad*c.precio)}).join('<br>');
      const total = $('totalVenta').textContent;
      const html = 
        <div style="font-family:monospace; padding:12px">
          <h3>POS Tiendita</h3>
          <div>${new Date().toLocaleString()}</div>
          <hr>
          <div>${lines || '(sin items)'}</div>
          <hr>
          <h3>Total: $${total}</h3>
        </div>;
      const w = window.open('', 'ticket'); w.document.write(html); w.print(); w.close();
    });

    // ============ Inventario ============
    async function cargarInventario(){
      const { data, error } = await supabase.from('inventario_movimientos').select('*').order('fecha', { ascending:false });
      if (error) { console.error(error); return; }
      $('tablaInventario').innerHTML = (data||[]).map(m=>
        <tr><td>${m.producto_id}</td><td>${m.cantidad}</td><td>${new Date(m.fecha).toLocaleString()}</td><td>${m.motivo||''}</td></tr>
      ).join('');
    }
    $('formEntrada').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const producto_id = parseInt($('invProducto').value,10);
      const cantidad = parseInt($('invCantidad').value,10);
      const { error } = await supabase.from('inventario_movimientos').insert({ producto_id, cantidad, motivo:'Entrada manual' });
      if (error) alert(error.message); else { e.target.reset(); cargarInventario(); cargarProductos(); }
    });

    // ============ Caja ============
    async function cargarCaja(){
      const { data, error } = await supabase.from('caja_movimientos').select('*').order('fecha', { ascending:false });
      if (error) { console.error(error); return; }
      $('tablaCaja').innerHTML = (data||[]).map(c=>
        <tr><td>${c.tipo}</td><td>$${peso(c.monto)}</td><td>${new Date(c.fecha).toLocaleString()}</td></tr>
      ).join('');
    }
    $('formCaja').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const monto = parseFloat($('cajaMonto').value), tipo = $('cajaTipo').value;
      const { error } = await supabase.from('caja_movimientos').insert({ monto, tipo });
      if (error) alert(error.message); else { e.target.reset(); cargarCaja(); }
    });

    // ============ Historial ============
    async function cargarHistorial(){
      // Requiere PK/FK para que PostgREST exponga relaci√≥n productos <- ventas_items
      const { data, error } = await supabase
        .from('ventas')
        .select('id,fecha,ventas_items(cantidad,precio_unitario,productos(nombre))')
        .order('id', { ascending:false })
        .limit(50);
      if (error) { console.error(error); return; }
      $('tablaHistorial').innerHTML = (data||[]).map(v=>{
        const detalle = (v.ventas_items||[]).map(i=>${i.productos?.nombre || '#?'} x${i.cantidad}).join(', ');
        return <tr><td>${v.id}</td><td>${new Date(v.fecha).toLocaleString()}</td><td>${detalle}</td></tr>;
      }).join('');
    }
  </script>
</body>
</html>
