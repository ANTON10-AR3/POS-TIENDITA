<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>POS Tiendita</title>
  <style>
    body { font-family: Arial, sans-serif; background: linear-gradient(135deg,#4caf50,#2e7d32); margin:0; height:100vh; display:flex; justify-content:center; align-items:center; }
    .card { background:#fff; border-radius:12px; padding:30px; box-shadow:0 6px 18px rgba(0,0,0,.25); width:520px; text-align:center; animation: fadeIn .6s ease; }
    h2 { margin-bottom:20px; }
    input, select { width:100%; padding:12px; margin:8px 0; border:1px solid #ccd; border-radius:8px; font-size:15px; }
    button { padding:12px 16px; margin:8px 4px 0; border:none; border-radius:8px; cursor:pointer; background:#4CAF50; color:#fff; font-weight:700; }
    button:hover { background:#3fa34a; }
    .logout { background:#f44336 !important; }
    .menu button { background:#2196F3; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { border:1px solid #e6e6e6; padding:8px; text-align:center; }
    #resultado { margin-top:12px; font-size:14px; color:#333; min-height:22px; }
    .warn { color:#b00020; font-weight:700; }
    .ok { color:#2e7d32; font-weight:700; }
    .hidden { display:none; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(-8px);} to {opacity:1; transform:translateY(0);} }
  </style>
</head>
<body>
  <!-- Login -->
  <div class="card" id="loginBox">
    <h2>POS Tiendita</h2>
    <input type="email" id="email" placeholder="Correo" autocomplete="username">
    <input type="password" id="password" placeholder="Contrase√±a" autocomplete="current-password">
    <button id="btnLogin">Iniciar sesi√≥n</button>
    <div id="resultado">Listo para iniciar sesi√≥n‚Ä¶</div>
  </div>

  <!-- Dashboard -->
  <div class="card hidden" id="dashboard">
    <h2 id="userTitle"></h2>
    <p id="userRole"></p>
    <div class="menu" id="menuOpciones"></div>
    <div id="vistas">
      <div id="vistaProductos" class="hidden">
        <h3>üì¶ Gesti√≥n de Productos</h3>
        <form id="formProducto">
          <input type="text" id="prodNombre" placeholder="Nombre" required>
          <input type="number" id="prodPrecio" placeholder="Precio" required>
          <input type="number" id="prodStock" placeholder="Stock inicial" required>
          <button type="submit">Agregar Producto</button>
        </form>
        <table>
          <thead><tr><th>Nombre</th><th>Precio</th><th>Stock</th></tr></thead>
          <tbody id="tablaProductos"></tbody>
        </table>
      </div>

      <div id="vistaInventario" class="hidden">
        <h3>üìä Movimientos de Inventario</h3>
        <form id="formEntrada">
          <input type="text" id="invProducto" placeholder="Producto ID" required>
          <input type="number" id="invCantidad" placeholder="Cantidad" required>
          <button type="submit">Registrar Entrada</button>
        </form>
        <table>
          <thead><tr><th>Producto</th><th>Cantidad</th><th>Fecha</th></tr></thead>
          <tbody id="tablaInventario"></tbody>
        </table>
      </div>

      <div id="vistaReportes" class="hidden">
        <h3>üìë Reporte Diario</h3>
        <button id="btnCargarReporte">Cargar Reporte</button>
        <div id="reporteContenido"></div>
      </div>

      <div id="vistaVentas" class="hidden">
        <h3>üõí Registrar Venta</h3>
        <form id="formVenta">
          <select id="ventaProducto"></select>
          <input type="number" id="ventaCantidad" placeholder="Cantidad" required>
          <button type="submit">Agregar al Carrito</button>
        </form>
        <h4>Carrito</h4>
        <ul id="carrito"></ul>
        <button id="btnFinalizarVenta">Finalizar Venta</button>
      </div>

      <div id="vistaCaja" class="hidden">
        <h3>üíµ Caja</h3>
        <form id="formCaja">
          <input type="number" id="cajaMonto" placeholder="Monto" required>
          <select id="cajaTipo">
            <option value="ingreso">Ingreso</option>
            <option value="egreso">Egreso</option>
          </select>
          <button type="submit">Registrar Movimiento</button>
        </form>
        <table>
          <thead><tr><th>Tipo</th><th>Monto</th><th>Fecha</th></tr></thead>
          <tbody id="tablaCaja"></tbody>
        </table>
      </div>
    </div>
    <button class="logout" id="btnLogout">Cerrar sesi√≥n</button>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // ========== CONFIG ==========
    // ‚ö†Ô∏è Pega aqu√≠, SIN espacios al final/ni saltos extras, los valores del MISMO proyecto.
    const SUPABASE_URL_RAW = "https://jmawangtuojrogjwhqwu.supabase.co";
    const SUPABASE_ANON_KEY_RAW = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImptYXdhbmd0dW9qcm9nandocXd1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3MTA0ODYsImV4cCI6MjA3NTI4NjQ4Nn0.trwTULFQZRcsD0yWP45Aw2g2qsnAx409_5BoX3bomlA";

    // Normaliza: quita espacios invisibles y saltos (sin alterar los puntos del JWT)
    const SUPABASE_URL = SUPABASE_URL_RAW.trim();
    const SUPABASE_ANON_KEY = SUPABASE_ANON_KEY_RAW.trim();

    const resultado = document.getElementById("resultado");

    // --- Diagn√≥stico de coincidencia URL <-> KEY ---
    function getRefFromKey(k){
      try { return JSON.parse(atob(k.split('.')[1])).ref; } catch { return null; }
    }
    function getRoleFromKey(k){
      try { return JSON.parse(atob(k.split('.')[1])).role; } catch { return null; }
    }
    const urlRef = (SUPABASE_URL.match(/^https:\/\/([^.]+)\.supabase\.co\/?$/)||[])[1];
    const keyRef = getRefFromKey(SUPABASE_ANON_KEY);
    const keyRole = getRoleFromKey(SUPABASE_ANON_KEY);

    if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
      resultado.innerHTML = '<span class="warn">‚ùå Falta SUPABASE_URL o SUPABASE_ANON_KEY.</span>';
      throw new Error("Missing Supabase config");
    }
    if (!urlRef) {
      resultado.innerHTML = '<span class="warn">‚ùå URL de Supabase inv√°lida.</span>';
      throw new Error("Bad Supabase URL");
    }
    if (!keyRef) {
      resultado.innerHTML = '<span class="warn">‚ùå API key inv√°lida (no se pudo leer el JWT).</span>';
      throw new Error("Bad Supabase key");
    }
    if (urlRef !== keyRef) {
      resultado.innerHTML = `<span class="warn">‚ùå URL y API key son de proyectos distintos.<br>URL ref: <b>${urlRef}</b> | KEY ref: <b>${keyRef}</b></span>`;
      throw new Error("Project mismatch");
    }
    if (keyRole !== 'anon') {
      resultado.innerHTML = `<span class="warn">‚ùå Est√°s usando una key que no es <b>anon</b> (role = ${keyRole}). Copia la <b>anon public</b> de Settings ‚Üí API.</span>`;
      throw new Error("Wrong key role");
    }

    // Si todo est√° OK, inicializa
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    resultado.innerHTML = '<span class="ok">‚úÖ Conexi√≥n configurada.</span>';
    console.log("‚úÖ Supabase listo. Ref:", urlRef);

    // ====== APP ======
    let carrito = [];

    window.addEventListener('DOMContentLoaded', () => {
      document.getElementById("btnLogin").addEventListener("click", login);
      document.getElementById("btnLogout").addEventListener("click", logout);
      document.getElementById("btnCargarReporte").addEventListener("click", cargarReporte);
      document.getElementById("btnFinalizarVenta").addEventListener("click", finalizarVenta);

      document.getElementById("formProducto").addEventListener("submit", onAgregarProducto);
      document.getElementById("formEntrada").addEventListener("submit", onRegistrarEntrada);
      document.getElementById("formVenta").addEventListener("submit", onAgregarAlCarrito);
      document.getElementById("formCaja").addEventListener("submit", onMovimientoCaja);
    });

    async function login() {
      try {
        resultado.textContent = "üîÑ Intentando iniciar sesi√≥n‚Ä¶";
        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value.trim();
        if (!email || !password) { resultado.textContent = "‚ö†Ô∏è Ingresa correo y contrase√±a"; return; }

        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) {
          console.error(error);
          resultado.innerHTML = `<span class="warn">‚ùå Error: ${error.message}</span>`;
          return;
        }
        resultado.textContent = "‚úÖ Login correcto. Cargando perfil‚Ä¶";
        await cargarPerfil(data.user.id);
      } catch (e) {
        console.error(e);
        resultado.innerHTML = `<span class="warn">‚ùå Error inesperado.</span>`;
      }
    }

    async function cargarPerfil(userId) {
      const { data, error } = await supabase
        .from("profiles")
        .select("nombre, rol_id, rol:rol_id(nombre)")
        .eq("user_id", userId).single();

      if (error || !data) {
        console.error("Perfil error:", error);
        resultado.innerHTML = `<span class="warn">‚ö†Ô∏è No se encontr√≥ perfil. Revisa tabla <b>profiles</b> para UID: ${userId}</span>`;
        return;
      }

      document.getElementById("loginBox").classList.add("hidden");
      document.getElementById("dashboard").classList.remove("hidden");
      document.getElementById("userTitle").innerText = "üë§ " + data.nombre;
      document.getElementById("userRole").innerText = "Rol: " + (data.rol?.nombre ?? "‚Äî");

      const menu = document.getElementById("menuOpciones");
      menu.innerHTML = "";
      if (data.rol?.nombre === "admin") {
        menu.innerHTML += `<button data-v="vistaProductos">üì¶ Productos</button>`;
        menu.innerHTML += `<button data-v="vistaInventario">üìä Inventario</button>`;
        menu.innerHTML += `<button data-v="vistaReportes">üìë Reportes</button>`;
      } else {
        menu.innerHTML += `<button data-v="vistaVentas">üõí Ventas</button>`;
        menu.innerHTML += `<button data-v="vistaCaja">üíµ Caja</button>`;
      }
      menu.querySelectorAll("button").forEach(btn => btn.addEventListener("click", () => abrirVista(btn.dataset.v)));
    }

    async function logout() {
      await supabase.auth.signOut();
      document.getElementById("dashboard").classList.add("hidden");
      document.getElementById("loginBox").classList.remove("hidden");
      resultado.textContent = "üëã Sesi√≥n cerrada.";
    }

    function abrirVista(idVista) {
      document.querySelectorAll("#vistas > div").forEach(div => div.classList.add("hidden"));
      const vista = document.getElementById(idVista);
      if (!vista) return;
      vista.classList.remove("hidden");
      if (idVista === "vistaProductos") cargarProductos();
      if (idVista === "vistaInventario") cargarInventario();
      if (idVista === "vistaVentas") cargarProductosVenta();
      if (idVista === "vistaCaja") cargarCaja();
    }

    async function cargarProductos() {
      const { data, error } = await supabase.from("productos").select("*").order("id", { ascending: true });
      if (error) { console.error(error); return; }
      document.getElementById("tablaProductos").innerHTML =
        (data || []).map(p => `<tr><td>${p.nombre}</td><td>$${Number(p.precio).toFixed(2)}</td><td>${p.stock}</td></tr>`).join("");
    }

    async function onAgregarProducto(e) {
      e.preventDefault();
      const nombre = document.getElementById("prodNombre").value.trim();
      const precio = parseFloat(document.getElementById("prodPrecio").value);
      const stock = parseInt(document.getElementById("prodStock").value, 10);
      if (!nombre || isNaN(precio) || isNaN(stock)) return;
      const { error } = await supabase.from("productos").insert([{ nombre, precio, stock }]);
      if (error) { alert("Error: " + error.message); return; }
      e.target.reset();
      await cargarProductos();
    }

    async function cargarInventario() {
      const { data, error } = await supabase.from("inventario_movimientos").select("*").order("fecha", { ascending: false });
      if (error) { console.error(error); return; }
      document.getElementById("tablaInventario").innerHTML =
        (data || []).map(m => `<tr><td>${m.producto_id}</td><td>${m.cantidad}</td><td>${new Date(m.fecha).toLocaleString()}</td></tr>`).join("");
    }

    async function onRegistrarEntrada(e) {
      e.preventDefault();
      const producto = parseInt(document.getElementById("invProducto").value, 10);
      const cantidad = parseInt(document.getElementById("invCantidad").value, 10);
      const { error } = await supabase.from("inventario_movimientos").insert([{ producto_id: producto, cantidad }]);
      if (error) { alert("Error: " + error.message); return; }
      e.target.reset();
      await cargarInventario();
    }

    async function cargarReporte() {
      const cont = document.getElementById("reporteContenido");
      cont.textContent = "Cargando‚Ä¶";
      const { data, error } = await supabase.rpc("reporte_diario");
      if (error) { cont.textContent = "Error: " + error.message; return; }
      cont.textContent = JSON.stringify(data, null, 2);
    }

    async function cargarProductosVenta() {
      const { data, error } = await supabase.from("productos").select("*").order("nombre");
      if (error) { console.error(error); return; }
      const select = document.getElementById("ventaProducto");
      select.innerHTML = (data || []).map(p => `<option value="${p.id}">${p.nombre} ($${Number(p.precio).toFixed(2)})</option>`).join("");
      carrito = []; renderCarrito();
    }

    function onAgregarAlCarrito(e) {
      e.preventDefault();
      const id = parseInt(document.getElementById("ventaProducto").value, 10);
      const cantidad = parseInt(document.getElementById("ventaCantidad").value, 10);
      if (!id || !cantidad || cantidad <= 0) return;
      carrito.push({ id, cantidad }); renderCarrito(); e.target.reset();
    }

    function renderCarrito() {
      document.getElementById("carrito").innerHTML =
        carrito.map(c => `<li>#${c.id} √ó ${c.cantidad}</li>`).join("");
    }

    async function finalizarVenta() {
      if (carrito.length === 0) return alert("Carrito vac√≠o");
      const { data: venta, error } = await supabase.from("ventas").insert([{ fecha: new Date() }]).select("id").single();
      if (error) { alert("Error creando venta: " + error.message); return; }
      carrito = []; renderCarrito(); alert("‚úÖ Venta registrada (id " + venta.id + ")");
    }

    window.finalizarVenta = finalizarVenta;
    window.abrirVista = abrirVista;

    async function cargarCaja() {
      const { data, error } = await supabase.from("caja_movimientos").select("*").order("fecha", { ascending: false });
      if (error) { console.error(error); return; }
      document.getElementById("tablaCaja").innerHTML =
        (data || []).map(m => `<tr><td>${m.tipo}</td><td>${Number(m.monto).toFixed(2)}</td><td>${new Date(m.fecha).toLocaleString()}</td></tr>`).join("");
    }

    async function onMovimientoCaja(e) {
      e.preventDefault();
      const monto = parseFloat(document.getElementById("cajaMonto").value);
      const tipo = document.getElementById("cajaTipo").value;
      const { error } = await supabase.from("caja_movimientos").insert([{ monto, tipo }]);
      if (error) { alert("Error: " + error.message); return; }
      e.target.reset(); await cargarCaja();
    }
  </script>
</body>
</html>
