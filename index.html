<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>POS Tiendita</title>
  <style>
    :root {
      --green:#4caf50;
      --greenD:#2e7d32;
      --blue:#1e88e5;
      --red:#c62828;
      --bg:#f5f7fb;
      --dark:#122033;
    }
    * { box-sizing:border-box; }
    body {
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: linear-gradient(135deg,var(--green),var(--greenD));
      min-height:100vh;
      margin:0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
      color:#1a2433;
    }
    .card {
      width:100%;
      max-width:1100px;
      background:#fff;
      border-radius:18px;
      padding:24px 24px 28px;
      box-shadow:0 22px 52px rgba(0,0,0,.26);
      animation:fade .35s ease;
    }
    h2 {
      margin:0 0 6px;
      text-align:center;
      letter-spacing:.04em;
    }
    h3 { margin:16px 0 12px; }
    input,select,button {
      font-size:15px;
    }
    input,select {
      width:100%;
      padding:11px 12px;
      margin:5px 0;
      border:1px solid #e1e4ea;
      border-radius:10px;
      background:#fff;
    }
    input:focus,select:focus {
      outline:none;
      border-color:var(--blue);
      box-shadow:0 0 0 1px rgba(30,136,229,.25);
    }
    button {
      padding:11px 14px;
      border:0;
      border-radius:10px;
      font-weight:700;
      cursor:pointer;
      background:var(--green);
      color:#fff;
      white-space:nowrap;
    }
    button.secondary { background:var(--blue); }
    button.destructive { background:var(--red); }
    button.ghost { background:#e9eef8; color:#1a2a42; }
    button:hover { filter:brightness(.96); }
    button:disabled { opacity:.55; cursor:not-allowed; }

    .menu { display:flex; flex-wrap:wrap; gap:10px; margin:14px 0 0; }
    .menu button { background:var(--blue); }

    .grid { display:grid; gap:12px; }
    .col2 { grid-template-columns:1fr 1fr; }
    .col3 { grid-template-columns:1fr 1fr 1fr; }
    .col4 { grid-template-columns:2fr 1fr 1.2fr 1fr; }

    table {
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      background:#fff;
      font-size:14px;
    }
    th,td {
      border:1px solid #eef1f6;
      padding:7px 8px;
      text-align:center;
    }
    th { background:#f7f9fe; font-weight:600; }
    .muted { color:#5f6b7a; font-size:13px; }
    .hidden { display:none !important; }

    #resultado { min-height:22px; margin-top:8px; }
    .ok { color:var(--greenD); font-weight:700; }
    .warn { color:var(--red); font-weight:700; }
    .low { background:#fff1f1; }

    .pill {
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:2px 10px;
      border-radius:999px;
      font-size:12px;
      background:#ecf3ff;
      color:#0c3a94;
    }
    .scan-flash { animation:flash .25s ease-in-out; }

    .section {
      background:var(--bg);
      border-radius:12px;
      padding:14px;
      margin-top:6px;
    }
    video {
      width:100%;
      max-height:230px;
      border-radius:10px;
      background:#000;
    }

    pre.json {
      background:#0b1020;
      color:#c4d0ff;
      padding:12px;
      border-radius:10px;
      overflow:auto;
      white-space:pre-wrap;
      font-size:13px;
    }

    .top-row {
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      margin-bottom:6px;
    }

    /* Ticket modal */
    .ticket-modal {
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.45);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:50;
    }
    .ticket-dialog {
      background:#fff;
      border-radius:16px;
      padding:18px 20px 16px;
      width:100%;
      max-width:420px;
      box-shadow:0 18px 40px rgba(0,0,0,.4);
    }
    .ticket-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
    }
    .ticket-header h4 {
      margin:0;
      font-size:16px;
    }
    .ticket-folio {
      font-size:13px;
      color:#4c5a70;
    }
    .ticket-box {
      border-radius:10px;
      border:1px dashed #c7cedd;
      padding:8px 10px;
      background:#fafbff;
      font-family: 'SF Mono','Roboto Mono',monospace;
      font-size:12px;
      white-space:pre-wrap;
      max-height:260px;
      overflow:auto;
    }
    .ticket-footer {
      margin-top:10px;
      text-align:right;
    }

    @keyframes flash {
      from { background:#fff59d; }
      to { background:transparent; }
    }
    @keyframes fade {
      from{opacity:0; transform:translateY(-6px);}
      to{opacity:1; transform:none;}
    }

    @media (max-width:800px){
      .col3,.col4 { grid-template-columns:1fr; }
      body { padding:10px; }
      .card { padding:18px 14px 20px; }
    }
  </style>
</head>
<body>
  <div class="card">
    <h2>POS Tiendita</h2>

    <!-- LOGIN -->
    <div id="loginBox">
      <div class="grid col2">
        <input id="email" type="email" placeholder="Correo" autocomplete="username" />
        <input id="password" type="password" placeholder="ContraseÃ±a" autocomplete="current-password" />
      </div>
      <div style="margin-top:10px; display:flex; justify-content:space-between; gap:10px;">
        <div class="muted" id="resultado">Listo para iniciar sesiÃ³nâ€¦</div>
        <button id="btnLogin">Iniciar sesiÃ³n</button>
      </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" class="hidden">
      <div class="top-row">
        <div>
          <div id="userTitle" class="pill">ðŸ‘¤ â€”</div>
          <div id="userRole" class="muted">Rol: â€”</div>
        </div>
        <button id="btnLogout" class="destructive">Cerrar sesiÃ³n</button>
      </div>

      <div class="menu" id="menuOpciones"></div>

      <div id="vistas" style="margin-top:16px">
        <!-- PRODUCTOS -->
        <div id="vistaProductos" class="hidden section">
          <h3>ðŸ“¦ GestiÃ³n de Productos</h3>
          <form id="formProducto" class="grid col3">
            <input id="prodNombre" type="text" placeholder="Nombre" required />
            <input id="prodPrecio" type="number" step="0.01" placeholder="Precio" required />
            <input id="prodStock" type="number" placeholder="Stock inicial" required />
            <div class="grid col3" style="grid-column:1 / -1; gap:8px;">
              <input id="prodCodigo" type="text" placeholder="CÃ³digo de barras (opcional)" />
              <button type="button" id="btnScanProducto" class="ghost">ðŸ“· Escanear</button>
              <button type="submit" class="secondary">Guardar</button>
            </div>
          </form>
          <video id="previewProd" autoplay muted playsinline class="hidden"></video>

          <div style="margin-top:10px" class="grid col2">
            <div>
              <input id="csvFile" type="file" accept=".csv" />
              <button id="btnImport" class="ghost">Importar CSV</button>
              <div class="muted">Formato: <code>nombre,precio,stock,codigo_barras</code></div>
            </div>
            <div style="text-align:right">
              <span class="pill">ðŸ”” Alerta: stock &lt; stock_minimo</span>
            </div>
          </div>

          <table>
            <thead>
              <tr><th>ID</th><th>Nombre</th><th>Precio</th><th>Stock</th><th>MÃ­n.</th><th>CÃ³digo</th></tr>
            </thead>
            <tbody id="tablaProductos"></tbody>
          </table>
        </div>

        <!-- INVENTARIO -->
        <div id="vistaInventario" class="hidden section">
          <h3>ðŸ“Š Movimientos de Inventario</h3>
          <form id="formEntrada" class="grid col3">
            <input id="invProducto" type="number" placeholder="ID producto" required />
            <input id="invCantidad" type="number" placeholder="Cantidad" required />
            <button type="submit" class="secondary">Registrar Entrada</button>
          </form>
          <table>
            <thead>
              <tr><th>Producto</th><th>Tipo</th><th>Cantidad</th><th>Fecha</th><th>Motivo</th></tr>
            </thead>
            <tbody id="tablaInventario"></tbody>
          </table>
        </div>

        <!-- REPORTES -->
        <div id="vistaReportes" class="hidden section">
          <h3>ðŸ§¾ Corte y Reporte Diario</h3>
          <div class="grid col2">
            <button id="btnCargarReporte" class="secondary">Actualizar reporte de hoy</button>
            <button id="btnSimularCierre" class="ghost">Simular cierre de dÃ­a</button>
          </div>
          <pre id="reporteContenido" class="json" style="margin-top:10px"></pre>
        </div>

        <!-- VENTAS -->
        <div id="vistaVentas" class="hidden section">
          <h3>ðŸ›’ Registrar Venta</h3>

          <!-- Buscar por cÃ³digo + escanear -->
          <div class="grid col3">
            <input id="codigoBarras" type="text" placeholder="CÃ³digo de barras" />
            <button id="btnBuscarCodigo" class="ghost">Buscar / Agregar</button>
            <button id="btnStartScanner" class="ghost">ðŸ“· Escanear con cÃ¡mara</button>
          </div>
          <video id="preview" autoplay muted playsinline class="hidden" style="margin-top:8px"></video>

          <!-- SelecciÃ³n manual -->
          <form id="formVenta" class="grid col3" style="margin-top:10px">
            <select id="ventaProducto"></select>
            <input id="ventaCantidad" type="number" placeholder="Cantidad" required />
            <button type="submit" class="secondary">Agregar al Carrito</button>
          </form>

          <h4 style="margin:12px 0 6px">Carrito</h4>
          <table>
            <thead>
              <tr><th>Producto</th><th>Cant</th><th>Precio</th><th>Subtotal</th></tr>
            </thead>
            <tbody id="tablaCarrito"></tbody>
          </table>

          <div class="grid col2" style="margin-top:10px; align-items:center;">
            <div>
              <div class="muted">Total venta:</div>
              <div style="font-weight:800; font-size:18px">$<span id="totalVenta">0.00</span></div>
            </div>
            <div class="grid col2" style="align-items:center;">
              <div>
                <div class="muted">Efectivo recibido</div>
                <input id="efectivoRecibido" type="number" step="0.01" placeholder="0.00" />
              </div>
              <div>
                <div class="muted">Cambio:</div>
                <div style="font-weight:700;" id="labelCambio">$0.00</div>
              </div>
            </div>
          </div>

          <div style="text-align:right; margin-top:10px;">
            <button id="btnFinalizarVenta">Finalizar Venta</button>
          </div>
        </div>

        <!-- HISTORIAL -->
        <div id="vistaHistorial" class="hidden section">
          <h3>ðŸ“œ Historial de Ventas</h3>
          <table>
            <thead>
              <tr><th>ID</th><th>Fecha</th><th>Total</th><th>Detalle</th></tr>
            </thead>
            <tbody id="tablaHistorial"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL TICKET -->
  <div id="ticketModal" class="ticket-modal hidden">
    <div class="ticket-dialog">
      <div class="ticket-header">
        <h4>Ticket de venta</h4>
        <div id="ticketFolio" class="ticket-folio"></div>
      </div>
      <div id="ticketContenido" class="ticket-box"></div>
      <div class="ticket-footer">
        <button id="btnCerrarTicket" class="ghost">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- SCRIPT -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    /*************** CONFIG SUPABASE ***************/
    const SUPABASE_URL = 'https://gnguvdqdhqrupkkrtdmp.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImduZ3V2ZHFkaHFydXBra3J0ZG1wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3NjEwNTIsImV4cCI6MjA3NTMzNzA1Mn0.a5XbjmM5eyREKI1j0HrZe36Gz52SAz0_3_jzjW8bYo0';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /*************** ESTADO ***************/
    let carrito = [];
    let productosCache = new Map();
    let currentUser = null;
    let currentProfile = null;

    const $  = (id)=>document.getElementById(id);
    const peso = (n)=> Number(n ?? 0).toFixed(2);

    const scanBeep = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');

    /*************** LOGIN ***************/
    $('btnLogin').addEventListener('click', async ()=>{
      const email = $('email').value.trim();
      const password = $('password').value.trim();
      const out = $('resultado');
      if (!email || !password) {
        out.innerHTML = '<span class="warn">Ingresa correo y contraseÃ±a</span>';
        return;
      }
      out.textContent = 'Iniciandoâ€¦';
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) { out.innerHTML = '<span class="warn">'+error.message+'</span>'; return; }
      currentUser = data.user;
      out.innerHTML = '<span class="ok">Login OK</span>';
      await cargarPerfil(data.user.id);
    });

    $('btnLogout').addEventListener('click', async ()=>{
      await supabase.auth.signOut();
      currentUser = null;
      currentProfile = null;
      $('dashboard').classList.add('hidden');
      $('loginBox').classList.remove('hidden');
      $('resultado').textContent = 'ðŸ‘‹ SesiÃ³n cerrada.';
    });

    async function cargarPerfil(uid){
      const { data, error } = await supabase
        .from('profiles')
        .select('nombre, rol_id, rol:rol_id(nombre)')
        .eq('user_id', uid)
        .single();

      if (error || !data) {
        $('resultado').innerHTML = '<span class="warn">No se encontrÃ³ perfil en tabla profiles</span>';
        return;
      }

      currentProfile = data;

      $('loginBox').classList.add('hidden');
      $('dashboard').classList.remove('hidden');
      $('userTitle').textContent = 'ðŸ‘¤ ' + data.nombre;
      $('userRole').textContent  = 'Rol: ' + (data.rol?.nombre ?? 'â€”');

      const menu = $('menuOpciones');
      menu.innerHTML = '';
      if (data.rol?.nombre === 'admin') {
        menu.innerHTML += '<button class="secondary" data-v="vistaVentas">ðŸ›’ Ventas</button>';
        menu.innerHTML += '<button class="secondary" data-v="vistaProductos">ðŸ“¦ Productos</button>';
        menu.innerHTML += '<button class="secondary" data-v="vistaInventario">ðŸ“Š Inventario</button>';
        menu.innerHTML += '<button class="secondary" data-v="vistaReportes">ðŸ§¾ Reportes</button>';
        menu.innerHTML += '<button class="secondary" data-v="vistaHistorial">ðŸ“œ Historial</button>';
      } else {
        menu.innerHTML += '<button class="secondary" data-v="vistaVentas">ðŸ›’ Ventas</button>';
        menu.innerHTML += '<button class="secondary" data-v="vistaHistorial">ðŸ“œ Historial</button>';
      }
      menu.querySelectorAll('button').forEach(b=> b.addEventListener('click', ()=> abrirVista(b.dataset.v)));
      abrirVista('vistaVentas');
    }

    function abrirVista(id){
      document.querySelectorAll('#vistas > div').forEach(d=>d.classList.add('hidden'));
      const el = $(id); if (!el) return;
      el.classList.remove('hidden');
      if (id==='vistaProductos')  cargarProductos();
      if (id==='vistaInventario') cargarInventario();
      if (id==='vistaVentas')     cargarProductosVenta();
      if (id==='vistaHistorial')  cargarHistorial();
    }

    /*************** PRODUCTOS ***************/
    async function cargarProductos(){
      const { data, error } = await supabase.from('productos').select('*').order('id');
      if (error) { console.error(error); return; }
      productosCache.clear();
      $('tablaProductos').innerHTML = (data || []).map(p=>{
        productosCache.set(p.id, p);
        const low = (p.stock < (p.stock_minimo ?? 5)) ? 'low' : '';
        return `
          <tr class="${low}">
            <td>${p.id}</td>
            <td>${p.nombre}</td>
            <td>$${peso(p.precio)}</td>
            <td>${p.stock}</td>
            <td>${p.stock_minimo ?? '-'}</td>
            <td>${p.codigo_barras || ''}</td>
          </tr>`;
      }).join('');
    }

    $('formProducto').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const nombre = $('prodNombre').value.trim();
      const precio = parseFloat($('prodPrecio').value);
      const stock  = parseInt($('prodStock').value || '0',10);
      const codigo = $('prodCodigo').value.trim() || null;
      if (!nombre || isNaN(precio)) { alert('Completa nombre y precio'); return; }

      try {
        if (codigo) {
          const { error } = await supabase.rpc('upsert_producto_por_codigo', {
            p_nombre:nombre, p_precio:precio, p_codigo:codigo, p_stock_inicial:stock
          });
          if (error) throw error;
        } else {
          const { error } = await supabase.from('productos').insert({ nombre, precio, stock });
          if (error) throw error;
        }
        e.target.reset();
        await cargarProductos();
        alert('âœ… Producto guardado');
      } catch(err) {
        alert('Error guardando producto: '+err.message);
      }
    });

    $('btnImport').addEventListener('click', ()=>{
      const f = $('csvFile').files?.[0];
      if (!f) return alert('Selecciona un archivo CSV');
      const r = new FileReader();
      r.onload = async ()=>{
        const rows = String(r.result).split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
        for (const line of rows) {
          const [nombre,precio,stock,codigo] = line.split(',').map(x=>x?.trim());
          if (!nombre || !precio) continue;
          try {
            if (codigo) {
              await supabase.rpc('upsert_producto_por_codigo', {
                p_nombre:nombre,
                p_precio:parseFloat(precio),
                p_codigo:codigo,
                p_stock_inicial:parseInt(stock || '0',10)
              });
            } else {
              await supabase.from('productos').insert({
                nombre,
                precio:parseFloat(precio),
                stock:parseInt(stock || '0',10)
              });
            }
          } catch(e){ console.error(e); }
        }
        await cargarProductos();
        alert('âœ… ImportaciÃ³n terminada');
      };
      r.readAsText(f);
    });

    // EscÃ¡ner para alta de cÃ³digo
    let prodStream=null, prodDetector=null, prodScanning=false;
    $('btnScanProducto').addEventListener('click', async ()=>{
      if (prodScanning) { stopScanProd(); return; }
      if (!('BarcodeDetector' in window)) {
        alert('Tu navegador no soporta escaneo nativo. Puedes usar lector USB.');
        return;
      }
      const video = $('previewProd');
      video.classList.remove('hidden');
      prodStream = await navigator.mediaDevices.getUserMedia({
        video:{ facingMode:{ ideal:'environment' } }, audio:false
      });
      video.srcObject = prodStream;
      prodDetector = new window.BarcodeDetector({ formats:['ean_13','ean_8','upc_a','code_128'] });
      prodScanning = true;
      scanProdLoop(video);
    });

    function stopScanProd(){
      prodScanning=false;
      if (prodStream) { prodStream.getTracks().forEach(t=>t.stop()); prodStream=null; }
      $('previewProd').classList.add('hidden');
    }
    async function scanProdLoop(video){
      while (prodScanning && prodDetector) {
        try {
          if (!video.videoWidth) { await new Promise(r=>setTimeout(r,150)); continue; }
          const canvas=document.createElement('canvas');
          canvas.width=video.videoWidth;
          canvas.height=video.videoHeight;
          canvas.getContext('2d').drawImage(video,0,0,canvas.width,canvas.height);
          const bmp = await createImageBitmap(canvas);
          const codes = await prodDetector.detect(bmp);
          if (codes && codes.length) {
            const code = String(codes[0].rawValue || '');
            if (code) {
              $('prodCodigo').value = code;
              scanBeep.play().catch(()=>{});
              stopScanProd();
              break;
            }
          }
        } catch(e){ console.error(e); }
        await new Promise(r=>setTimeout(r,200));
      }
    }

    /*************** VENTAS ***************/
    async function cargarProductosVenta(){
      const { data, error } = await supabase
        .from('productos')
        .select('id,nombre,precio,stock,codigo_barras')
        .order('nombre');
      if (error) { console.error(error); return; }
      const sel = $('ventaProducto');
      sel.innerHTML='';
      productosCache.clear();
      for (const p of (data || [])) {
        productosCache.set(p.id, p);
        sel.innerHTML += `<option value="${p.id}">${p.nombre} ($${peso(p.precio)}) â€” ${p.stock} en stock</option>`;
      }
      carrito=[];
      renderCarrito();
    }

    $('btnBuscarCodigo').addEventListener('click', async ()=>{
      const code = $('codigoBarras').value.trim();
      if (!code) return;
      await buscarYAgregarPorCodigo(code);
      $('codigoBarras').value='';
    });

    async function buscarYAgregarPorCodigo(code){
      let found=null;
      try {
        const rpc = await supabase.rpc('buscar_producto_por_codigo', { p_codigo:code });
        if (!rpc.error && rpc.data && rpc.data.length) {
          found = rpc.data[0];
        }
      } catch(e){ console.error(e); }

      if (!found) {
        const { data } = await supabase
          .from('productos')
          .select('id,nombre,precio,stock,codigo_barras')
          .eq('codigo_barras', code)
          .maybeSingle();
        if (data) found = data;
      }

      if (!found) { alert('No se encontrÃ³ el producto para ese cÃ³digo'); return; }
      addToCartFromProduct(found, 1);
      const lastRow = $('tablaCarrito').lastElementChild;
      if (lastRow) lastRow.classList.add('scan-flash');
      scanBeep.play().catch(()=>{});
    }

    $('formVenta').addEventListener('submit', (e)=>{
      e.preventDefault();
      const id = parseInt($('ventaProducto').value,10);
      const cant = parseInt($('ventaCantidad').value,10);
      const p = productosCache.get(id);
      if (!p) { alert('Producto inexistente'); return; }
      addToCartFromProduct(p, cant);
      e.target.reset();
    });

    function addToCartFromProduct(p, cantidad){
      if (!p || !cantidad || cantidad<=0) return;
      const ya = carrito.find(x=>x.id===p.id);
      const enCarrito = ya ? ya.cantidad : 0;
      if (p.stock != null && (cantidad + enCarrito) > p.stock) {
        alert(`Solo hay ${p.stock} unidades de "${p.nombre}" en stock`);
        return;
      }
      if (ya) ya.cantidad += cantidad;
      else carrito.push({ id:p.id, nombre:p.nombre, cantidad, precio:Number(p.precio ?? 0) });
      renderCarrito();
    }

    function renderCarrito(){
      $('tablaCarrito').innerHTML = carrito.map(c=>`
        <tr>
          <td>${c.nombre}</td>
          <td>${c.cantidad}</td>
          <td>$${peso(c.precio)}</td>
          <td>$${peso(c.cantidad * c.precio)}</td>
        </tr>
      `).join('');
      const total = carrito.reduce((s,c)=> s + c.cantidad * c.precio, 0);
      $('totalVenta').textContent = peso(total);
      actualizarCambio();
    }

    $('efectivoRecibido').addEventListener('input', actualizarCambio);
    function actualizarCambio(){
      const total = parseFloat($('totalVenta').textContent || '0');
      const efectivo = parseFloat($('efectivoRecibido').value || '0');
      const cambio = Math.max(efectivo - total, 0);
      $('labelCambio').textContent = '$'+peso(cambio);
    }

    // EscÃ¡ner en ventas
    let ventaStream=null, ventaDetector=null, ventaScanning=false;
    $('btnStartScanner').addEventListener('click', async ()=>{
      if (ventaScanning) { stopScannerVentas(); return; }
      if (!('BarcodeDetector' in window)) {
        alert('Tu navegador no soporta escaneo nativo. TambiÃ©n puedes usar lector USB.');
        return;
      }
      const video = $('preview');
      video.classList.remove('hidden');
      ventaStream = await navigator.mediaDevices.getUserMedia({
        video:{ facingMode:{ ideal:'environment' } }, audio:false
      });
      video.srcObject = ventaStream;
      ventaDetector = new window.BarcodeDetector({ formats:['ean_13','ean_8','upc_a','code_128'] });
      ventaScanning = true;
      scanVentasLoop(video);
    });

    function stopScannerVentas(){
      ventaScanning=false;
      if (ventaStream) { ventaStream.getTracks().forEach(t=>t.stop()); ventaStream=null; }
      $('preview').classList.add('hidden');
    }
    async function scanVentasLoop(video){
      while (ventaScanning && ventaDetector) {
        try {
          if (!video.videoWidth) { await new Promise(r=>setTimeout(r,150)); continue; }
          const canvas=document.createElement('canvas');
          canvas.width=video.videoWidth;
          canvas.height=video.videoHeight;
          canvas.getContext('2d').drawImage(video,0,0,canvas.width,canvas.height);
          const bmp=await createImageBitmap(canvas);
          const codes=await ventaDetector.detect(bmp);
          if (codes && codes.length) {
            const code=String(codes[0].rawValue || '');
            if (code) {
              stopScannerVentas();
              await buscarYAgregarPorCodigo(code);
              break;
            }
          }
        } catch(e){ console.error(e); }
        await new Promise(r=>setTimeout(r,200));
      }
    }

    // Finalizar venta
    $('btnFinalizarVenta').addEventListener('click', async ()=>{
      if (!carrito.length) return alert('Carrito vacÃ­o');
      const total = carrito.reduce((s,c)=> s + c.cantidad * c.precio, 0);
      const efectivo = parseFloat($('efectivoRecibido').value || '0');
      if (efectivo < total) {
        if (!confirm('El efectivo es menor al total. Â¿Registrar de todos modos?')) return;
      }
      const cambio = Math.max(efectivo - total, 0);

      const carritoCopia = carrito.map(c=>({...c}));

      try {
        const { data:venta, error:errV } = await supabase
          .from('ventas')
          .insert({})
          .select('id,fecha')
          .single();
        if (errV) throw errV;

        // items de venta + inventario (salida)
        for (const c of carritoCopia) {
          const precioUnit = Number(c.precio ?? productosCache.get(c.id)?.precio ?? 0);

          const { error:itemErr } = await supabase.from('ventas_items').insert({
            venta_id:venta.id,
            producto_id:c.id,
            cantidad:c.cantidad,
            precio_unitario:precioUnit   // subtotal lo calcula la BD
          });
          if (itemErr) throw itemErr;

          await supabase.from('inventario_movimientos').insert({
            producto_id:c.id,
            tipo:'salida',
            cantidad:c.cantidad,
            motivo:`Venta #${venta.id}`
          });
        }

        // caja: entrada por total, salida por cambio
        const movimientosCaja = [];
        if (total > 0) movimientosCaja.push({ tipo:'entrada', monto:total });
        if (cambio > 0) movimientosCaja.push({ tipo:'salida', monto:cambio });
        if (movimientosCaja.length) {
          const { error:cajaErr } = await supabase.from('caja_movimientos').insert(movimientosCaja);
          if (cajaErr) console.error('Error registrando caja:', cajaErr);
        }

        alert('âœ… Venta registrada (#'+venta.id+')');

        // actualizar vistas
        carrito=[];
        $('efectivoRecibido').value='';
        renderCarrito();
        await Promise.all([cargarProductosVenta(), cargarProductos(), cargarHistorial()]);

        // Ticket
        if (confirm('Â¿Deseas ticket de esta venta?')) {
          const ticketTexto = generarTicketTexto(venta.id, venta.fecha, carritoCopia, total, efectivo, cambio);
          mostrarTicket('T-'+String(venta.id).padStart(6,'0'), ticketTexto);
        }

      } catch(e){
        alert('Error registrando venta: '+e.message);
      }
    });

    /*************** TICKET ***************/
    function mostrarTicket(folio, texto){
      $('ticketFolio').textContent = folio;
      $('ticketContenido').textContent = texto;
      $('ticketModal').classList.remove('hidden');
    }
    $('btnCerrarTicket').addEventListener('click', ()=>{
      $('ticketModal').classList.add('hidden');
    });

    function generarTicketTexto(idVenta, fechaISO, items, total, efectivo, cambio){
      const tiendaNombre = 'Tiendita La Esquina Feliz';
      const rfc          = 'TEF010101ABC';
      const direccion    = 'Av. Principal 123, Col. Centro, CDMX';
      const fecha = fechaISO ? new Date(fechaISO) : new Date();

      const rol = currentProfile?.rol?.nombre === 'admin' ? 'ADMINISTRADOR' : 'CAJERO';
      const cajero = rol; // ya no mostramos correo

      let lineas = [];
      lineas.push(tiendaNombre);
      lineas.push('RFC: '+rfc);
      lineas.push(direccion);
      lineas.push('--------------------------------');
      lineas.push('Folio: T-'+String(idVenta).padStart(6,'0'));
      lineas.push('Fecha: '+fecha.toLocaleString());
      lineas.push('AtendiÃ³: '+cajero);
      lineas.push('--------------------------------');
      items.forEach(it=>{
        const subtotal = it.cantidad * it.precio;
        lineas.push(`${it.nombre}`);
        lineas.push(` ${it.cantidad} x $${peso(it.precio)} = $${peso(subtotal)}`);
      });
      lineas.push('--------------------------------');
      lineas.push(`TOTAL:   $${peso(total)}`);
      lineas.push(`EFECTIVO:$${peso(efectivo)}`);
      lineas.push(`CAMBIO:  $${peso(cambio)}`);
      lineas.push('--------------------------------');
      lineas.push('Gracias por su compra');
      lineas.push('Â¡Vuelva pronto!');
      return lineas.join('\n');
    }

    /*************** INVENTARIO ***************/
    async function cargarInventario(){
      const { data, error } = await supabase
        .from('inventario_movimientos')
        .select('producto_id,tipo,cantidad,fecha,motivo')
        .order('fecha',{ ascending:false });
      if (error) { console.error(error); return; }
      $('tablaInventario').innerHTML = (data || []).map(m=>`
        <tr>
          <td>${m.producto_id}</td>
          <td>${m.tipo || ''}</td>
          <td>${m.cantidad}</td>
          <td>${m.fecha ? new Date(m.fecha).toLocaleString() : ''}</td>
          <td>${m.motivo || ''}</td>
        </tr>
      `).join('');
    }

    $('formEntrada').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const producto_id = parseInt($('invProducto').value,10);
      const cantidad = parseInt($('invCantidad').value,10);
      if (!producto_id || !cantidad) { alert('Completa producto y cantidad'); return; }
      try {
        const { error } = await supabase.from('inventario_movimientos').insert({
          producto_id,
          tipo:'entrada',
          cantidad,
          motivo:'Entrada manual'
        });
        if (error) throw error;
        e.target.reset();
        await Promise.all([cargarInventario(), cargarProductos()]);
      } catch(err){
        alert('Error registrando inventario: '+err.message);
      }
    });

    /*************** HISTORIAL ***************/
    async function cargarHistorial(){
      const { data:ventas, error } = await supabase
        .from('ventas')
        .select('id,fecha')
        .order('id',{ ascending:false })
        .limit(50);
      if (error) { console.error(error); return; }
      if (!ventas || !ventas.length) {
        $('tablaHistorial').innerHTML = '';
        return;
      }
      const ids = ventas.map(v=>v.id);
      const { data:items, error:errItems } = await supabase
        .from('ventas_items')
        .select('venta_id,cantidad,precio_unitario,productos(nombre)')
        .in('venta_id', ids);
      if (errItems) { console.error(errItems); return; }

      const porVenta = new Map();
      for (const it of (items || [])) {
        const arr = porVenta.get(it.venta_id) || [];
        arr.push(it);
        porVenta.set(it.venta_id, arr);
      }

      $('tablaHistorial').innerHTML = ventas.map(v=>{
        const its = porVenta.get(v.id) || [];
        const total = its.reduce((s,i)=> s + i.cantidad * i.precio_unitario, 0);
        const detalle = its.map(i=>`${i.productos?.nombre || 'Prod.'} x${i.cantidad}`).join(', ');
        return `
          <tr>
            <td>${v.id}</td>
            <td>${v.fecha ? new Date(v.fecha).toLocaleString() : ''}</td>
            <td>$${peso(total)}</td>
            <td style="text-align:left">${detalle}</td>
          </tr>`;
      }).join('');
    }

    /*************** REPORTE DIARIO ***************/
    $('btnCargarReporte').addEventListener('click', cargarReporteHoy);
    $('btnSimularCierre').addEventListener('click', cargarReporteHoy);

    async function cargarReporteHoy(){
      try {
        const hoy = new Date();
        const inicio = new Date(hoy); inicio.setHours(0,0,0,0);
        const fin    = new Date(hoy); fin.setHours(23,59,59,999);

        const { data:ventas, error:errV } = await supabase
          .from('ventas')
          .select('id,fecha')
          .gte('fecha', inicio.toISOString())
          .lte('fecha', fin.toISOString())
          .order('fecha',{ ascending:true });

        if (errV) throw errV;

        let totalVentas = 0;
        let totalTickets = ventas.length;
        let totalArticulos = 0;

        if (ventas.length) {
          const ids = ventas.map(v=>v.id);
          const { data:items, error:errI } = await supabase
            .from('ventas_items')
            .select('venta_id,cantidad,precio_unitario')
            .in('venta_id', ids);
          if (errI) throw errI;
          for (const it of (items || [])) {
            totalVentas    += it.cantidad * it.precio_unitario;
            totalArticulos += it.cantidad;
          }
        }

        const { data:caja, error:errC } = await supabase
          .from('caja_movimientos')
          .select('tipo,monto,fecha')
          .gte('fecha', inicio.toISOString())
          .lte('fecha', fin.toISOString());

        if (errC) throw errC;

        let entradas = 0, salidas = 0;
        for (const m of (caja || [])) {
          if (m.tipo === 'entrada') entradas += Number(m.monto || 0);
          else if (m.tipo === 'salida') salidas += Number(m.monto || 0);
        }

        const netoCaja = entradas - salidas;

        const lineas = [];
        lineas.push('CORTE DEL DÃA');
        lineas.push('Fecha: '+hoy.toLocaleDateString());
        lineas.push('--------------------------------');
        lineas.push('Tickets emitidos: '+totalTickets);
        lineas.push('ArtÃ­culos vendidos: '+totalArticulos);
        lineas.push('Venta total: $'+peso(totalVentas));
        lineas.push('--------------------------------');
        lineas.push('Caja - Entradas: $'+peso(entradas));
        lineas.push('Caja - Salidas : $'+peso(salidas));
        lineas.push('Saldo esperado : $'+peso(netoCaja));
        lineas.push('--------------------------------');
        lineas.push('Detalle de ventas:');
        ventas.forEach(v=>{
          lineas.push('  Venta #'+v.id+' - '+new Date(v.fecha).toLocaleTimeString());
        });

        $('reporteContenido').textContent = lineas.join('\n');
      } catch(e){
        $('reporteContenido').textContent = 'Error cargando reporte: '+e.message;
      }
    }
  </script>
</body>
</html>
