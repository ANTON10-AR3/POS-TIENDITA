<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>POS Tiendita</title>
  <style>
    :root { --green:#4caf50; --greenD:#2e7d32; --blue:#1e88e5; --red:#c62828; --bg:#f5f7fb }
    * { box-sizing:border-box }
    body{
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:linear-gradient(135deg,var(--green),var(--greenD));
      min-height:100vh;margin:0;display:flex;align-items:center;justify-content:center;padding:24px;
    }
    .card{
      width:100%;max-width:980px;background:#fff;border-radius:16px;padding:24px;
      box-shadow:0 20px 48px rgba(0,0,0,.25);animation:fade .35s ease;
    }
    h2{margin:0 0 10px;text-align:center}
    h3{margin:16px 0 12px}
    input,select,button{font-size:15px}
    input,select{
      width:100%;padding:12px;margin:6px 0;border:1px solid #e1e4ea;border-radius:10px;background:#fff;
    }
    button{
      padding:12px 14px;border:0;border-radius:10px;font-weight:700;cursor:pointer;background:var(--green);color:#fff;
    }
    button.secondary{background:var(--blue)}
    button.destructive{background:var(--red)}
    button.ghost{background:#e9eef8;color:#1a2a42}
    button:hover{filter:brightness(.95)}
    .menu{display:flex;flex-wrap:wrap;gap:10px;margin:12px 0 0}
    .menu button{background:var(--blue)}
    .grid{display:grid;gap:12px}
    .col2{grid-template-columns:1fr 1fr}
    .col3{grid-template-columns:1fr 1fr 1fr}
    table{width:100%;border-collapse:collapse;margin-top:10px;background:#fff}
    th,td{border:1px solid #eef1f6;padding:8px;text-align:center}
    th{background:#f7f9fe}
    .muted{color:#5f6b7a;font-size:13px}
    .hidden{display:none}
    #resultado{min-height:22px;margin-top:8px}
    .ok{color:var(--greenD);font-weight:700}
    .warn{color:var(--red);font-weight:700}
    .low{background:#fff1f1}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;background:#ecf3ff;color:#0c3a94}
    .scan-flash{animation:flash .25s ease-in-out}
    @keyframes flash{from{background:#fff59d}to{background:transparent}}
    @keyframes fade{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:none}}
    .section{background:var(--bg);border-radius:12px;padding:12px}
    video{width:100%;max-height:240px;border-radius:10px;background:#000}
    pre.json{
      background:#0b1020;color:#c4d0ff;padding:12px;border-radius:10px;overflow:auto;white-space:pre-wrap;
    }

    /* Modal ticket */
    .modal-backdrop{
      position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;z-index:50;
    }
    .modal{
      background:#fff;border-radius:16px;max-width:420px;width:100%;padding:20px;box-shadow:0 18px 40px rgba(0,0,0,.35);
    }
    .ticket-box{
      font-family:monospace;font-size:13px;border:1px dashed #999;border-radius:8px;padding:10px;line-height:1.35;
    }
  </style>
</head>
<body>
  <div class="card">
    <h2>POS Tiendita</h2>

    <!-- LOGIN -->
    <div id="loginBox">
      <div class="grid">
        <input id="email" type="email" placeholder="Correo" autocomplete="username" />
        <input id="password" type="password" placeholder="Contrase√±a" autocomplete="current-password" />
        <button id="btnLogin">Iniciar sesi√≥n</button>
      </div>
      <div id="resultado" class="muted">Listo para iniciar sesi√≥n‚Ä¶</div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" class="hidden">
      <div class="grid col2">
        <div>
          <div id="userTitle" class="pill">üë§ ‚Äî</div>
          <div id="userRole" class="muted">Rol: ‚Äî</div>
        </div>
        <div style="text-align:right">
          <button id="btnLogout" class="destructive">Cerrar sesi√≥n</button>
        </div>
      </div>

      <div class="menu" id="menuOpciones"></div>

      <div id="vistas" style="margin-top:16px">
        <!-- PRODUCTOS -->
        <div id="vistaProductos" class="hidden section">
          <h3>üì¶ Gesti√≥n de Productos</h3>
          <form id="formProducto" class="grid col3">
            <input id="prodNombre" type="text" placeholder="Nombre" required />
            <input id="prodPrecio" type="number" step="0.01" placeholder="Precio" required />
            <input id="prodStock" type="number" placeholder="Stock inicial" required />
            <div class="grid col3" style="grid-column:1 / -1;gap:8px;">
              <input id="prodCodigo" type="text" placeholder="C√≥digo de barras (opcional)" />
              <button type="button" id="btnScanProducto" class="ghost">üì∑ Escanear</button>
              <button type="submit" class="secondary">Guardar</button>
            </div>
          </form>
          <video id="previewProd" autoplay muted playsinline class="hidden"></video>

          <div style="margin-top:10px" class="grid col2">
            <div>
              <input id="csvFile" type="file" accept=".csv" />
              <button id="btnImport" class="ghost">Importar CSV</button>
              <div class="muted">Formato: <code>nombre,precio,stock,codigo_barras</code></div>
            </div>
            <div style="text-align:right">
              <span class="pill">üîî Alerta: stock &lt; stock_minimo</span>
            </div>
          </div>

          <table>
            <thead>
              <tr><th>ID</th><th>Nombre</th><th>Precio</th><th>Stock</th><th>M√≠n.</th><th>C√≥digo</th></tr>
            </thead>
            <tbody id="tablaProductos"></tbody>
          </table>
        </div>

        <!-- INVENTARIO -->
        <div id="vistaInventario" class="hidden section">
          <h3>üìä Movimientos de Inventario</h3>
          <form id="formEntrada" class="grid col3">
            <input id="invProducto" type="number" placeholder="ID producto" required />
            <input id="invCantidad" type="number" placeholder="Cantidad" required />
            <button type="submit" class="secondary">Registrar Entrada</button>
          </form>
          <table>
            <thead>
              <tr><th>Producto</th><th>Tipo</th><th>Cantidad</th><th>Fecha</th><th>Motivo</th></tr>
            </thead>
            <tbody id="tablaInventario"></tbody>
          </table>
        </div>

        <!-- REPORTES -->
        <div id="vistaReportes" class="hidden section">
          <h3>üßæ Corte y Reporte Diario</h3>
          <div class="grid col2">
            <button id="btnCargarReporte" class="secondary">Actualizar reporte de hoy</button>
            <button id="btnSimularCierre" class="ghost">Simular cierre de d√≠a</button>
          </div>
          <pre id="reporteContenido" class="json" style="margin-top:10px"></pre>
        </div>

        <!-- VENTAS -->
        <div id="vistaVentas" class="hidden section">
          <h3>üõí Registrar Venta</h3>

          <div class="grid col3">
            <input id="codigoBarras" type="text" placeholder="C√≥digo de barras" />
            <button id="btnBuscarCodigo" class="ghost">Buscar</button>
            <button id="btnStartScanner" class="ghost">üì∑ Escanear</button>
          </div>
          <video id="preview" autoplay muted playsinline class="hidden" style="margin-top:8px"></video>

          <form id="formVenta" class="grid col3" style="margin-top:10px">
            <select id="ventaProducto"></select>
            <input id="ventaCantidad" type="number" placeholder="Cantidad" required />
            <button type="submit" class="secondary">Agregar al Carrito</button>
          </form>

          <h4 style="margin:12px 0 6px">Carrito</h4>
          <table>
            <thead>
              <tr><th>Producto</th><th>Cant</th><th>Precio</th><th>Subtotal</th></tr>
            </thead>
            <tbody id="tablaCarrito"></tbody>
          </table>

          <div class="grid col3" style="align-items:center;margin-top:12px">
            <div class="muted">Total venta: $<span id="totalVenta">0.00</span></div>
            <input id="efectivoRecibido" type="number" step="0.01" placeholder="Efectivo recibido" />
            <div class="muted">Cambio: $<span id="cambioMostrar">0.00</span></div>
          </div>

          <div style="text-align:right;margin-top:10px">
            <button id="btnFinalizarVenta">Finalizar Venta</button>
          </div>
        </div>

        <!-- CAJA -->
        <div id="vistaCaja" class="hidden section">
          <h3>üíµ Movimientos de Caja</h3>
          <table>
            <thead>
              <tr><th>Tipo</th><th>Monto</th><th>Fecha</th></tr>
            </thead>
            <tbody id="tablaCaja"></tbody>
          </table>
        </div>

        <!-- HISTORIAL -->
        <div id="vistaHistorial" class="hidden section">
          <h3>üßæ Historial de Ventas</h3>
          <table>
            <thead>
              <tr><th>ID</th><th>Fecha</th><th>Detalle</th><th>Total</th></tr>
            </thead>
            <tbody id="tablaHistorial"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL TICKET -->
  <div id="ticketModal" class="hidden modal-backdrop">
    <div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <strong>Ticket de venta</strong>
        <span id="ticketFolio" class="muted" style="font-size:12px"></span>
      </div>
      <div id="ticketContenido" class="ticket-box"></div>
      <div style="text-align:right;margin-top:10px">
        <button id="btnCerrarTicket" class="secondary">Cerrar</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const SUPABASE_URL = 'https://gnguvdqdhqrupkkrtdmp.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImduZ3V2ZHFkaHFydXBra3J0ZG1wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3NjEwNTIsImV4cCI6MjA3NTMzNzA1Mn0.a5XbjmM5eyREKI1j0HrZe36Gz52SAz0_3_jzjW8bYo0';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const TIENDA = {
      nombre: 'Mini S√∫per La Esquinita',
      direccion: 'Av. Universidad 123, Ciudad de M√©xico, C.P. 01234',
      rfc: 'MES910101ABC'
    };

    let carrito = [];
    let productosCache = new Map();
    let currentUser = null;
    let currentUserName = '';

    const $ = (id)=>document.getElementById(id);
    const peso = (n)=>Number(n ?? 0).toFixed(2);
    const scannerBeep = ()=> {
      try {
        new Audio('https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg').play();
      } catch {}
    };

    // ==================== LOGIN ====================
    $('btnLogin').addEventListener('click', async ()=>{
      const email = $('email').value.trim();
      const password = $('password').value.trim();
      const out = $('resultado');
      if (!email || !password){
        out.innerHTML = '<span class="warn">Ingresa correo y contrase√±a</span>';
        return;
      }
      out.textContent = 'Iniciando‚Ä¶';
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if (error){
        out.innerHTML = '<span class="warn">'+error.message+'</span>';
        return;
      }
      currentUser = data.user;
      out.innerHTML = '<span class="ok">Login OK</span>';
      await cargarPerfil(data.user.id);
    });

    $('btnLogout').addEventListener('click', async ()=>{
      await supabase.auth.signOut();
      currentUser = null;
      $('dashboard').classList.add('hidden');
      $('loginBox').classList.remove('hidden');
      $('resultado').textContent = 'üëã Sesi√≥n cerrada.';
    });

    async function cargarPerfil(uid){
      const { data, error } = await supabase
        .from('profiles')
        .select('nombre, rol_id, rol:rol_id(nombre)')
        .eq('user_id', uid)
        .single();

      if (error || !data){
        $('resultado').innerHTML = '<span class="warn">No se encontr√≥ perfil en tabla profiles</span>';
        return;
      }

      currentUserName = data.nombre || 'Cajero';

      $('loginBox').classList.add('hidden');
      $('dashboard').classList.remove('hidden');
      $('userTitle').textContent = 'üë§ '+data.nombre;
      $('userRole').textContent = 'Rol: '+(data.rol?.nombre ?? '‚Äî');

      const menu = $('menuOpciones');
      menu.innerHTML = '';
      if (data.rol?.nombre === 'admin'){
        menu.innerHTML += '<button class="secondary" data-v="vistaVentas">üõí Ventas</button>';
        menu.innerHTML += '<button class="secondary" data-v="vistaCaja">üíµ Caja</button>';
        menu.innerHTML += '<button class="secondary" data-v="vistaHistorial">üßæ Historial</button>';
        menu.innerHTML += '<button class="secondary" data-v="vistaProductos">üì¶ Productos</button>';
        menu.innerHTML += '<button class="secondary" data-v="vistaInventario">üìä Inventario</button>';
        menu.innerHTML += '<button class="secondary" data-v="vistaReportes">üìë Reportes</button>';
      } else {
        menu.innerHTML += '<button class="secondary" data-v="vistaVentas">üõí Ventas</button>';
        menu.innerHTML += '<button class="secondary" data-v="vistaCaja">üíµ Caja</button>';
        menu.innerHTML += '<button class="secondary" data-v="vistaHistorial">üßæ Historial</button>';
      }
      menu.querySelectorAll('button').forEach(b=>b.addEventListener('click', ()=>abrirVista(b.dataset.v)));
      abrirVista('vistaVentas');
    }

    function abrirVista(id){
      document.querySelectorAll('#vistas > div').forEach(d=>d.classList.add('hidden'));
      const el = $(id);
      if (!el) return;
      el.classList.remove('hidden');
      if (id === 'vistaProductos')  cargarProductos();
      if (id === 'vistaInventario') cargarInventario();
      if (id === 'vistaVentas')     cargarProductosVenta();
      if (id === 'vistaCaja')       cargarCaja();
      if (id === 'vistaHistorial')  cargarHistorial();
      if (id === 'vistaReportes')   cargarReporteHoy();
    }

    // ==================== PRODUCTOS ====================
    async function cargarProductos(){
      const { data, error } = await supabase
        .from('productos')
        .select('*')
        .order('id');
      if (error){ console.error(error); return; }
      productosCache.clear();
      $('tablaProductos').innerHTML = (data || []).map(p=>{
        productosCache.set(p.id, p);
        const low = p.stock < (p.stock_minimo ?? 5) ? 'low' : '';
        return '<tr class="'+low+'">'+
          '<td>'+p.id+'</td>'+
          '<td>'+p.nombre+'</td>'+
          '<td>$'+peso(p.precio)+'</td>'+
          '<td>'+p.stock+'</td>'+
          '<td>'+(p.stock_minimo ?? '-')+'</td>'+
          '<td>'+(p.codigo_barras || '')+'</td>'+
        '</tr>';
      }).join('');
    }

    $('formProducto').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const nombre = $('prodNombre').value.trim();
      const precio = parseFloat($('prodPrecio').value);
      const stock  = parseInt($('prodStock').value || '0',10);
      const codigo = $('prodCodigo').value.trim() || null;
      if (!nombre || isNaN(precio)){
        alert('Completa nombre y precio');
        return;
      }
      try{
        if (codigo){
          const { error } = await supabase.rpc('upsert_producto_por_codigo',{
            p_nombre:nombre,
            p_precio:precio,
            p_codigo:codigo,
            p_stock_inicial:stock
          });
          if (error) throw error;
        } else {
          const { error } = await supabase
            .from('productos')
            .insert({ nombre, precio, stock });
          if (error) throw error;
        }
        e.target.reset();
        await cargarProductos();
        alert('‚úÖ Producto guardado');
      }catch(err){
        alert('Error guardando producto: '+err.message);
      }
    });

    $('btnImport').addEventListener('click', ()=>{
      const f = $('csvFile').files?.[0];
      if (!f){ alert('Selecciona un archivo CSV'); return; }
      const r = new FileReader();
      r.onload = async ()=>{
        const rows = String(r.result).split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
        for (const line of rows){
          const [nombre,precio,stock,codigo] = line.split(',').map(x=>x?.trim());
          if (!nombre || !precio) continue;
          try{
            if (codigo){
              await supabase.rpc('upsert_producto_por_codigo',{
                p_nombre:nombre,
                p_precio:parseFloat(precio),
                p_codigo:codigo,
                p_stock_inicial:parseInt(stock || '0',10)
              });
            } else {
              await supabase.from('productos').insert({
                nombre,
                precio:parseFloat(precio),
                stock:parseInt(stock || '0',10)
              });
            }
          }catch(e){ console.error(e); }
        }
        await cargarProductos();
        alert('‚úÖ Importaci√≥n terminada');
      };
      r.readAsText(f);
    });

    // esc√°ner alta producto
    let prodStream=null, prodDetector=null, prodScanning=false;

    $('btnScanProducto').addEventListener('click', async ()=>{
      if (prodScanning){ stopScanProd(); return; }
      if (!('BarcodeDetector' in window)){
        alert('Tu navegador no soporta escaneo nativo');
        return;
      }
      const video = $('previewProd');
      video.classList.remove('hidden');
      prodStream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ ideal:'environment' } }, audio:false });
      video.srcObject = prodStream;
      prodDetector = new window.BarcodeDetector({ formats:['ean_13','ean_8','upc_a','code_128'] });
      prodScanning = true;
      scanProdLoop(video);
    });

    function stopScanProd(){
      prodScanning = false;
      if (prodStream){ prodStream.getTracks().forEach(t=>t.stop()); prodStream=null; }
      $('previewProd').classList.add('hidden');
    }

    async function scanProdLoop(video){
      while (prodScanning && prodDetector){
        try{
          if (!video.videoWidth){ await new Promise(r=>setTimeout(r,150)); continue; }
          const canvas = document.createElement('canvas');
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          canvas.getContext('2d').drawImage(video,0,0,canvas.width,canvas.height);
          const bmp = await createImageBitmap(canvas);
          const codes = await prodDetector.detect(bmp);
          if (codes && codes.length){
            const code = String(codes[0].rawValue || '');
            if (code){
              $('prodCodigo').value = code;
              scannerBeep();
              stopScanProd();
              break;
            }
          }
        }catch(e){ console.error(e); }
        await new Promise(r=>setTimeout(r,200));
      }
    }

    // ==================== VENTAS ====================
    async function cargarProductosVenta(){
      const { data, error } = await supabase
        .from('productos')
        .select('id,nombre,precio,stock,codigo_barras')
        .order('nombre');
      if (error){ console.error(error); return; }
      const sel = $('ventaProducto');
      sel.innerHTML = '';
      productosCache.clear();
      (data || []).forEach(p=>{
        productosCache.set(p.id, p);
        sel.innerHTML += '<option value="'+p.id+'">'+p.nombre+' ($'+peso(p.precio)+') ‚Äî '+p.stock+' en stock</option>';
      });
      carrito = [];
      renderCarrito();
    }

    $('btnBuscarCodigo').addEventListener('click', async ()=>{
      const code = $('codigoBarras').value.trim();
      if (!code) return;
      await buscarYAgregarPorCodigo(code, 1);
      $('codigoBarras').value = '';
    });

    async function buscarYAgregarPorCodigo(code, cantidad){
      let found = null;
      try{
        const rpc = await supabase.rpc('buscar_producto_por_codigo',{ p_codigo:code });
        if (!rpc.error && rpc.data && rpc.data.length) found = rpc.data[0];
      }catch(e){ console.error(e); }
      if (!found){
        const { data } = await supabase
          .from('productos')
          .select('id,nombre,precio,stock,codigo_barras')
          .eq('codigo_barras', code)
          .maybeSingle();
        if (data) found = data;
      }
      if (!found){
        alert('No se encontr√≥ un producto para ese c√≥digo');
        return;
      }
      addToCartFromProduct(found, cantidad || 1);
      const lastRow = $('tablaCarrito').lastElementChild;
      if (lastRow) lastRow.classList.add('scan-flash');
      scannerBeep();
    }

    $('formVenta').addEventListener('submit', (e)=>{
      e.preventDefault();
      const id = parseInt($('ventaProducto').value,10);
      const cant = parseInt($('ventaCantidad').value,10);
      const p = productosCache.get(id);
      if (!p){
        alert('Producto inexistente');
        return;
      }
      addToCartFromProduct(p, cant);
      e.target.reset();
    });

    function addToCartFromProduct(p, cantidad){
      if (!p || !cantidad || cantidad <= 0) return;
      const ya = carrito.find(x=>x.id === p.id);
      const enCarrito = ya ? ya.cantidad : 0;
      if (p.stock != null && (cantidad + enCarrito) > p.stock){
        alert('Solo hay '+p.stock+' unidades de "'+p.nombre+'" en stock');
        return;
      }
      if (ya) ya.cantidad += cantidad;
      else carrito.push({ id:p.id, nombre:p.nombre, cantidad, precio:Number(p.precio ?? 0) });
      renderCarrito();
    }

    function renderCarrito(){
      $('tablaCarrito').innerHTML = carrito.map(c=>
        '<tr>'+
          '<td>'+c.nombre+'</td>'+
          '<td>'+c.cantidad+'</td>'+
          '<td>$'+peso(c.precio)+'</td>'+
          '<td>$'+peso(c.cantidad * c.precio)+'</td>'+
        '</tr>'
      ).join('');
      const total = carrito.reduce((s,c)=>s + c.cantidad * c.precio,0);
      $('totalVenta').textContent = peso(total);
      actualizarCambio();
    }

    $('efectivoRecibido').addEventListener('input', actualizarCambio);
    function actualizarCambio(){
      const total = parseFloat($('totalVenta').textContent || '0');
      const efectivo = parseFloat($('efectivoRecibido').value || '0');
      const cambio = Math.max(0, efectivo - total);
      $('cambioMostrar').textContent = peso(cambio);
    }

    // esc√°ner ventas
    let ventaStream=null, ventaDetector=null, ventaScanning=false;

    $('btnStartScanner').addEventListener('click', async ()=>{
      if (ventaScanning){ stopScannerVentas(); return; }
      if (!('BarcodeDetector' in window)){
        alert('Tu navegador no soporta escaneo nativo');
        return;
      }
      const video = $('preview');
      video.classList.remove('hidden');
      ventaStream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ ideal:'environment' } }, audio:false });
      video.srcObject = ventaStream;
      ventaDetector = new window.BarcodeDetector({ formats:['ean_13','ean_8','upc_a','code_128'] });
      ventaScanning = true;
      scanVentasLoop(video);
    });

    function stopScannerVentas(){
      ventaScanning = false;
      if (ventaStream){ ventaStream.getTracks().forEach(t=>t.stop()); ventaStream=null; }
      $('preview').classList.add('hidden');
    }

    async function scanVentasLoop(video){
      while (ventaScanning && ventaDetector){
        try{
          if (!video.videoWidth){ await new Promise(r=>setTimeout(r,150)); continue; }
          const canvas = document.createElement('canvas');
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          canvas.getContext('2d').drawImage(video,0,0,canvas.width,canvas.height);
          const bmp = await createImageBitmap(canvas);
          const codes = await ventaDetector.detect(bmp);
          if (codes && codes.length){
            const code = String(codes[0].rawValue || '');
            if (code){
              stopScannerVentas();
              await buscarYAgregarPorCodigo(code,1);
              break;
            }
          }
        }catch(e){ console.error(e); }
        await new Promise(r=>setTimeout(r,200));
      }
    }

    // finalizar venta
    $('btnFinalizarVenta').addEventListener('click', async ()=>{
      if (!carrito.length){
        alert('Carrito vac√≠o');
        return;
      }
      const total = carrito.reduce((s,c)=>s + c.cantidad * c.precio,0);
      const efectivo = parseFloat($('efectivoRecibido').value || '0');
      if (efectivo < total){
        alert('El efectivo recibido es menor al total de la venta');
        return;
      }
      const cambio = efectivo - total;

      const carritoCopia = carrito.map(c=>({ ...c }));
      try{
        const { data:venta, error:errV } = await supabase
          .from('ventas')
          .insert({})
          .select('id,fecha')
          .single();
        if (errV) throw errV;

        // items de venta
        for (const c of carritoCopia){
          const precioUnit = Number(c.precio ?? productosCache.get(c.id)?.precio ?? 0);
          const { error } = await supabase.from('ventas_items').insert({
            venta_id:venta.id,
            producto_id:c.id,
            cantidad:c.cantidad,
            precio_unitario:precioUnit
            // NO mandamos subtotal: lo calcula la BD si lo tienes generado
          });
          if (error) throw error;

          // movimiento inventario: salida
          await supabase.from('inventario_movimientos').insert({
            producto_id:c.id,
            tipo:'salida',
            cantidad:c.cantidad,
            motivo:'Venta #'+venta.id
          });
        }

        // movimientos de caja autom√°ticos
        await supabase.from('caja_movimientos').insert([
          { tipo:'ingreso', monto:efectivo },
          { tipo:'egreso',  monto:cambio }
        ]);

        alert('‚úÖ Venta registrada (#'+venta.id+')');

        // mostrar ticket si quiere
        if (confirm('¬øImprimir ticket de esta venta?')){
          mostrarTicketModal(venta, carritoCopia, total, efectivo, cambio);
        }

        carrito = [];
        $('efectivoRecibido').value = '';
        $('cambioMostrar').textContent = '0.00';
        renderCarrito();
        await Promise.all([cargarProductosVenta(), cargarProductos(), cargarCaja(), cargarHistorial(), cargarInventario()]);
      }catch(e){
        alert('Error registrando venta: '+e.message);
      }
    });

    // ==================== TICKET MODAL ====================
    $('btnCerrarTicket').addEventListener('click', ()=>{
      $('ticketModal').classList.add('hidden');
    });

    function padFolio(n){
      return String(n).padStart(6,'0');
    }

    function mostrarTicketModal(venta, items, total, efectivo, cambio){
      $('ticketModal').classList.remove('hidden');
      $('ticketFolio').textContent = 'Folio '+padFolio(venta.id);
      const fecha = new Date(venta.fecha || Date.now());
      let lines = '';
      lines += TIENDA.nombre+'\n';
      lines += 'RFC: '+TIENDA.rfc+'\n';
      lines += TIENDA.direccion+'\n';
      lines += '--------------------------------\n';
      lines += 'Folio: '+padFolio(venta.id)+'\n';
      lines += 'Fecha: '+fecha.toLocaleString()+'\n';
      lines += 'Cajero: '+currentUserName+'\n';
      lines += '--------------------------------\n';
      items.forEach(c=>{
        const sub = c.cantidad * c.precio;
        lines += c.nombre+'\n';
        lines += '  '+c.cantidad+' x $'+peso(c.precio)+'   $'+peso(sub)+'\n';
      });
      lines += '--------------------------------\n';
      lines += 'TOTAL:      $'+peso(total)+'\n';
      lines += 'EFECTIVO:   $'+peso(efectivo)+'\n';
      lines += 'CAMBIO:     $'+peso(cambio)+'\n';
      lines += '--------------------------------\n';
      lines += 'Gracias por su compra\n';
      $('ticketContenido').textContent = lines;
    }

    // ==================== INVENTARIO ====================
    async function cargarInventario(){
      const { data, error } = await supabase
        .from('inventario_movimientos')
        .select('producto_id,tipo,cantidad,fecha,motivo')
        .order('fecha',{ ascending:false });
      if (error){ console.error(error); return; }
      $('tablaInventario').innerHTML = (data || []).map(m=>
        '<tr>'+
          '<td>'+m.producto_id+'</td>'+
          '<td>'+m.tipo+'</td>'+
          '<td>'+m.cantidad+'</td>'+
          '<td>'+(m.fecha ? new Date(m.fecha).toLocaleString() : '')+'</td>'+
          '<td>'+(m.motivo || '')+'</td>'+
        '</tr>'
      ).join('');
    }

    $('formEntrada').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const producto_id = parseInt($('invProducto').value,10);
      const cantidad   = parseInt($('invCantidad').value,10);
      if (!producto_id || !cantidad){
        alert('Completa producto y cantidad');
        return;
      }
      try{
        // registrar movimiento
        const { error } = await supabase.from('inventario_movimientos').insert({
          producto_id,
          tipo:'entrada',
          cantidad,
          motivo:'Entrada manual'
        });
        if (error) throw error;

        // actualizar stock del producto
        await supabase.rpc('ajustar_stock_manual', { p_producto_id:producto_id, p_delta:cantidad })
          .catch(()=>{}); // si no existe RPC, ignoramos

        e.target.reset();
        await Promise.all([cargarInventario(), cargarProductos(), cargarProductosVenta()]);
      }catch(err){
        alert('Error registrando inventario: '+err.message);
      }
    });

    // ==================== CAJA ====================
    async function cargarCaja(){
      const { data, error } = await supabase
        .from('caja_movimientos')
        .select('*')
        .order('fecha',{ ascending:false });
      if (error){ console.error(error); return; }
      $('tablaCaja').innerHTML = (data || []).map(c=>
        '<tr>'+
          '<td>'+c.tipo+'</td>'+
          '<td>$'+peso(c.monto)+'</td>'+
          '<td>'+(c.fecha ? new Date(c.fecha).toLocaleString() : '')+'</td>'+
        '</tr>'
      ).join('');
    }

    // ==================== HISTORIAL ====================
    async function cargarHistorial(){
      const { data:ventas, error } = await supabase
        .from('ventas')
        .select('id,fecha')
        .order('id',{ ascending:false })
        .limit(50);
      if (error){ console.error(error); return; }

      const filas = [];
      for (const v of (ventas || [])){
        const { data:items } = await supabase
          .from('ventas_items')
          .select('cantidad,precio_unitario,productos(nombre)')
          .eq('venta_id', v.id);
        let total = 0;
        let detalle = '';
        (items || []).forEach(i=>{
          const sub = i.cantidad * i.precio_unitario;
          total += sub;
          const nom = i.productos?.nombre || '#'+v.id;
          if (detalle) detalle += ' | ';
          detalle += nom+' x'+i.cantidad;
        });
        filas.push({ id:v.id, fecha:v.fecha, total, detalle });
      }

      $('tablaHistorial').innerHTML = filas.map(f=>
        '<tr>'+
          '<td>'+f.id+'</td>'+
          '<td>'+(f.fecha ? new Date(f.fecha).toLocaleString() : '')+'</td>'+
          '<td>'+f.detalle+'</td>'+
          '<td>$'+peso(f.total)+'</td>'+
        '</tr>'
      ).join('');
    }

    // ==================== REPORTE DIARIO ====================
    $('btnCargarReporte').addEventListener('click', cargarReporteHoy);
    $('btnSimularCierre').addEventListener('click', ()=>alert('Solo visual, no cierra nada.'));

    async function cargarReporteHoy(){
      try{
        const hoy = new Date();
        const inicio = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate());
        const fin = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate()+1);

        const { data:ventas, error } = await supabase
          .from('ventas')
          .select('id,fecha')
          .gte('fecha', inicio.toISOString())
          .lt('fecha', fin.toISOString())
          .order('fecha',{ ascending:true });

        if (error) throw error;

        let totalDia = 0;
        let totalTickets = ventas.length;
        let lineas = [];

        for (const v of (ventas || [])){
          const { data:items } = await supabase
            .from('ventas_items')
            .select('cantidad,precio_unitario')
            .eq('venta_id', v.id);
          let totalVenta = 0;
          (items || []).forEach(i=>{
            totalVenta += i.cantidad * i.precio_unitario;
          });
          totalDia += totalVenta;
          lineas.push('Venta #'+v.id+'  '+new Date(v.fecha).toLocaleTimeString()+'  Total: $'+peso(totalVenta));
        }

        let texto = '';
        texto += 'REPORTE DEL D√çA - '+inicio.toLocaleDateString()+'\n';
        texto += '----------------------------------------\n';
        texto += 'Tickets: '+totalTickets+'\n';
        texto += 'Total vendido: $'+peso(totalDia)+'\n';
        texto += '----------------------------------------\n';
        if (!lineas.length) texto += 'Sin ventas registradas hoy.\n';
        else texto += lineas.join('\n')+'\n';

        $('reporteContenido').textContent = texto;
      }catch(e){
        $('reporteContenido').textContent = 'Error cargando reporte: '+e.message;
      }
    }
  </script>
</body>
</html>
