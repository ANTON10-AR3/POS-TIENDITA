<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>POS Tiendita</title>
  <style>
    :root {
      --green:#4caf50;
      --greenD:#2e7d32;
      --blue:#1e88e5;
      --red:#c62828;
      --bg:#f5f7fb;
      --card:#ffffff;
      --border:#e1e4ea;
      --text:#1a2a42;
      --muted:#5f6b7a;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:linear-gradient(135deg,var(--green),var(--greenD));
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
      color:var(--text);
    }
    .card{
      width:100%;
      max-width:1100px;
      background:var(--card);
      border-radius:18px;
      padding:24px 24px 18px;
      box-shadow:0 20px 48px rgba(0,0,0,.25);
      animation:fade .35s ease;
    }
    h2{margin-bottom:4px;text-align:center}
    h3{margin:12px 0}
    h4{margin:8px 0}
    input,select,button{font-size:15px}
    input,select{
      width:100%;
      padding:10px 12px;
      margin:4px 0;
      border-radius:10px;
      border:1px solid var(--border);
      background:#fff;
    }
    button{
      padding:10px 14px;
      border-radius:10px;
      border:0;
      font-weight:700;
      cursor:pointer;
      background:var(--green);
      color:#fff;
    }
    button.secondary{background:var(--blue)}
    button.destructive{background:var(--red)}
    button.ghost{background:#e9eef8;color:var(--text)}
    button:disabled{opacity:.6;cursor:not-allowed}
    button:hover:not(:disabled){filter:brightness(.96)}
    .grid{display:grid;gap:10px}
    .col2{grid-template-columns:1fr 1fr}
    .col3{grid-template-columns:1fr 1fr 1fr}
    .menu{display:flex;flex-wrap:wrap;gap:8px;margin:14px 0 4px}
    .menu button{background:var(--blue)}
    table{width:100%;border-collapse:collapse;margin-top:8px;background:#fff}
    th,td{border:1px solid #eef1f6;padding:6px 8px;text-align:center;font-size:13px}
    th{background:#f7f9fe}
    .muted{font-size:13px;color:var(--muted)}
    .section{background:var(--bg);border-radius:12px;padding:12px;margin-top:8px}
    .hidden{display:none}
    video{width:100%;max-height:230px;border-radius:10px;background:#000}
    .low{background:#fff1f1}
    #resultado{min-height:20px;margin-top:6px}
    .ok{color:var(--greenD);font-weight:600}
    .warn{color:var(--red);font-weight:600}
    @keyframes fade{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:none}}

    #ticketOverlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.45);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:50;
    }
    #ticketBox{
      background:#fff;
      border-radius:16px;
      width:100%;
      max-width:420px;
      padding:16px 18px 18px;
      box-shadow:0 18px 40px rgba(0,0,0,.35);
    }
    #ticketHeader{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
    }
    #ticketContent{
      font-family:monospace;
      font-size:13px;
      border:1px dashed #ccc;
      border-radius:10px;
      padding:10px;
      max-height:400px;
      overflow:auto;
      background:#fafafa;
      white-space:pre-wrap;
    }
  </style>
</head>
<body>

<div class="card">
  <h2>POS Tiendita</h2>

  <!-- LOGIN -->
  <div id="loginBox">
    <div class="grid">
      <input id="email" type="email" placeholder="Correo" />
      <input id="password" type="password" placeholder="ContraseÃ±a" />
      <button id="btnLogin">Iniciar sesiÃ³n</button>
    </div>
    <div id="resultado" class="muted">Listo para iniciar sesiÃ³nâ€¦</div>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboard" class="hidden">
    <div class="grid col2">
      <div>
        <div id="userTitle" class="pill">ðŸ‘¤ â€”</div>
        <div id="userRole" class="muted">Rol: â€”</div>
      </div>
      <div style="text-align:right">
        <button id="btnLogout" class="destructive">Cerrar sesiÃ³n</button>
      </div>
    </div>

    <div class="menu" id="menuOpciones"></div>

    <div id="vistas" style="margin-top:10px">
        <!-- VISTA VENTAS -->
        <div id="vistaVentas" class="section">
          <h3>ðŸ›’ Registrar venta</h3>

          <div class="grid col3">
            <input id="codigoBarras" type="text" placeholder="CÃ³digo de barras" />
            <button id="btnBuscarCodigo" class="ghost">Buscar / Agregar</button>
            <button id="btnStartScanner" class="ghost">ðŸ“· Escanear</button>
          </div>

          <video id="preview" autoplay muted playsinline class="hidden" style="margin-top:6px"></video>

          <form id="formVenta" class="grid col3" style="margin-top:10px">
            <select id="ventaProducto"></select>
            <input id="ventaCantidad" type="number" min="1" placeholder="Cantidad" required />
            <button type="submit" class="secondary">Agregar al Carrito</button>
          </form>

          <h4 style="margin:10px 0 4px">Carrito</h4>
          <table>
            <thead>
            <tr><th>Producto</th><th>Cant</th><th>Precio</th><th>Subtotal</th></tr>
            </thead>
            <tbody id="tablaCarrito"></tbody>
          </table>

          <div class="grid col3" style="align-items:center;margin-top:10px">
            <div>
              <div class="muted">Total venta:</div>
              <div style="font-weight:800;font-size:18px">$<span id="totalVenta">0.00</span></div>
            </div>
            <div>
              <div class="muted">Efectivo recibido:</div>
              <input id="efectivoRecibido" type="number" min="0" step="0.01" placeholder="0.00" />
              <div class="muted">Cambio: $<span id="cambioCalculado">0.00</span></div>
            </div>
            <div style="text-align:right">
              <button id="btnFinalizarVenta">Finalizar venta</button>
            </div>
          </div>
        </div>


        <!-- VISTA INVENTARIO -->
        <div id="vistaInventario" class="hidden section">
          <h3>ðŸ“Š Movimientos de inventario</h3>
          <p class="muted">Registrar entradas manuales por <strong>cÃ³digo de barras</strong>. Las salidas por venta se generan automÃ¡ticamente.</p>

          <form id="formEntrada" class="grid col3" style="margin-top:8px">
            <input id="invCodigo" type="text" placeholder="CÃ³digo de barras" required />
            <input id="invCantidad" type="number" min="1" placeholder="Cantidad" required />
            <button type="submit" class="secondary">Registrar Entrada</button>
          </form>

          <table>
            <thead>
            <tr><th>Producto</th><th>Tipo</th><th>Cantidad</th><th>Fecha</th><th>Motivo</th></tr>
            </thead>
            <tbody id="tablaInventario"></tbody>
          </table>
        </div>


        <!-- VISTA PRODUCTOS (SOLO ADMIN) -->
        <div id="vistaProductos" class="hidden section">
          <h3>ðŸ“¦ Productos</h3>

          <form id="formProducto" class="grid col3">
            <input id="prodNombre" type="text" placeholder="Nombre" required />
            <input id="prodPrecio" type="number" step="0.01" placeholder="Precio" required />
            <input id="prodStock" type="number" min="0" placeholder="Stock inicial" required />
            <div class="grid col3" style="grid-column:1 / -1;gap:8px">
              <input id="prodCodigo" type="text" placeholder="CÃ³digo de barras" />
              <button type="button" id="btnScanProducto" class="ghost">ðŸ“· Escanear</button>
              <button type="submit" class="secondary">Guardar</button>
            </div>
          </form>

          <video id="previewProd" autoplay muted playsinline class="hidden" style="margin-top:6px"></video>

          <table>
            <thead>
            <tr><th>ID</th><th>Nombre</th><th>Precio</th><th>Stock</th><th>MÃ­n.</th><th>CÃ³digo</th></tr>
            </thead>
            <tbody id="tablaProductos"></tbody>
          </table>
        </div>


        <!-- VISTA CAJA -->
        <div id="vistaCaja" class="hidden section">
          <h3>ðŸ’µ Caja</h3>
          <p class="muted">Los movimientos se generan automÃ¡ticamente con cada venta (entrada = total, salida = cambio).</p>

          <div class="kpi-row">
            <div class="kpi">
              <label>Entradas</label>
              <strong>$<span id="cajaEntradas">0.00</span></strong>
            </div>
            <div class="kpi">
              <label>Salidas (cambios)</label>
              <strong>$<span id="cajaSalidas">0.00</span></strong>
            </div>
            <div class="kpi">
              <label>Saldo</label>
              <strong>$<span id="cajaSaldo">0.00</span></strong>
            </div>
          </div>

          <table style="margin-top:8px">
            <thead>
            <tr><th>Tipo</th><th>Monto</th><th>Motivo</th><th>Fecha</th></tr>
            </thead>
            <tbody id="tablaCaja"></tbody>
          </table>
        </div>


        <!-- VISTA HISTORIAL -->
        <div id="vistaHistorial" class="hidden section">
          <h3>ðŸ§¾ Historial de ventas</h3>
          <table>
            <thead>
            <tr><th>Folio</th><th>Fecha</th><th>ArtÃ­culos</th><th>Total</th></tr>
            </thead>
            <tbody id="tablaHistorial"></tbody>
          </table>
        </div>


        <!-- VISTA REPORTE -->
        <div id="vistaReportes" class="hidden section">
          <h3>ðŸ“ˆ Reporte diario</h3>

          <div class="grid col2">
            <button id="btnCargarReporte" class="secondary">Refrescar reporte</button>
            <button id="btnSimularCierre" class="ghost">Simular cierre del dÃ­a</button>
          </div>

          <div id="reporteResumen" class="kpi-row"></div>
          <pre id="reporteDetalle" class="muted" style="margin-top:8px;background:#0b1020;color:#c4d0ff;border-radius:10px;padding:10px;max-height:260px;overflow:auto;white-space:pre-wrap"></pre>
        </div>

      </div>
    </div>
  </div>


  <!-- MODAL DE TICKET -->
  <div id="ticketOverlay">
    <div id="ticketBox">
      <div id="ticketHeader">
        <div>
          <strong>Ticket de venta</strong>
          <div class="muted" style="font-size:12px">Tiendita Las Palmas Â· RFC TLP010203AB1</div>
          <div class="muted" style="font-size:11px">Av. Siempre Viva 123, CDMX</div>
        </div>
        <div style="text-align:right;font-size:12px">
          <div>Folio <span id="ticketFolio">â€”</span></div>
          <div id="ticketAtendio" class="muted"></div>
        </div>
      </div>

      <div id="ticketContent"></div>

      <div id="ticketFooter">
        <button id="btnCerrarTicket" class="secondary">Cerrar</button>
      </div>
    </div>
  </div>
<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const SUPABASE_URL = 'https://gnguvdqdhqrupkkrtdmp.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImduZ3V2ZHFkaHFydXBra3J0ZG1wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3NjEwNTIsImV4cCI6MjA3NTMzNzA1Mn0.a5XbjmM5eyREKI1j0HrZe36Gz52SAz0_3_jzjW8bYo0';

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// VALORES PERMITIDOS PARA INVENTARIO_MOVIMIENTOS.tipo
const TIPO_ENTRADA = "entrada";
const TIPO_SALIDA  = "salida";

// Helpers
const $ = id => document.getElementById(id);
const peso = n => Number(n ?? 0).toFixed(2);
const sleep = ms => new Promise(r => setTimeout(r, ms));

let carrito = [];
let productosCache = new Map();
let currentUser = null;
let currentRole = null;
let currentNombre = null;

// ===== LOGIN =====
$('btnLogin').addEventListener('click', async () => {
  const email = $('email').value.trim();
  const password = $('password').value.trim();
  const out = $('resultado');

  if (!email || !password) {
    out.innerHTML = '<span class="warn">Ingresa correo y contraseÃ±a</span>';
    return;
  }
  out.textContent = 'Iniciandoâ€¦';

  const { data, error } = await supabase.auth.signInWithPassword({ email, password });
  if (error) {
    out.innerHTML = '<span class="warn">' + error.message + '</span>';
    return;
  }

  currentUser = data.user;
  out.innerHTML = '<span class="ok">Login correcto</span>';
  await cargarPerfil(currentUser.id);
});

$('btnLogout').addEventListener('click', async () => {
  await supabase.auth.signOut();
  currentUser = null;
  currentRole = null;
  currentNombre = null;
  $('dashboard').classList.add('hidden');
  $('loginBox').classList.remove('hidden');
  $('resultado').textContent = 'ðŸ‘‹ SesiÃ³n cerrada.';
});

async function cargarPerfil(uid) {
  const { data, error } = await supabase
    .from('profiles')
    .select('nombre, rol_id, rol:rol_id(nombre)')
    .eq('user_id', uid)
    .single();

  if (error || !data) {
    $('resultado').innerHTML = '<span class="warn">No se encontrÃ³ perfil en "profiles"</span>';
    return;
  }

  currentRole = data.rol?.nombre ?? 'â€”';
  currentNombre = data.nombre ?? '';

  $('loginBox').classList.add('hidden');
  $('dashboard').classList.remove('hidden');
  $('userTitle').textContent = 'ðŸ‘¤ ' + currentNombre;
  $('userRole').textContent = "Rol: " + currentRole;

  const menu = $('menuOpciones');
  menu.innerHTML = `
    <button class="secondary" data-v="vistaVentas">ðŸ›’ Ventas</button>
    <button class="secondary" data-v="vistaInventario">ðŸ“Š Inventario</button>
    <button class="secondary" data-v="vistaCaja">ðŸ’µ Caja</button>
    <button class="secondary" data-v="vistaHistorial">ðŸ§¾ Historial</button>
    <button class="secondary" data-v="vistaReportes">ðŸ“ˆ Reporte</button>
  `;

  if (currentRole === "admin") {
    menu.innerHTML += `<button class="secondary" data-v="vistaProductos">ðŸ“¦ Productos</button>`;
  }

  menu.querySelectorAll('button').forEach(b =>
    b.addEventListener('click', () => abrirVista(b.dataset.v))
  );

  abrirVista("vistaVentas");
  await Promise.all([
    cargarProductosVenta(),
    cargarInventario(),
    cargarCaja(),
    cargarHistorial(),
    cargarReporte()
  ]);
}

function abrirVista(id) {
  document.querySelectorAll('#vistas > div').forEach(v => v.classList.add('hidden'));
  $(id).classList.remove('hidden');

  if (id === "vistaInventario") cargarInventario();
  if (id === "vistaProductos") cargarProductos();
  if (id === "vistaCaja") cargarCaja();
  if (id === "vistaHistorial") cargarHistorial();
  if (id === "vistaReportes") cargarReporte();
}

// ===== PRODUCTOS =====
async function cargarProductos() {
  const { data, error } = await supabase.from('productos').select('*').order('id');
  if (error) return;

  productosCache.clear();
  $('tablaProductos').innerHTML = data.map(p => `
    <tr>
      <td>${p.id}</td>
      <td>${p.nombre}</td>
      <td>$${peso(p.precio)}</td>
      <td>${p.stock}</td>
      <td>${p.stock_minimo || 0}</td>
      <td>${p.codigo_barras || ''}</td>
    </tr>
  `).join('');
}

$('formProducto').addEventListener('submit', async e => {
  e.preventDefault();
  const nombre = $('prodNombre').value.trim();
  const precio = parseFloat($('prodPrecio').value);
  const stock = parseInt($('prodStock').value || '0', 10);
  const codigo = $('prodCodigo').value.trim() || null;

  const { error } = await supabase.from('productos').insert({
    nombre, precio, stock, codigo_barras: codigo
  });

  if (error) return alert("Error guardando: " + error.message);

  e.target.reset();
  await Promise.all([cargarProductos(), cargarProductosVenta()]);
  alert("Producto guardado");
});

// ===== VENTAS =====
async function cargarProductosVenta() {
  const { data } = await supabase
    .from('productos')
    .select('id,nombre,precio,stock')
    .order('nombre');

  const sel = $('ventaProducto');
  sel.innerHTML = "";

  productosCache.clear();
  for (const p of data) {
    productosCache.set(p.id, p);
    sel.innerHTML += `<option value="${p.id}">${p.nombre} ($${peso(p.precio)}) â€” ${p.stock} en stock</option>`;
  }

  carrito = [];
  renderCarrito();
}

$('btnBuscarCodigo').addEventListener('click', async () => {
  const code = $('codigoBarras').value.trim();
  if (!code) return;
  const { data } = await supabase.from('productos').select('*').eq('codigo_barras', code).maybeSingle();
  $('codigoBarras').value = '';
  if (!data) return alert("No existe producto");
  addToCartFromProduct(data, 1);
});

$('formVenta').addEventListener('submit', e => {
  e.preventDefault();
  const id = parseInt($('ventaProducto').value, 10);
  const cant = parseInt($('ventaCantidad').value, 10);
  const p = productosCache.get(id);
  addToCartFromProduct(p, cant);
  e.target.reset();
});

function addToCartFromProduct(p, cantidad) {
  if (!p || cantidad <= 0) return;
  const enCarrito = carrito.find(x => x.id === p.id)?.cantidad ?? 0;
  if (cantidad + enCarrito > p.stock) return alert("Stock insuficiente");
  const ya = carrito.find(x => x.id === p.id);
  if (ya) ya.cantidad += cantidad;
  else carrito.push({ id: p.id, nombre: p.nombre, cantidad, precio: p.precio });
  renderCarrito();
}

function renderCarrito() {
  $('tablaCarrito').innerHTML = carrito.map(c => `
    <tr>
      <td>${c.nombre}</td>
      <td>${c.cantidad}</td>
      <td>$${peso(c.precio)}</td>
      <td>$${peso(c.cantidad * c.precio)}</td>
    </tr>
  `).join('');

  const total = carrito.reduce((s, c) => s + c.cantidad * c.precio, 0);
  $('totalVenta').textContent = peso(total);

  const ef = parseFloat($('efectivoRecibido').value || 0);
  $('cambioCalculado').textContent = peso(Math.max(ef - total, 0));
}

$('efectivoRecibido').addEventListener('input', renderCarrito);

$('btnFinalizarVenta').addEventListener('click', async () => {
  if (!carrito.length) return alert("Carrito vacÃ­o");

  const total = carrito.reduce((s, c) => s + c.cantidad * c.precio, 0);
  const efectivo = parseFloat($('efectivoRecibido').value || 0);

  if (efectivo < total) return alert("Efectivo insuficiente");

  const cambio = efectivo - total;

  // 1. Crear venta
  const { data: venta, error: errV } = await supabase
    .from('ventas')
    .insert({})
    .select()
    .single();

  if (errV) return alert("Error venta: " + errV.message);

  // 2. Agregar items + actualizar stock + movimiento inventario
  for (const c of carrito) {
    await supabase.from('ventas_items').insert({
      venta_id: venta.id,
      producto_id: c.id,
      cantidad: c.cantidad,
      precio_unitario: c.precio,
      subtotal: c.cantidad * c.precio
    });

    const prod = productosCache.get(c.id);
    const nuevoStock = prod.stock - c.cantidad;

    await supabase.from('productos')
      .update({ stock: nuevoStock })
      .eq('id', c.id);

    await supabase.from('inventario_movimientos').insert({
      producto_id: c.id,
      tipo: TIPO_SALIDA,
      cantidad: c.cantidad,
      motivo: "Venta #" + venta.id
    });
  }

  // 3. Caja
  await supabase.from('caja_movimientos').insert([
    { tipo: 'entrada', monto: total, motivo: `Venta #${venta.id}` },
    { tipo: 'salida',  monto: cambio, motivo: `Cambio venta #${venta.id}` }
  ]);

  const mostrar = confirm(`Venta #${venta.id} registrada\nÂ¿Ver ticket?`);
  if (mostrar) mostrarTicket(venta.id, venta.fecha, carrito, total, efectivo, cambio);

  carrito = [];
  $('efectivoRecibido').value = '';
  renderCarrito();

  await Promise.all([cargarProductosVenta(), cargarInventario(), cargarCaja(), cargarHistorial(), cargarReporte()]);
});

// ===== TICKET =====
function mostrarTicket(folio, fechaISO, items, total, efectivo, cambio) {
  const fecha = new Date(fechaISO).toLocaleString();

  let lines = [];
  lines.push("     TIENDITA LAS PALMAS");
  lines.push("       RFC: TLP010203AB1");
  lines.push(" Av. Siempre Viva 123, CDMX");
  lines.push("--------------------------------");
  lines.push(`Folio: ${folio}`);
  lines.push(`Fecha: ${fecha}`);
  lines.push(`AtendiÃ³: ${currentNombre} (${currentRole})`);
  lines.push("--------------------------------");
  lines.push(" PRODUCTO           CANT   IMP");
  lines.push("--------------------------------");

  for (const c of items) {
    const nombre = c.nombre.substring(0, 14).padEnd(14, ' ');
    const cant = String(c.cantidad).padStart(3, ' ');
    const imp = peso(c.cantidad * c.precio).padStart(7, ' ');
    lines.push(` ${nombre}   ${cant}  ${imp}`);
  }

  lines.push("--------------------------------");
  lines.push(` SUBTOTAL:        $${peso(total)}`);
  lines.push(` EFECTIVO:        $${peso(efectivo)}`);
  lines.push(` CAMBIO:          $${peso(cambio)}`);
  lines.push("--------------------------------");
  lines.push("   GRACIAS POR SU COMPRA");
  lines.push("   ESTE NO ES UN CFDI");
  lines.push("--------------------------------");

  $('ticketContent').textContent = lines.join("\n");
  $('ticketOverlay').style.display = "flex";
}

// ===== INVENTARIO (ARREGLADO) =====
async function cargarInventario() {
  const { data } = await supabase
    .from('inventario_movimientos')
    .select('*')
    .order('fecha', { ascending: false })
    .limit(100);

  const ids = [...new Set(data.map(m => m.producto_id))];

  const { data: prod } = await supabase
    .from('productos')
    .select('id,nombre')
    .in('id', ids);

  const nombres = {};
  prod?.forEach(p => nombres[p.id] = p.nombre);

  $('tablaInventario').innerHTML = data.map(m => `
    <tr>
      <td>${nombres[m.producto_id] || '#' + m.producto_id}</td>
      <td>${m.tipo}</td>
      <td>${m.cantidad}</td>
      <td>${m.fecha ? new Date(m.fecha).toLocaleString() : ''}</td>
      <td>${m.motivo}</td>
    </tr>
  `).join('');
}

$('formEntrada').addEventListener('submit', async e => {
  e.preventDefault();
  const codigo = $('invCodigo').value.trim();
  const cantidad = parseInt($('invCantidad').value, 10);

  const { data: p, error } = await supabase
    .from('productos')
    .select('id,stock')
    .eq('codigo_barras', codigo)
    .maybeSingle();

  if (error || !p) return alert("Producto no encontrado");

  await supabase.from('inventario_movimientos').insert({
    producto_id: p.id,
    tipo: TIPO_ENTRADA,
    cantidad,
    motivo: "Entrada manual"
  });

  await supabase.from('productos')
    .update({ stock: p.stock + cantidad })
    .eq('id', p.id);

  e.target.reset();
  await Promise.all([cargarInventario(), cargarProductosVenta(), cargarProductos()]);
});

// ===== CAJA =====
async function cargarCaja() {
  const { data } = await supabase.from('caja_movimientos').select('*').order('fecha', { ascending: false });

  let ent = 0, sal = 0;
  for (const m of data) {
    if (m.tipo === "entrada") ent += m.monto;
    else sal += m.monto;
  }

  $('cajaEntradas').textContent = peso(ent);
  $('cajaSalidas').textContent = peso(sal);
  $('cajaSaldo').textContent = peso(ent - sal);

  $('tablaCaja').innerHTML = data.map(m => `
    <tr>
      <td>${m.tipo}</td>
      <td>${peso(m.monto)}</td>
      <td>${m.motivo}</td>
      <td>${new Date(m.fecha).toLocaleString()}</td>
    </tr>
  `).join('');
}

// ===== HISTORIAL (CORREGIDO) =====
async function cargarHistorial() {
  const { data: ventas, error } = await supabase
    .from('ventas')
    .select('id, fecha')
    .order('id', { ascending: false })
    .limit(50);

  if (error || !ventas) return;

  const ids = ventas.map(v => v.id);

  const { data: items } = await supabase
    .from('ventas_items')
    .select('venta_id, cantidad, precio_unitario')
    .in('venta_id', ids);

  // Agrupar
  const totales = {};
  for (const it of items || []) {
    if (!totales[it.venta_id]) {
      totales[it.venta_id] = { cantidad: 0, total: 0 };
    }
    totales[it.venta_id].cantidad += it.cantidad;
    totales[it.venta_id].total += it.cantidad * it.precio_unitario;
  }

  $('tablaHistorial').innerHTML = ventas.map(v => {
    const data = totales[v.id] || { cantidad: 0, total: 0 };

    return `
      <tr>
        <td>${v.id}</td>
        <td>${new Date(v.fecha).toLocaleString()}</td>
        <td>${data.cantidad}</td>
        <td>$${peso(data.total)}</td>
      </tr>`;
  }).join('');
}

// ===== REPORTE =====
$('btnCargarReporte').addEventListener('click', cargarReporte);

async function cargarReporte() {
  const hoy = new Date();
  const inicio = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate());
  const fin = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate() + 1);

  const { data: ventas } = await supabase
    .from('ventas')
    .select('*')
    .gte('fecha', inicio.toISOString())
    .lt('fecha', fin.toISOString());

  const ids = ventas.map(v => v.id);

  const { data: items } = await supabase
    .from('ventas_items')
    .select('*')
    .in('venta_id', ids);

  let totalDia = 0, articulosDia = 0;

  for (const it of items) {
    totalDia += it.cantidad * it.precio_unitario;
    articulosDia += it.cantidad;
  }

  const { data: caja } = await supabase
    .from('caja_movimientos')
    .select('*')
    .gte('fecha', inicio.toISOString())
    .lt('fecha', fin.toISOString());

  let ent = 0, sal = 0;
  for (const m of caja) {
    if (m.tipo === "entrada") ent += m.monto;
    else sal += m.monto;
  }

  $('reporteResumen').innerHTML = `
    <div class="kpi"><label>Ventas</label><strong>${ventas.length}</strong></div>
    <div class="kpi"><label>ArtÃ­culos</label><strong>${articulosDia}</strong></div>
    <div class="kpi"><label>Importe</label><strong>$${peso(totalDia)}</strong></div>
    <div class="kpi"><label>Efectivo neto</label><strong>$${peso(ent - sal)}</strong></div>
  `;

  $('reporteDetalle').textContent =
    ventas.map(v => {
      const its = items.filter(i => i.venta_id === v.id);
      const total = its.reduce((s, i) => s + i.cantidad * i.precio_unitario, 0);
      return `Venta #${v.id} â€” $${peso(total)} â€” ${new Date(v.fecha).toLocaleTimeString()}`;
    }).join("\n") || "Sin ventas hoy";
}

</script>

</body>
</html>
