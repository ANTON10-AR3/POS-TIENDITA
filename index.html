<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>POS Tiendita</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --green:#4caf50; --greenD:#2e7d32; --blue:#2196F3; --red:#b00020; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
           background: linear-gradient(135deg,var(--green),var(--greenD)); margin:0; min-height:100vh;
           display:flex; align-items:center; justify-content:center; padding:24px; }
    .card { width:100%; max-width:560px; background:#fff; border-radius:14px; padding:28px;
            box-shadow:0 12px 28px rgba(0,0,0,.25); animation:fade .45s ease; }
    h2 { margin:0 0 18px; font-size:28px; text-align:center; }
    h3 { margin:10px 0 12px; }
    input, select { width:100%; padding:12px; margin:8px 0; border:1px solid #d9d9df;
                    border-radius:10px; font-size:15px; }
    button { padding:12px 16px; border:0; border-radius:10px; cursor:pointer; font-weight:700;
             background:var(--green); color:#fff; }
    button:hover { filter:brightness(0.95); }
    .secondary { background:var(--blue) }
    .logout { background:#f44336 }
    .menu { display:flex; flex-wrap:wrap; gap:10px; margin:12px 0 4px }
    .menu button { background:var(--blue) }
    table { width:100%; border-collapse:collapse; margin-top:10px; font-size:14px }
    th, td { border:1px solid #ececf1; padding:8px; text-align:center }
    .hidden { display:none }
    #resultado { margin-top:10px; min-height:22px; font-size:14px }
    .ok { color:var(--greenD); font-weight:700 }
    .warn { color:var(--red); font-weight:700 }
    @keyframes fade { from { opacity:0; transform:translateY(-6px) } to { opacity:1; transform:translateY(0) } }
  </style>
</head>
<body>
  <!-- Login -->
  <div class="card" id="loginBox">
    <h2>POS Tiendita</h2>
    <input type="email" id="email" placeholder="Correo" autocomplete="username" />
    <input type="password" id="password" placeholder="Contrase√±a" autocomplete="current-password" />
    <button id="btnLogin">Iniciar sesi√≥n</button>
    <div id="resultado">Listo para iniciar sesi√≥n‚Ä¶</div>
  </div>

  <!-- Dashboard -->
  <div class="card hidden" id="dashboard">
    <h2 id="userTitle"></h2>
    <p id="userRole"></p>
    <div class="menu" id="menuOpciones"></div>

    <div id="vistas">
      <!-- Productos -->
      <div id="vistaProductos" class="hidden">
        <h3>üì¶ Gesti√≥n de Productos</h3>
        <form id="formProducto">
          <input type="text" id="prodNombre" placeholder="Nombre" required />
          <input type="number" id="prodPrecio" placeholder="Precio" step="0.01" required />
          <input type="number" id="prodStock" placeholder="Stock inicial" required />
          <button type="submit" class="secondary">Agregar Producto</button>
        </form>
        <table>
          <thead><tr><th>ID</th><th>Nombre</th><th>Precio</th><th>Stock</th></tr></thead>
          <tbody id="tablaProductos"></tbody>
        </table>
      </div>

      <!-- Inventario -->
      <div id="vistaInventario" class="hidden">
        <h3>üìä Movimientos de Inventario</h3>
        <form id="formEntrada">
          <input type="number" id="invProducto" placeholder="Producto ID" required />
          <input type="number" id="invCantidad" placeholder="Cantidad" required />
          <button type="submit" class="secondary">Registrar Entrada</button>
        </form>
        <table>
          <thead><tr><th>Producto</th><th>Cantidad</th><th>Fecha</th></tr></thead>
          <tbody id="tablaInventario"></tbody>
        </table>
      </div>

      <!-- Reportes -->
      <div id="vistaReportes" class="hidden">
        <h3>üìë Reporte Diario</h3>
        <button id="btnCargarReporte" class="secondary">Cargar Reporte</button>
        <pre id="reporteContenido" style="background:#fafafa;border:1px solid #eee;border-radius:10px;padding:12px;overflow:auto"></pre>
      </div>

      <!-- Ventas -->
      <div id="vistaVentas" class="hidden">
        <h3>üõí Registrar Venta</h3>
        <form id="formVenta">
          <select id="ventaProducto"></select>
          <input type="number" id="ventaCantidad" placeholder="Cantidad" required />
          <button type="submit" class="secondary">Agregar al Carrito</button>
        </form>
        <h4>Carrito</h4>
        <ul id="carrito" style="margin:6px 0 12px"></ul>
        <button id="btnFinalizarVenta">Finalizar Venta</button>
      </div>

      <!-- Caja -->
      <div id="vistaCaja" class="hidden">
        <h3>üíµ Caja</h3>
        <form id="formCaja">
          <input type="number" id="cajaMonto" placeholder="Monto" step="0.01" required />
          <select id="cajaTipo">
            <option value="ingreso">Ingreso</option>
            <option value="egreso">Egreso</option>
          </select>
          <button type="submit" class="secondary">Registrar Movimiento</button>
        </form>
        <table>
          <thead><tr><th>Tipo</th><th>Monto</th><th>Fecha</th></tr></thead>
          <tbody id="tablaCaja"></tbody>
        </table>
      </div>
    </div>

    <button class="logout" id="btnLogout">Cerrar sesi√≥n</button>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    /************* CONFIG: usa los del proyecto que probaste OK *************/
    const SUPABASE_URL = "https://gnguvdqdhqrupkkrtdmp.supabase.co".trim();
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImduZ3V2ZHFkaHFydXBra3J0ZG1wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3NjEwNTIsImV4cCI6MjA3NTMzNzA1Mn0.a5XbjmM5eyREKI1j0HrZe36Gz52SAz0_3_jzjW8bYo0".trim();
    /*************************************************************************/

    const resultado = document.getElementById("resultado");

    // ---------- Autodiagn√≥stico de URL/KEY ----------
    function getJWT(k){ try { return JSON.parse(atob(k.split('.')[1])) } catch { return null } }
    const jwt = getJWT(SUPABASE_ANON_KEY);
    const urlRef = (SUPABASE_URL.match(/^https:\/\/([^.]+)\.supabase\.co\/?$/)||[])[1];

    if (!jwt) { resultado.innerHTML = '<span class="warn">‚ùå API key inv√°lida (no es JWT).</span>'; throw new Error('bad key'); }
    if (jwt.role !== 'anon') { resultado.innerHTML = `<span class="warn">‚ùå Key no es <b>anon</b> (role=${jwt.role}).</span>`; throw new Error('wrong role'); }
    if (urlRef !== jwt.ref) { resultado.innerHTML = `<span class="warn">‚ùå URL y KEY son de proyectos distintos.<br>URL ref: <b>${urlRef}</b> | KEY ref: <b>${jwt.ref}</b></span>`; throw new Error('mismatch'); }

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    resultado.innerHTML = '<span class="ok">‚úÖ Conexi√≥n a Supabase lista.</span>';

    // ---------- Estado y eventos ----------
    let carrito = [];
    window.addEventListener('DOMContentLoaded', () => {
      byId("btnLogin").addEventListener("click", login);
      byId("btnLogout").addEventListener("click", logout);
      byId("btnCargarReporte").addEventListener("click", cargarReporte);
      byId("btnFinalizarVenta").addEventListener("click", finalizarVenta);

      byId("formProducto").addEventListener("submit", onAgregarProducto);
      byId("formEntrada").addEventListener("submit", onRegistrarEntrada);
      byId("formVenta").addEventListener("submit", onAgregarAlCarrito);
      byId("formCaja").addEventListener("submit", onMovimientoCaja);
    });

    function byId(id){ return document.getElementById(id); }

    // ---------- Login ----------
    async function login() {
      try {
        resultado.textContent = "üîÑ Iniciando‚Ä¶";
        const email = byId("email").value.trim();
        const password = byId("password").value.trim();
        if (!email || !password) { resultado.innerHTML = '<span class="warn">‚ö†Ô∏è Ingresa correo y contrase√±a.</span>'; return; }

        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) { resultado.innerHTML = `<span class="warn">‚ùå ${error.message}</span>`; return; }

        resultado.textContent = "‚úÖ Login OK. Cargando perfil‚Ä¶";
        await cargarPerfil(data.user.id);
      } catch (e) {
        console.error(e);
        resultado.innerHTML = `<span class="warn">‚ùå Error inesperado en login.</span>`;
      }
    }

    // ---------- Perfil / Men√∫ ----------
    async function cargarPerfil(userId) {
      const { data, error } = await supabase
        .from("profiles")
        .select("nombre, rol_id, rol:rol_id(nombre)")
        .eq("user_id", userId)
        .single();

      if (error || !data) {
        console.error(error);
        resultado.innerHTML = `<span class="warn">‚ö†Ô∏è No se encontr√≥ perfil para UID <b>${userId}</b>. Revisa la tabla <b>profiles</b>.</span>`;
        return;
      }

      byId("loginBox").classList.add("hidden");
      byId("dashboard").classList.remove("hidden");
      byId("userTitle").textContent = "üë§ " + data.nombre;
      byId("userRole").textContent  = "Rol: " + (data.rol?.nombre ?? "‚Äî");

      const menu = byId("menuOpciones");
      menu.innerHTML = "";
      if (data.rol?.nombre === "admin") {
        menu.innerHTML += `<button data-v="vistaProductos" class="secondary">üì¶ Productos</button>`;
        menu.innerHTML += `<button data-v="vistaInventario" class="secondary">üìä Inventario</button>`;
        menu.innerHTML += `<button data-v="vistaReportes" class="secondary">üìë Reportes</button>`;
      } else {
        menu.innerHTML += `<button data-v="vistaVentas" class="secondary">üõí Ventas</button>`;
        menu.innerHTML += `<button data-v="vistaCaja" class="secondary">üíµ Caja</button>`;
      }
      menu.querySelectorAll("button").forEach(b => b.addEventListener("click", () => abrirVista(b.dataset.v)));
    }

    async function logout() {
      await supabase.auth.signOut();
      byId("dashboard").classList.add("hidden");
      byId("loginBox").classList.remove("hidden");
      resultado.textContent = "üëã Sesi√≥n cerrada.";
    }

    function abrirVista(id) {
      document.querySelectorAll("#vistas > div").forEach(d => d.classList.add("hidden"));
      const v = byId(id); if (!v) return;
      v.classList.remove("hidden");
      if (id === "vistaProductos") cargarProductos();
      if (id === "vistaInventario") cargarInventario();
      if (id === "vistaVentas")     cargarProductosVenta();
      if (id === "vistaCaja")       cargarCaja();
    }

    // ---------- Productos ----------
    async function cargarProductos() {
      const { data, error } = await supabase.from("productos").select("*").order("id", { ascending:true });
      if (error) { console.error(error); return; }
      byId("tablaProductos").innerHTML = (data||[]).map(p =>
        `<tr><td>${p.id}</td><td>${p.nombre}</td><td>$${Number(p.precio).toFixed(2)}</td><td>${p.stock}</td></tr>`
      ).join("");
    }
    async function onAgregarProducto(e){
      e.preventDefault();
      const nombre = byId("prodNombre").value.trim();
      const precio = parseFloat(byId("prodPrecio").value);
      const stock  = parseInt(byId("prodStock").value, 10);
      const { error } = await supabase.from("productos").insert([{ nombre, precio, stock }]);
      if (error) { alert("Error: " + error.message); return; }
      e.target.reset(); cargarProductos();
    }

    // ---------- Inventario ----------
    async function cargarInventario() {
      const { data, error } = await supabase.from("inventario_movimientos").select("*").order("fecha", { ascending:false });
      if (error) { console.error(error); return; }
      byId("tablaInventario").innerHTML = (data||[]).map(m =>
        `<tr><td>${m.producto_id}</td><td>${m.cantidad}</td><td>${new Date(m.fecha).toLocaleString()}</td></tr>`
      ).join("");
    }
    async function onRegistrarEntrada(e){
      e.preventDefault();
      const producto = parseInt(byId("invProducto").value, 10);
      const cantidad = parseInt(byId("invCantidad").value, 10);
      const { error } = await supabase.from("inventario_movimientos").insert([{ producto_id: producto, cantidad }]);
      if (error) { alert("Error: " + error.message); return; }
      e.target.reset(); cargarInventario();
    }

    // ---------- Reportes ----------
    async function cargarReporte(){
      const pre = byId("reporteContenido");
      pre.textContent = "Cargando‚Ä¶";
      const { data, error } = await supabase.rpc("reporte_diario");
      if (error) { pre.textContent = "Error: " + error.message; return; }
      pre.textContent = JSON.stringify(data, null, 2);
    }

    // ---------- Ventas ----------
    async function cargarProductosVenta(){
      const { data, error } = await supabase.from("productos").select("*").order("nombre");
      if (error) { console.error(error); return; }
      const sel = byId("ventaProducto");
      sel.innerHTML = (data||[]).map(p => `<option value="${p.id}">${p.nombre} ($${Number(p.precio).toFixed(2)})</option>`).join("");
      carrito = []; renderCarrito();
    }
    function onAgregarAlCarrito(e){
      e.preventDefault();
      const id = parseInt(byId("ventaProducto").value,10);
      const cantidad = parseInt(byId("ventaCantidad").value,10);
      if (!id || !cantidad || cantidad<=0) return;
      carrito.push({ id, cantidad }); renderCarrito(); e.target.reset();
    }
    function renderCarrito(){
      byId("carrito").innerHTML = carrito.map(c => `<li>#${c.id} √ó ${c.cantidad}</li>`).join("");
    }
    async function finalizarVenta(){
      if (carrito.length===0) return alert("Carrito vac√≠o");
      const { data, error } = await supabase.from("ventas").insert([{ fecha:new Date() }]).select("id").single();
      if (error) { alert("Error creando venta: " + error.message); return; }
      carrito = []; renderCarrito(); alert("‚úÖ Venta registrada (id " + data.id + ")");
    }
    window.abrirVista = abrirVista;
    window.finalizarVenta = finalizarVenta;

    // ---------- Caja ----------
    async function cargarCaja(){
      const { data, error } = await supabase.from("caja_movimientos").select("*").order("fecha",{ascending:false});
      if (error) { console.error(error); return; }
      byId("tablaCaja").innerHTML = (data||[]).map(m =>
        `<tr><td>${m.tipo}</td><td>${Number(m.monto).toFixed(2)}</td><td>${new Date(m.fecha).toLocaleString()}</td></tr>`
      ).join("");
    }
    async function onMovimientoCaja(e){
      e.preventDefault();
      const monto = parseFloat(byId("cajaMonto").value);
      const tipo  = byId("cajaTipo").value;
      const { error } = await supabase.from("caja_movimientos").insert([{ monto, tipo }]);
      if (error) { alert("Error: " + error.message); return; }
      e.target.reset(); cargarCaja();
    }
  </script>
</body>
</html>
