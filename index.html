<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>POS Tiendita</title>
  <style>
    :root { --green:#4caf50; --greenD:#2e7d32; --blue:#1e88e5; --red:#c62828; --bg:#f5f7fb }
    * { box-sizing: border-box }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: linear-gradient(135deg,var(--green),var(--greenD));
      min-height: 100vh; margin: 0; display:flex; align-items:center; justify-content:center; padding: 24px;
    }
    .card {
      width:100%; max-width: 980px; background:#fff; border-radius:16px; padding:24px;
      box-shadow: 0 20px 48px rgba(0,0,0,.25); animation: fade .35s ease;
    }
    h2 { margin: 0 0 10px; text-align:center }
    h3 { margin: 16px 0 12px }
    input, select, button { font-size: 15px; }
    input, select {
      width:100%; padding:12px; margin:6px 0; border:1px solid #e1e4ea; border-radius:10px; background:#fff;
    }
    button {
      padding:12px 14px; border:0; border-radius:10px; font-weight:700; cursor:pointer; background:var(--green); color:#fff;
    }
    button.secondary { background: var(--blue) }
    button.destructive { background: var(--red) }
    button.ghost { background:#e9eef8; color:#1a2a42 }
    button:hover { filter: brightness(.95) }
    .menu { display:flex; flex-wrap:wrap; gap:10px; margin: 12px 0 0 }
    .menu button { background:var(--blue) }
    .grid { display:grid; gap:12px }
    .col2 { grid-template-columns: 1fr 1fr }
    .col3 { grid-template-columns: 1fr 1fr 1fr }
    table { width:100%; border-collapse: collapse; margin-top: 10px; background:#fff }
    th, td { border: 1px solid #eef1f6; padding: 8px; text-align:center; vertical-align: top }
    th { background:#f7f9fe }
    .muted { color:#5f6b7a; font-size: 13px }
    .hidden { display:none }
    #resultado { min-height: 22px; margin-top:8px; }
    .ok { color: var(--greenD); font-weight: 700 }
    .warn { color: var(--red); font-weight: 700 }
    .low { background: #fff1f1 }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; background:#ecf3ff; color:#0c3a94 }
    .scan-flash { animation: flash .25s ease-in-out }
    @keyframes flash { from { background:#fff59d } to { background:transparent } }
    @keyframes fade { from{opacity:0; transform: translateY(-6px)} to {opacity:1; transform:none} }
    .section { background: var(--bg); border-radius: 12px; padding: 12px }
    video { width:100%; max-height: 240px; border-radius: 10px; background: #000 }
    pre.json { background:#0b1020; color:#c4d0ff; padding:12px; border-radius:10px; overflow:auto; white-space:pre-wrap }
  </style>
</head>
<body>
  <div class="card">
    <h2>POS Tiendita</h2>

    <!-- LOGIN -->
    <div id="loginBox">
      <div class="grid">
        <input id="email" type="email" placeholder="Correo" autocomplete="username" />
        <input id="password" type="password" placeholder="Contrase√±a" autocomplete="current-password" />
        <button id="btnLogin">Iniciar sesi√≥n</button>
      </div>
      <div id="resultado" class="muted">Listo para iniciar sesi√≥n‚Ä¶</div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" class="hidden">
      <div class="grid col2">
        <div>
          <div id="userTitle" class="pill">üë§ ‚Äî</div>
          <div id="userRole" class="muted">Rol: ‚Äî</div>
        </div>
        <div style="text-align:right">
          <button id="btnLogout" class="destructive">Cerrar sesi√≥n</button>
        </div>
      </div>

      <div class="menu" id="menuOpciones"></div>

      <div id="vistas" style="margin-top:16px">
        <!-- PRODUCTOS -->
        <div id="vistaProductos" class="hidden section">
          <h3>üì¶ Gesti√≥n de Productos</h3>
          <form id="formProducto" class="grid col3">
            <input id="prodNombre" type="text" placeholder="Nombre" required />
            <input id="prodPrecio" type="number" step="0.01" placeholder="Precio" required />
            <input id="prodStock" type="number" placeholder="Stock inicial" required />
            <div class="grid col3" style="grid-column: 1 / -1; gap:8px;">
              <input id="prodCodigo" type="text" placeholder="C√≥digo de barras (opcional)" />
              <button type="button" id="btnScanProducto" class="ghost">üì∑ Escanear</button>
              <button type="submit" class="secondary">Guardar</button>
            </div>
          </form>
          <video id="previewProd" autoplay muted playsinline class="hidden"></video>

          <div style="margin-top:10px" class="grid col2">
            <div>
              <input id="csvFile" type="file" accept=".csv" />
              <button id="btnImport" class="ghost">Importar CSV</button>
              <div class="muted">Formato: <code>nombre,precio,stock,codigo_barras</code></div>
            </div>
            <div style="text-align:right">
              <span class="pill">üîî Alerta: stock &lt; stock_minimo</span>
            </div>
          </div>

          <table>
            <thead><tr><th>ID</th><th>Nombre</th><th>Precio</th><th>Stock</th><th>M√≠n.</th><th>C√≥digo</th></tr></thead>
            <tbody id="tablaProductos"></tbody>
          </table>
        </div>

        <!-- INVENTARIO -->
        <div id="vistaInventario" class="hidden section">
          <h3>üìä Movimientos de Inventario</h3>
          <form id="formEntrada" class="grid col3">
            <input id="invProducto" type="text" placeholder="C√≥digo de barras del producto" required />
            <input id="invCantidad" type="number" placeholder="Cantidad" required />
            <button type="submit" class="secondary">Registrar Entrada</button>
          </form>
          <table>
            <thead><tr><th>Producto ID</th><th>Tipo</th><th>Cantidad</th><th>Fecha</th><th>Motivo</th></tr></thead>
            <tbody id="tablaInventario"></tbody>
          </table>
        </div>

        <!-- REPORTES -->
        <div id="vistaReportes" class="hidden section">
          <h3>üìë Reporte Diario</h3>
          <div class="grid col2" style="margin-bottom:10px">
            <div class="section" style="background:#fff">
              <div class="muted">Total ventas del d√≠a</div>
              <div style="font-weight:700;font-size:18px">$<span id="repTotalVentas">0.00</span></div>
              <div class="muted">N√∫m. ventas: <span id="repNumVentas">0</span></div>
              <div class="muted">Ticket promedio: $<span id="repTicketPromedio">0.00</span></div>
              <div class="muted">Producto m√°s vendido: <span id="repProductoTop">‚Äî</span></div>
            </div>
            <div>
              <button id="btnCargarReporte" class="secondary" style="margin-bottom:6px">Actualizar reporte de hoy</button>
              <button id="btnCerrarDia" class="destructive">Cerrar d√≠a</button>
              <div class="muted" style="margin-top:6px">
                El cierre de d√≠a registra un movimiento de tipo <b>cierre</b> en caja con el total de ventas de hoy.
              </div>
            </div>
          </div>
          <table>
            <thead><tr><th>Venta</th><th>Hora</th><th>Total aprox.</th></tr></thead>
            <tbody id="tablaReporteVentasDia"></tbody>
          </table>
          <pre id="reporteContenido" class="json" style="margin-top:10px"></pre>
        </div>

        <!-- VENTAS -->
        <div id="vistaVentas" class="hidden section">
          <h3>üõí Registrar Venta</h3>

          <!-- Buscar por c√≥digo + escanear -->
          <div class="grid col3">
            <input id="codigoBarras" type="text" placeholder="C√≥digo de barras" />
            <button id="btnBuscarCodigo" class="ghost">Buscar</button>
            <button id="btnStartScanner" class="ghost">üì∑ Escanear</button>
          </div>
          <video id="preview" autoplay muted playsinline class="hidden" style="margin-top:8px"></video>

          <!-- Selecci√≥n manual -->
          <form id="formVenta" class="grid col3" style="margin-top:10px">
            <select id="ventaProducto"></select>
            <input id="ventaCantidad" type="number" placeholder="Cantidad" required />
            <button type="submit" class="secondary">Agregar al Carrito</button>
          </form>

          <h4 style="margin:12px 0 6px">Carrito</h4>
          <table>
            <thead><tr><th>Producto</th><th>Cant</th><th>Precio</th><th>Subtotal</th></tr></thead>
            <tbody id="tablaCarrito"></tbody>
          </table>
          <div class="grid col3" style="align-items:center; margin-top:10px">
            <div>
              <div class="muted">Total:</div>
              <div style="font-weight:800; font-size:18px">$<span id="totalVenta">0.00</span></div>
            </div>
            <div>
              <input id="ventaPagoCon" type="number" step="0.01" placeholder="Pago con" />
              <div class="muted">Cambio: $<span id="ventaCambio">0.00</span></div>
            </div>
            <div style="text-align:right">
              <button id="btnFinalizarVenta">Finalizar Venta</button>
              <button id="btnImprimir" class="ghost">üñ®Ô∏è Imprimir Ticket</button>
            </div>
          </div>
        </div>

        <!-- CAJA -->
        <div id="vistaCaja" class="hidden section">
          <h3>üíµ Caja</h3>
          <form id="formCaja" class="grid col3">
            <input id="cajaMonto" type="number" step="0.01" placeholder="Monto manual" required />
            <select id="cajaTipo">
              <option value="ingreso">Ingreso</option>
              <option value="egreso">Egreso</option>
              <option value="cierre">Cierre</option>
            </select>
            <button type="submit" class="secondary">Registrar</button>
          </form>
          <div class="grid col3" style="margin-top:10px">
            <div class="muted">Ingresos: $<span id="cajaIngresos">0.00</span></div>
            <div class="muted">Egresos: $<span id="cajaEgresos">0.00</span></div>
            <div class="muted">Saldo: $<span id="cajaSaldo">0.00</span></div>
          </div>
          <table>
            <thead><tr><th>Tipo</th><th>Monto</th><th>Fecha</th></tr></thead>
            <tbody id="tablaCaja"></tbody>
          </table>
        </div>

        <!-- HISTORIAL -->
        <div id="vistaHistorial" class="hidden section">
          <h3>üßæ Historial de Ventas</h3>
          <table>
            <thead><tr><th>ID</th><th>Fecha</th><th>Detalle</th></tr></thead>
            <tbody id="tablaHistorial"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- SCRIPT -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const SUPABASE_URL = 'https://gnguvdqdhqrupkkrtdmp.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImduZ3V2ZHFkaHFydXBra3J0ZG1wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3NjEwNTIsImV4cCI6MjA3NTMzNzA1Mn0.a5XbjmM5eyREKI1j0HrZe36Gz52SAz0_3_jzjW8bYo0';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let carrito = [];
    let productosCache = new Map();
    let currentUser = null;

    const $  = (id)=>document.getElementById(id);
    const peso = (n)=> Number(n ?? 0).toFixed(2);
    const beep = ()=> {
      try {
        new Audio('https://actions.google.com/sounds/v1/buttons/beep_short.ogg').play();
      } catch {}
    };

    // ---------- LOGIN ----------
    $('btnLogin').addEventListener('click', async ()=>{
      const email = $('email').value.trim();
      const password = $('password').value.trim();
      const out = $('resultado');
      if (!email || !password) {
        out.innerHTML = '<span class="warn">Ingresa correo y contrase√±a</span>';
        return;
      }
      out.textContent = 'Iniciando‚Ä¶';
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) { out.innerHTML = `<span class="warn">${error.message}</span>`; return; }
      currentUser = data.user;
      out.innerHTML = '<span class="ok">Login OK</span>';
      await cargarPerfil(data.user.id);
    });

    $('btnLogout').addEventListener('click', async ()=>{
      await supabase.auth.signOut();
      currentUser = null;
      $('dashboard').classList.add('hidden');
      $('loginBox').classList.remove('hidden');
      $('resultado').textContent = 'üëã Sesi√≥n cerrada.';
    });

    async function cargarPerfil(uid){
      const { data, error } = await supabase
        .from('profiles')
        .select('nombre, rol_id, rol:rol_id(nombre)')
        .eq('user_id', uid).single();

      if (error || !data) {
        $('resultado').innerHTML = '<span class="warn">No se encontr√≥ perfil en tabla profiles</span>';
        return;
      }

      $('loginBox').classList.add('hidden');
      $('dashboard').classList.remove('hidden');
      $('userTitle').textContent = 'üë§ ' + data.nombre;
      $('userRole').textContent  = 'Rol: ' + (data.rol?.nombre ?? '‚Äî');

      const menu = $('menuOpciones');
      menu.innerHTML = '';
      if (data.rol?.nombre === 'admin') {
        menu.innerHTML += `<button class="secondary" data-v="vistaProductos">üì¶ Productos</button>`;
        menu.innerHTML += `<button class="secondary" data-v="vistaInventario">üìä Inventario</button>`;
        menu.innerHTML += `<button class="secondary" data-v="vistaReportes">üìë Reportes</button>`;
        menu.innerHTML += `<button class="secondary" data-v="vistaVentas">üõí Ventas</button>`;
        menu.innerHTML += `<button class="secondary" data-v="vistaCaja">üíµ Caja</button>`;
        menu.innerHTML += `<button class="secondary" data-v="vistaHistorial">üßæ Historial</button>`;
      } else {
        menu.innerHTML += `<button class="secondary" data-v="vistaVentas">üõí Ventas</button>`;
        menu.innerHTML += `<button class="secondary" data-v="vistaCaja">üíµ Caja</button>`;
        menu.innerHTML += `<button class="secondary" data-v="vistaHistorial">üßæ Historial</button>`;
      }
      menu.querySelectorAll('button').forEach(b=> b.addEventListener('click', ()=> abrirVista(b.dataset.v)));
      abrirVista('vistaVentas');
    }

    function abrirVista(id){
      document.querySelectorAll('#vistas > div').forEach(d=>d.classList.add('hidden'));
      const el = $(id); if (!el) return;
      el.classList.remove('hidden');
      if (id==='vistaProductos')  cargarProductos();
      if (id==='vistaInventario') cargarInventario();
      if (id==='vistaVentas')     cargarProductosVenta();
      if (id==='vistaCaja')       cargarCaja();
      if (id==='vistaHistorial')  cargarHistorial();
      if (id==='vistaReportes')   cargarReporteDia(false);
    }

    // ==================== PRODUCTOS ====================
    async function cargarProductos(){
      const { data, error } = await supabase.from('productos').select('*').order('id');
      if (error) { console.error(error); return; }
      productosCache.clear();
      $('tablaProductos').innerHTML = (data || []).map(p=>{
        productosCache.set(p.id, p);
        const low = (p.stock < (p.stock_minimo ?? 5)) ? 'low' : '';
        return `<tr class="${low}">
          <td>${p.id}</td>
          <td>${p.nombre}</td>
          <td>$${peso(p.precio)}</td>
          <td>${p.stock}</td>
          <td>${p.stock_minimo ?? '-'}</td>
          <td>${p.codigo_barras || ''}</td>
        </tr>`;
      }).join('');
    }

    $('formProducto').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const nombre = $('prodNombre').value.trim();
      const precio = parseFloat($('prodPrecio').value);
      const stock  = parseInt($('prodStock').value || '0', 10);
      const codigo = $('prodCodigo').value.trim() || null;
      if (!nombre || isNaN(precio)) { alert('Completa nombre y precio'); return; }

      try {
        if (codigo) {
          const { error } = await supabase.rpc('upsert_producto_por_codigo', {
            p_nombre: nombre,
            p_precio: precio,
            p_codigo: codigo,
            p_stock_inicial: stock
          });
          if (error) throw error;
        } else {
          const { error } = await supabase.from('productos').insert({
            nombre,
            precio,
            stock
          });
          if (error) throw error;
        }
        e.target.reset();
        await cargarProductos();
        alert('‚úÖ Producto guardado');
      } catch(err) {
        alert('Error guardando producto: ' + err.message);
      }
    });

    $('btnImport').addEventListener('click', ()=>{
      const f = $('csvFile').files?.[0];
      if (!f) return alert('Selecciona un archivo CSV');
      const r = new FileReader();
      r.onload = async ()=>{
        const rows = String(r.result).split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
        for (const line of rows) {
          const [nombre,precio,stock,codigo] = line.split(',').map(x=>x?.trim());
          if (!nombre || !precio) continue;
          try {
            if (codigo) {
              await supabase.rpc('upsert_producto_por_codigo', {
                p_nombre: nombre,
                p_precio: parseFloat(precio),
                p_codigo: codigo,
                p_stock_inicial: parseInt(stock || '0', 10)
              });
            } else {
              await supabase.from('productos').insert({
                nombre,
                precio: parseFloat(precio),
                stock: parseInt(stock || '0', 10)
              });
            }
          } catch(e) { console.error(e); }
        }
        await cargarProductos();
        alert('‚úÖ Importaci√≥n terminada');
      };
      r.readAsText(f);
    });

    // ----- esc√°ner alta c√≥digo de barras -----
    let prodStream = null;
    let prodDetector = null;
    let prodScanning = false;

    $('btnScanProducto').addEventListener('click', async ()=>{
      if (prodScanning) { stopScanProd(); return; }
      if (!('BarcodeDetector' in window)) {
        alert('Tu navegador no soporta escaneo nativo. Usa el lector USB como teclado.');
        return;
      }
      const video = $('previewProd');
      video.classList.remove('hidden');
      prodStream = await navigator.mediaDevices.getUserMedia({
        video:{ facingMode:{ ideal:'environment' } }, audio:false
      });
      video.srcObject = prodStream;
      prodDetector = new window.BarcodeDetector({ formats:['ean_13','ean_8','upc_a','code_128'] });
      prodScanning = true;
      scanProdLoop(video);
    });

    function stopScanProd(){
      prodScanning = false;
      if (prodStream) { prodStream.getTracks().forEach(t=>t.stop()); prodStream = null; }
      $('previewProd').classList.add('hidden');
    }

    async function scanProdLoop(video){
      while (prodScanning && prodDetector) {
        try {
          if (!video.videoWidth) { await new Promise(r=>setTimeout(r,150)); continue; }
          const canvas = document.createElement('canvas');
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          canvas.getContext('2d').drawImage(video,0,0,canvas.width,canvas.height);
          const bmp = await createImageBitmap(canvas);
          const codes = await prodDetector.detect(bmp);
          if (codes && codes.length) {
            const code = String(codes[0].rawValue || '');
            if (code) {
              $('prodCodigo').value = code;
              beep();
              stopScanProd();
              break;
            }
          }
        } catch(e) { console.error(e); }
        await new Promise(r=>setTimeout(r,200));
      }
    }

    // ==================== UTIL: PRODUCTO POR C√ìDIGO ====================
    async function obtenerProductoPorCodigo(code){
      const codigo = String(code || '').trim();
      if (!codigo) return null;

      // 1) RPC si existe
      try {
        const { data, error } = await supabase.rpc('buscar_producto_por_codigo', { p_codigo: codigo });
        if (!error && data && data.length) return data[0];
      } catch(e) { console.error(e); }

      // 2) Fallback select directo
      const { data, error } = await supabase
        .from('productos')
        .select('id,nombre,precio,stock,codigo_barras')
        .eq('codigo_barras', codigo)
        .maybeSingle();
      if (error) { console.error(error); return null; }
      return data || null;
    }

    // ==================== VENTAS ====================
    async function cargarProductosVenta(){
      const { data, error } = await supabase.from('productos')
        .select('id,nombre,precio,stock,codigo_barras')
        .order('nombre');
      if (error) { console.error(error); return; }
      const sel = $('ventaProducto');
      sel.innerHTML = '';
      productosCache.clear();
      for (const p of (data || [])) {
        productosCache.set(p.id, p);
        sel.innerHTML += `<option value="${p.id}">${p.nombre} ($${peso(p.precio)}) ‚Äî ${p.stock} en stock</option>`;
      }
      carrito = [];
      renderCarrito();
      actualizarCambio();
    }

    $('btnBuscarCodigo').addEventListener('click', async ()=>{
      const code = $('codigoBarras').value.trim();
      if (!code) return;
      await buscarYAgregarPorCodigo(code);
      $('codigoBarras').value = '';
    });

    async function buscarYAgregarPorCodigo(code){
      const found = await obtenerProductoPorCodigo(code);
      if (!found) {
        alert('No se encontr√≥ el producto para ese c√≥digo');
        return;
      }
      addToCartFromProduct(found, 1);
      const lastRow = $('tablaCarrito').lastElementChild;
      if (lastRow) lastRow.classList.add('scan-flash');
      beep();
    }

    $('formVenta').addEventListener('submit', (e)=>{
      e.preventDefault();
      const id = parseInt($('ventaProducto').value,10);
      const cant = parseInt($('ventaCantidad').value,10);
      const p = productosCache.get(id);
      if (!p) { alert('Producto inexistente'); return; }
      addToCartFromProduct(p, cant);
      e.target.reset();
    });

    function addToCartFromProduct(p, cantidad){
      if (!p || !cantidad || cantidad <= 0) return;
      const ya = carrito.find(x=>x.id === p.id);
      const enCarrito = ya ? ya.cantidad : 0;
      if (p.stock != null && (cantidad + enCarrito) > p.stock) {
        alert(`Solo hay ${p.stock} unidades de "${p.nombre}" en stock`);
        return;
      }
      if (ya) ya.cantidad += cantidad;
      else carrito.push({
        id: p.id,
        nombre: p.nombre,
        cantidad,
        precio: Number(p.precio ?? 0)
      });
      renderCarrito();
    }

    function renderCarrito(){
      $('tablaCarrito').innerHTML = carrito.map(c=>`
        <tr>
          <td>${c.nombre}</td>
          <td>${c.cantidad}</td>
          <td>$${peso(c.precio)}</td>
          <td>$${peso(c.cantidad * c.precio)}</td>
        </tr>
      `).join('');
      const total = carrito.reduce((s,c)=> s + c.cantidad * c.precio, 0);
      $('totalVenta').textContent = peso(total);
      actualizarCambio();
    }

    function actualizarCambio(){
      const total = parseFloat($('totalVenta').textContent || '0');
      const pago = parseFloat($('ventaPagoCon').value || '0');
      const cambio = (!isNaN(pago) && pago >= total) ? (pago - total) : 0;
      $('ventaCambio').textContent = peso(cambio);
    }

    $('ventaPagoCon').addEventListener('input', actualizarCambio);

    // esc√°ner para ventas
    let ventaStream = null;
    let ventaDetector = null;
    let ventaScanning = false;

    $('btnStartScanner').addEventListener('click', async ()=>{
      if (ventaScanning) { stopScannerVentas(); return; }
      if (!('BarcodeDetector' in window)) {
        alert('Tu navegador no soporta escaneo nativo. Tambi√©n puedes usar lector USB como teclado.');
        return;
      }
      const video = $('preview');
      video.classList.remove('hidden');
      ventaStream = await navigator.mediaDevices.getUserMedia({
        video:{ facingMode:{ ideal:'environment' } }, audio:false
      });
      video.srcObject = ventaStream;
      ventaDetector = new window.BarcodeDetector({ formats:['ean_13','ean_8','upc_a','code_128'] });
      ventaScanning = true;
      scanVentasLoop(video);
    });

    function stopScannerVentas(){
      ventaScanning = false;
      if (ventaStream) { ventaStream.getTracks().forEach(t=>t.stop()); ventaStream = null; }
      $('preview').classList.add('hidden');
    }

    async function scanVentasLoop(video){
      while (ventaScanning && ventaDetector) {
        try {
          if (!video.videoWidth) { await new Promise(r=>setTimeout(r,150)); continue; }
          const canvas = document.createElement('canvas');
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          canvas.getContext('2d').drawImage(video,0,0,canvas.width,canvas.height);
          const bmp = await createImageBitmap(canvas);
          const codes = await ventaDetector.detect(bmp);
          if (codes && codes.length) {
            const code = String(codes[0].rawValue || '');
            if (code) {
              stopScannerVentas();
              await buscarYAgregarPorCodigo(code);
              break;
            }
          }
        } catch(e) { console.error(e); }
        await new Promise(r=>setTimeout(r,200));
      }
    }

    // finalizar venta con pago/cambio, caja y ticket
    $('btnFinalizarVenta').addEventListener('click', async ()=>{
      if (!carrito.length) return alert('Carrito vac√≠o');

      const total = carrito.reduce((s,c)=> s + c.cantidad * c.precio, 0);
      const pago = parseFloat($('ventaPagoCon').value || '0');
      if (isNaN(pago) || pago < total) {
        alert('El pago debe ser mayor o igual al total de la venta');
        return;
      }
      const cambio = pago - total;
      $('ventaCambio').textContent = peso(cambio);

      // copia del carrito para el ticket antes de vaciar
      const itemsTicket = carrito.map(c=>({ ...c }));

      try {
        const { data:venta, error:errV } = await supabase
          .from('ventas')
          .insert({})
          .select('id,fecha')
          .single();
        if (errV) throw errV;

        for (const c of carrito) {
          const precioUnit = Number(c.precio ?? productosCache.get(c.id)?.precio ?? 0);
          const { error } = await supabase.from('ventas_items').insert({
            venta_id: venta.id,
            producto_id: c.id,
            cantidad: c.cantidad,
            precio_unitario: precioUnit
          });
          if (error) throw error;
        }

        // movimientos de caja: ingreso por total y egreso por cambio
        const movimientos = [
          { monto: total, tipo: 'ingreso' }
        ];
        if (cambio > 0) movimientos.push({ monto: cambio, tipo: 'egreso' });
        await supabase.from('caja_movimientos').insert(movimientos);

        // actualizar vistas
        carrito = [];
        renderCarrito();
        $('ventaPagoCon').value = '';
        $('ventaCambio').textContent = '0.00';
        await Promise.all([cargarProductosVenta(), cargarProductos(), cargarHistorial(), cargarCaja(), cargarReporteDia(false)]);

        if (confirm('‚úÖ Venta registrada (#'+venta.id+'). ¬øDeseas imprimir ticket?')) {
          imprimirTicket(venta, itemsTicket, total, pago, cambio);
        }
      } catch(e) {
        alert('Error registrando venta: ' + e.message);
      }
    });

    function imprimirTicket(venta, items, total, pago, cambio){
      const lineas = items.map(c =>
        `${c.nombre.padEnd(16).slice(0,16)} x${String(c.cantidad).padStart(2)}  $${peso(c.cantidad*c.precio)}`
      ).join('<br>');

      const html = `
        <html>
        <head>
          <meta charset="utf-8">
          <title>Ticket</title>
          <style>
            body { font-family: monospace; margin:0; padding:0; }
            .ticket {
              width: 260px;
              padding: 12px;
            }
            h3, h4 { margin:0; text-align:center; }
            hr { border:none; border-top:1px dashed #000; margin:6px 0; }
            .tot { text-align:right; }
          </style>
        </head>
        <body>
          <div class="ticket">
            <h3>TIENDITA MX</h3>
            <div style="text-align:center;font-size:11px">
              RFC: TDM010101ABC<br>
              Av. Principal 123, CDMX
            </div>
            <hr>
            <div>Folio: ${venta.id}</div>
            <div>${venta.fecha ? new Date(venta.fecha).toLocaleString() : new Date().toLocaleString()}</div>
            <hr>
            <div style="font-size:12px">
              ${lineas || '(sin items)'}
            </div>
            <hr>
            <div class="tot">SUBTOTAL: $${peso(total)}</div>
            <div class="tot">PAGO:     $${peso(pago)}</div>
            <div class="tot">CAMBIO:   $${peso(cambio)}</div>
            <hr>
            <h4>¬°GRACIAS POR SU COMPRA!</h4>
          </div>
        </body>
        </html>
      `;
      const w = window.open('', 'ticket', 'width=320,height=600');
      w.document.write(html);
      w.document.close();
      w.focus();
      w.print();
    }

    // ==================== INVENTARIO ====================
    async function cargarInventario(){
      const { data, error } = await supabase
        .from('inventario_movimientos')
        .select('producto_id,tipo,cantidad,fecha,motivo')
        .order('fecha', { ascending:false });
      if (error) { console.error(error); return; }
      $('tablaInventario').innerHTML = (data || []).map(m=>`
        <tr>
          <td>${m.producto_id}</td>
          <td>${m.tipo || ''}</td>
          <td>${m.cantidad}</td>
          <td>${m.fecha ? new Date(m.fecha).toLocaleString() : ''}</td>
          <td>${m.motivo || ''}</td>
        </tr>
      `).join('');
    }

    $('formEntrada').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const codigo = $('invProducto').value.trim();
      const cantidad   = parseInt($('invCantidad').value,10);
      if (!codigo || !cantidad) { alert('Completa c√≥digo y cantidad'); return; }
      try {
        const prod = await obtenerProductoPorCodigo(codigo);
        if (!prod) { alert('No se encontr√≥ el producto para ese c√≥digo'); return; }
        const { error } = await supabase.from('inventario_movimientos').insert({
          producto_id: prod.id,
          tipo: 'ENTRADA',
          cantidad,
          motivo: 'Entrada manual'
        });
        if (error) throw error;
        e.target.reset();
        await Promise.all([cargarInventario(), cargarProductos()]);
      } catch(err) {
        alert('Error registrando inventario: ' + err.message);
      }
    });

    // ==================== CAJA ====================
    async function cargarCaja(){
      const { data, error } = await supabase
        .from('caja_movimientos')
        .select('*')
        .order('fecha', { ascending:false });
      if (error) { console.error(error); return; }

      let ingresos = 0, egresos = 0;
      (data || []).forEach(c=>{
        if (c.tipo === 'egreso') egresos += Number(c.monto || 0);
        else if (c.tipo === 'ingreso') ingresos += Number(c.monto || 0);
      });

      $('cajaIngresos').textContent = peso(ingresos);
      $('cajaEgresos').textContent  = peso(egresos);
      $('cajaSaldo').textContent    = peso(ingresos - egresos);

      $('tablaCaja').innerHTML = (data || []).map(c=>`
        <tr>
          <td>${c.tipo}</td>
          <td>$${peso(c.monto)}</td>
          <td>${c.fecha ? new Date(c.fecha).toLocaleString() : ''}</td>
        </tr>
      `).join('');
    }

    $('formCaja').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const monto = parseFloat($('cajaMonto').value);
      const tipo  = $('cajaTipo').value;
      if (!monto || isNaN(monto)) { alert('Monto inv√°lido'); return; }
      try {
        const { error } = await supabase.from('caja_movimientos').insert({
          monto,
          tipo
        });
        if (error) throw error;
        e.target.reset();
        await cargarCaja();
      } catch(err) {
        alert('Error registrando caja: ' + err.message);
      }
    });

    // ==================== REPORTES / HISTORIAL ====================
    $('btnCargarReporte').addEventListener('click', ()=>cargarReporteDia(false));
    $('btnCerrarDia').addEventListener('click', ()=>cargarReporteDia(true));

    async function cargarReporteDia(cerrar){
      try {
        const hoy = new Date();
        const start = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate());
        const end   = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate()+1);
        const startIso = start.toISOString();
        const endIso   = end.toISOString();

        const { data:ventas, error } = await supabase
          .from('ventas')
          .select('id,fecha')
          .gte('fecha', startIso)
          .lt('fecha', endIso)
          .order('fecha', { ascending:true });
        if (error) throw error;

        let totalDia = 0;
        const filas = [];
        const conteoProductos = new Map(); // id -> uds

        for (const v of (ventas || [])) {
          const { data:items, error:errI } = await supabase
            .from('ventas_items')
            .select('cantidad,precio_unitario,producto_id')
            .eq('venta_id', v.id);
          if (errI) throw errI;

          let totalVenta = 0;
          for (const it of (items || [])) {
            totalVenta += it.cantidad * it.precio_unitario;
            if (it.producto_id != null) {
              const prev = conteoProductos.get(it.producto_id) || 0;
              conteoProductos.set(it.producto_id, prev + it.cantidad);
            }
          }
          totalDia += totalVenta;
          filas.push({ id:v.id, fecha:v.fecha, total: totalVenta });
        }

        const numVentas = filas.length;
        const ticketProm = numVentas ? (totalDia / numVentas) : 0;

        $('repTotalVentas').textContent     = peso(totalDia);
        $('repNumVentas').textContent       = String(numVentas);
        $('repTicketPromedio').textContent  = peso(ticketProm);

        // producto m√°s vendido
        let productoTopTexto = '‚Äî';
        if (conteoProductos.size) {
          const ids = Array.from(conteoProductos.keys());
          const { data:prods, error:errP } = await supabase
            .from('productos')
            .select('id,nombre')
            .in('id', ids);
          if (errP) console.error(errP);
          else {
            const mapNombres = new Map();
            (prods || []).forEach(p=> mapNombres.set(p.id, p.nombre));
            let bestId = null, bestCant = -1;
            conteoProductos.forEach((cant,id)=>{
              if (cant > bestCant) { bestCant = cant; bestId = id; }
            });
            if (bestId != null) {
              const nom = mapNombres.get(bestId) || ('Producto '+bestId);
              productoTopTexto = `${nom} (${bestCant} uds)`;
            }
          }
        }
        $('repProductoTop').textContent = productoTopTexto;

        $('tablaReporteVentasDia').innerHTML = filas.map(f=>`
          <tr>
            <td>${f.id}</td>
            <td>${f.fecha ? new Date(f.fecha).toLocaleTimeString() : ''}</td>
            <td>$${peso(f.total)}</td>
          </tr>
        `).join('') || '<tr><td colspan="3">Sin ventas hoy</td></tr>';

        $('reporteContenido').textContent = JSON.stringify({
          fecha: start.toISOString().substring(0,10),
          totalDia,
          numVentas,
          ticketPromedio: ticketProm,
          productoTop: productoTopTexto
        }, null, 2);

        if (cerrar) {
          const ok = confirm(`Total ventas del d√≠a: $${peso(totalDia)}.\n¬øRegistrar cierre de d√≠a en caja?`);
          if (!ok) return;
          const { error:errC } = await supabase.from('caja_movimientos').insert({
            monto: totalDia,
            tipo: 'cierre'
          });
          if (errC) {
            alert('Error registrando cierre: ' + errC.message);
          } else {
            alert('Cierre de d√≠a registrado en caja.');
            await cargarCaja();
          }
        }
      } catch(e) {
        $('reporteContenido').textContent = 'Error cargando reporte: ' + e.message;
      }
    }

    async function cargarHistorial(){
      const { data:ventas, error } = await supabase
        .from('ventas')
        .select('id,fecha')
        .order('id', { ascending:false })
        .limit(50);
      if (error) { console.error(error); return; }

      const filasHTML = [];
      for (const v of (ventas || [])) {
        let detalleHtml = '';
        let total = 0;
        try {
          const { data:items, error:errI } = await supabase
            .from('ventas_items')
            .select('cantidad,precio_unitario,productos(nombre)')
            .eq('venta_id', v.id);
          if (!errI && items) {
            detalleHtml = items.map(i=>{
              const nom = i.productos?.nombre || 'Prod';
              const sub = i.cantidad * i.precio_unitario;
              total += sub;
              return `${nom} x${i.cantidad} ($${peso(i.precio_unitario)}) = $${peso(sub)}`;
            }).join('<br>');
          } else {
            detalleHtml = '(sin detalle)';
          }
        } catch(e) {
          console.error(e);
          detalleHtml = '(error obteniendo detalle)';
        }
        detalleHtml += `<br><strong>Total: $${peso(total)}</strong>`;
        filasHTML.push(`
          <tr>
            <td>${v.id}</td>
            <td>${v.fecha ? new Date(v.fecha).toLocaleString() : ''}</td>
            <td>${detalleHtml}</td>
          </tr>
        `);
      }
      $('tablaHistorial').innerHTML = filasHTML.join('') || '<tr><td colspan="3">Sin ventas registradas</td></tr>';
    }
  </script>
</body>
</html>
