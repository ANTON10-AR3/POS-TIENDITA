<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>POS Tiendita</title>
  <style>
    body { font-family: Arial, sans-serif; background: linear-gradient(135deg,#4caf50,#2e7d32); margin:0; height:100vh; display:flex; justify-content:center; align-items:center; }
    .card { background:#fff; border-radius:10px; padding:30px; box-shadow:0 4px 10px rgba(0,0,0,0.3); width:500px; text-align:center; animation: fadeIn .7s ease; }
    h2 { margin-bottom:20px; }
    input, select { width:100%; padding:10px; margin:8px 0; border:1px solid #ccc; border-radius:5px; }
    button { padding:10px 15px; margin:5px; border:none; border-radius:5px; cursor:pointer; background:#4CAF50; color:#fff; font-weight:bold; }
    button:hover { background:#45a049; }
    .logout { background:#f44336 !important; }
    .menu { margin:15px 0; }
    .menu button { background:#2196F3; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { border:1px solid #ccc; padding:8px; text-align:center; }
    #resultado { margin-top:15px; font-size:14px; color:#333; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(-20px);} to {opacity:1; transform:translateY(0);} }
    .hidden { display:none; }
  </style>
</head>
<body>
  <!-- Login -->
  <div class="card" id="loginBox">
    <h2>POS Tiendita</h2>
    <input type="email" id="email" placeholder="Correo">
    <input type="password" id="password" placeholder="ContraseÃ±a">
    <button id="btnLogin">Iniciar sesiÃ³n</button>
    <div id="resultado"></div>
  </div>

  <!-- Dashboard -->
  <div class="card hidden" id="dashboard">
    <h2 id="userTitle"></h2>
    <p id="userRole"></p>
    <div class="menu" id="menuOpciones"></div>
    <div id="vistas">
      <!-- Productos -->
      <div id="vistaProductos" class="hidden">
        <h3>ğŸ“¦ GestiÃ³n de Productos</h3>
        <form id="formProducto">
          <input type="text" id="prodNombre" placeholder="Nombre" required>
          <input type="number" id="prodPrecio" placeholder="Precio" required>
          <input type="number" id="prodStock" placeholder="Stock inicial" required>
          <button type="submit">Agregar Producto</button>
        </form>
        <table>
          <thead><tr><th>Nombre</th><th>Precio</th><th>Stock</th></tr></thead>
          <tbody id="tablaProductos"></tbody>
        </table>
      </div>

      <!-- Inventario -->
      <div id="vistaInventario" class="hidden">
        <h3>ğŸ“Š Movimientos de Inventario</h3>
        <form id="formEntrada">
          <input type="text" id="invProducto" placeholder="Producto ID" required>
          <input type="number" id="invCantidad" placeholder="Cantidad" required>
          <button type="submit">Registrar Entrada</button>
        </form>
        <table>
          <thead><tr><th>Producto</th><th>Cantidad</th><th>Fecha</th></tr></thead>
          <tbody id="tablaInventario"></tbody>
        </table>
      </div>

      <!-- Reportes -->
      <div id="vistaReportes" class="hidden">
        <h3>ğŸ“‘ Reporte Diario</h3>
        <button onclick="cargarReporte()">Cargar Reporte</button>
        <div id="reporteContenido"></div>
      </div>

      <!-- Ventas -->
      <div id="vistaVentas" class="hidden">
        <h3>ğŸ›’ Registrar Venta</h3>
        <form id="formVenta">
          <select id="ventaProducto"></select>
          <input type="number" id="ventaCantidad" placeholder="Cantidad" required>
          <button type="submit">Agregar al Carrito</button>
        </form>
        <h4>Carrito</h4>
        <ul id="carrito"></ul>
        <button onclick="finalizarVenta()">Finalizar Venta</button>
      </div>

      <!-- Caja -->
      <div id="vistaCaja" class="hidden">
        <h3>ğŸ’µ Caja</h3>
        <form id="formCaja">
          <input type="number" id="cajaMonto" placeholder="Monto" required>
          <select id="cajaTipo">
            <option value="ingreso">Ingreso</option>
            <option value="egreso">Egreso</option>
          </select>
          <button type="submit">Registrar Movimiento</button>
        </form>
        <table>
          <thead><tr><th>Tipo</th><th>Monto</th><th>Fecha</th></tr></thead>
          <tbody id="tablaCaja"></tbody>
        </table>
      </div>
    </div>
    <button class="logout" id="btnLogout">Cerrar sesiÃ³n</button>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    // ğŸ”¹ Configura tu proyecto Supabase
    const SUPABASE_URL = "https://jmawangtuojrogjwhqwu.supabase.co";
    const SUPABASE_ANON_KEY = "TU_ANON_KEY_AQUI";  // pon tu Anon Key real
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Estado global
    let carrito = [];

    // Botones login/logout
    document.getElementById("btnLogin").addEventListener("click", login);
    document.getElementById("btnLogout").addEventListener("click", logout);

    // ğŸ”¹ Login
    async function login() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      const resultado = document.getElementById("resultado");

      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) { resultado.innerHTML = "âŒ Error: " + error.message; return; }
      cargarPerfil(data.user.id);
    }

    // ğŸ”¹ Cargar perfil
    async function cargarPerfil(userId) {
      const { data, error } = await supabase
        .from("profiles").select("nombre, rol_id, rol:rol_id(nombre)")
        .eq("user_id", userId).single();

      if (error || !data) return;

      document.getElementById("loginBox").classList.add("hidden");
      document.getElementById("dashboard").classList.remove("hidden");
      document.getElementById("userTitle").innerText = "ğŸ‘¤ " + data.nombre;
      document.getElementById("userRole").innerText = "Rol: " + data.rol.nombre;

      const menu = document.getElementById("menuOpciones");
      menu.innerHTML = "";
      if (data.rol.nombre === "admin") {
        menu.innerHTML += "<button onclick='abrirVista(\"vistaProductos\")'>ğŸ“¦ Productos</button>";
        menu.innerHTML += "<button onclick='abrirVista(\"vistaInventario\")'>ğŸ“Š Inventario</button>";
        menu.innerHTML += "<button onclick='abrirVista(\"vistaReportes\")'>ğŸ“‘ Reportes</button>";
      } else {
        menu.innerHTML += "<button onclick='abrirVista(\"vistaVentas\")'>ğŸ›’ Ventas</button>";
        menu.innerHTML += "<button onclick='abrirVista(\"vistaCaja\")'>ğŸ’µ Caja</button>";
      }
    }

    // ğŸ”¹ Logout
    async function logout() {
      await supabase.auth.signOut();
      document.getElementById("dashboard").classList.add("hidden");
      document.getElementById("loginBox").classList.remove("hidden");
      document.getElementById("resultado").innerHTML = "ğŸ‘‹ SesiÃ³n cerrada.";
    }

    // ğŸ”¹ Cambiar vistas
    window.abrirVista = function(idVista) {
      document.querySelectorAll("#vistas > div").forEach(div => div.classList.add("hidden"));
      document.getElementById(idVista).classList.remove("hidden");
      if (idVista === "vistaProductos") cargarProductos();
      if (idVista === "vistaInventario") cargarInventario();
      if (idVista === "vistaVentas") cargarProductosVenta();
      if (idVista === "vistaCaja") cargarCaja();
    }

    // ğŸ“¦ Productos
    async function cargarProductos() {
      const { data, error } = await supabase.from("productos").select("*");
      if (error) return;
      const tabla = document.getElementById("tablaProductos");
      tabla.innerHTML = "";
      data.forEach(p => tabla.innerHTML += `<tr><td>${p.nombre}</td><td>$${p.precio}</td><td>${p.stock}</td></tr>`);
    }

    document.getElementById("formProducto").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const nombre = document.getElementById("prodNombre").value;
      const precio = parseFloat(document.getElementById("prodPrecio").value);
      const stock = parseInt(document.getElementById("prodStock").value);
      await supabase.from("productos").insert([{ nombre, precio, stock }]);
      cargarProductos();
      e.target.reset();
    });

    // ğŸ“Š Inventario
    async function cargarInventario() {
      const { data } = await supabase.from("inventario_movimientos").select("*");
      const tabla = document.getElementById("tablaInventario");
      tabla.innerHTML = "";
      data.forEach(m => tabla.innerHTML += `<tr><td>${m.producto_id}</td><td>${m.cantidad}</td><td>${m.fecha}</td></tr>`);
    }

    document.getElementById("formEntrada").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const producto = document.getElementById("invProducto").value;
      const cantidad = parseInt(document.getElementById("invCantidad").value);
      await supabase.from("inventario_movimientos").insert([{ producto_id: producto, cantidad }]);
      cargarInventario();
      e.target.reset();
    });

    // ğŸ“‘ Reportes
    async function cargarReporte() {
      const { data, error } = await supabase.rpc("reporte_diario");
      if (error) { alert("Error: "+error.message); return; }
      document.getElementById("reporteContenido").innerText = JSON.stringify(data,null,2);
    }

    // ğŸ›’ Ventas
    async function cargarProductosVenta() {
      const { data } = await supabase.from("productos").select("*");
      const select = document.getElementById("ventaProducto");
      select.innerHTML = "";
      data.forEach(p => select.innerHTML += `<option value="${p.id}">${p.nombre} ($${p.precio})</option>`);
    }

    document.getElementById("formVenta").addEventListener("submit", (e)=>{
      e.preventDefault();
      const prodId = document.getElementById("ventaProducto").value;
      const cantidad = parseInt(document.getElementById("ventaCantidad").value);
      carrito.push({ id: prodId, cantidad });
      renderCarrito();
      e.target.reset();
    });

    function renderCarrito() {
      const ul = document.getElementById("carrito");
      ul.innerHTML = "";
      carrito.forEach((c,i)=> ul.innerHTML += `<li>${c.id} x ${c.cantidad}</li>`);
    }

    async function finalizarVenta() {
      if (carrito.length === 0) return alert("Carrito vacÃ­o");
      await supabase.from("ventas").insert([{ fecha:new Date() }]);
      alert("âœ… Venta registrada");
      carrito = [];
      renderCarrito();
    }

    // ğŸ’µ Caja
    async function cargarCaja() {
      const { data } = await supabase.from("caja_movimientos").select("*");
      const tabla = document.getElementById("tablaCaja");
      tabla.innerHTML = "";
      data.forEach(m => tabla.innerHTML += `<tr><td>${m.tipo}</td><td>${m.monto}</td><td>${m.fecha}</td></tr>`);
    }

    document.getElementById("formCaja").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const monto = parseFloat(document.getElementById("cajaMonto").value);
      const tipo = document.getElementById("cajaTipo").value;
      await supabase.from("caja_movimientos").insert([{ monto, tipo }]);
      cargarCaja();
      e.target.reset();
    });
  </script>
</body>
</html>
