<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>POS Tiendita</title>
  <style>
    :root {
      --green:#4caf50;
      --greenD:#2e7d32;
      --blue:#1e88e5;
      --blueD:#155fa5;
      --red:#c62828;
      --bg:#f5f7fb;
      --card:#ffffff;
      --border:#e1e4ea;
      --text:#1c2533;
      --muted:#5f6b7a;
    }
    * { box-sizing:border-box; }
    body{
      margin:0;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      background:radial-gradient(circle at top,var(--green),var(--greenD));
      color:var(--text);
    }
    .card{
      width:100%;
      max-width:1100px;
      background:var(--card);
      border-radius:18px;
      padding:24px 24px 20px;
      box-shadow:0 24px 60px rgba(0,0,0,.30);
      animation:fade .35s ease;
    }
    h2{margin:0 0 4px;text-align:center}
    h3{margin:12px 0 10px;}
    h4{margin:10px 0 6px;}
    input,select,button{font-size:15px;}
    input,select{
      width:100%;
      padding:10px 12px;
      margin:4px 0;
      border-radius:10px;
      border:1px solid var(--border);
      background:#fff;
    }
    input:focus,select:focus{
      outline:none;
      border-color:var(--blue);
      box-shadow:0 0 0 1px rgba(30,136,229,.25);
    }
    button{
      padding:10px 14px;
      border-radius:999px;
      border:0;
      font-weight:700;
      cursor:pointer;
      background:var(--green);
      color:#fff;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      white-space:nowrap;
    }
    button.secondary{background:var(--blue);}
    button.secondary:hover{background:var(--blueD);}
    button.destructive{background:var(--red);}
    button.ghost{
      background:#e9eef8;
      color:var(--text);
    }
    button.ghost:hover{background:#dde4f3;}
    button:hover{filter:brightness(.97);}
    .menu{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin:14px 0 0;
    }
    .menu button{
      border-radius:12px;
      padding-inline:16px;
    }
    .grid{display:grid;gap:10px;}
    .col2{grid-template-columns:1fr 1fr;}
    .col3{grid-template-columns:1fr 1fr 1fr;}
    @media(max-width:860px){
      .col2,.col3{grid-template-columns:1fr;}
    }
    table{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      font-size:14px;
      background:#fff;
    }
    th,td{
      border:1px solid #eef1f6;
      padding:6px 6px;
      text-align:center;
    }
    th{
      background:#f7f9fe;
      font-weight:600;
    }
    .muted{color:var(--muted);font-size:13px;}
    .hidden{display:none;}
    #resultado{min-height:22px;margin-top:8px;}
    .ok{color:var(--greenD);font-weight:700;}
    .warn{color:var(--red);font-weight:700;}
    .low{background:#fff1f1;}
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      background:#ecf3ff;
      color:#0c3a94;
    }
    .pill span{font-weight:600;}
    .badge-role{
      font-size:11px;
      padding:2px 6px;
      border-radius:999px;
      background:#ffe082;
      color:#6d4c00;
    }
    .scan-flash{animation:flash .25s ease-in-out;}
    @keyframes flash{from{background:#fff59d;}to{background:transparent;}}
    @keyframes fade{from{opacity:0;transform:translateY(-6px);}to{opacity:1;transform:none;}}
    .section{
      margin-top:14px;
      background:var(--bg);
      border-radius:14px;
      padding:14px 14px 12px;
    }
    video{
      width:100%;
      max-height:240px;
      border-radius:12px;
      background:#000;
      margin-top:6px;
    }
    pre.json{
      background:#0b1020;
      color:#c4d0ff;
      padding:12px;
      border-radius:10px;
      overflow:auto;
      white-space:pre-wrap;
      font-size:13px;
    }
    .flex-between{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .small-label{
      font-size:12px;
      font-weight:600;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.04em;
    }
    .ticket-preview{
      font-family:monospace;
      font-size:13px;
      background:#fff;
      padding:12px;
      border-radius:10px;
      border:1px dashed #bbb;
    }
    .kpi-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:8px;
    }
    .kpi{
      flex:1 1 140px;
      background:#fff;
      border-radius:10px;
      padding:8px 10px;
      border:1px solid #e2e6f0;
    }
    .kpi-title{
      font-size:11px;
      text-transform:uppercase;
      color:var(--muted);
    }
    .kpi-value{
      margin-top:4px;
      font-size:16px;
      font-weight:700;
    }
  </style>
</head>
<body>
  <div class="card">
    <h2>POS Tiendita</h2>
    <div class="muted" style="text-align:center;margin-bottom:10px;">Versi√≥n ULTRA ‚Äì Proyecto Escolar</div>

    <!-- LOGIN -->
    <div id="loginBox">
      <div class="grid col2">
        <input id="email" type="email" placeholder="Correo" autocomplete="username" />
        <input id="password" type="password" placeholder="Contrase√±a" autocomplete="current-password" />
      </div>
      <div class="grid col2" style="margin-top:6px;">
        <button id="btnLogin" class="secondary">Iniciar sesi√≥n</button>
        <div class="muted" style="display:flex;align-items:center;justify-content:flex-end;">Uso acad√©mico ‚Äì Supabase ¬∑ Vercel</div>
      </div>
      <div id="resultado" class="muted">Listo para iniciar sesi√≥n‚Ä¶</div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" class="hidden">
      <div class="grid col2" style="align-items:center;">
        <div>
          <div id="userTitle" class="pill">üë§ <span>‚Äî</span></div>
          <div id="userRole" class="muted">Rol: ‚Äî</div>
        </div>
        <div style="text-align:right;">
          <button id="btnLogout" class="destructive">Cerrar sesi√≥n</button>
        </div>
      </div>

      <div class="menu" id="menuOpciones"></div>

      <div id="vistas" style="margin-top:14px;">
        <!-- PRODUCTOS -->
        <div id="vistaProductos" class="hidden section">
          <div class="flex-between">
            <h3>üì¶ Gesti√≥n de Productos</h3>
            <span class="small-label">Cat√°logo maestro</span>
          </div>
          <form id="formProducto" class="grid col3">
            <input id="prodNombre" type="text" placeholder="Nombre del producto" required />
            <input id="prodPrecio" type="number" step="0.01" placeholder="Precio" required />
            <input id="prodStock" type="number" placeholder="Stock inicial" required />
            <div class="grid col3" style="grid-column:1 / -1;gap:8px;">
              <input id="prodCodigo" type="text" placeholder="C√≥digo de barras (opcional)" />
              <button type="button" id="btnScanProducto" class="ghost">üì∑ Escanear c√≥digo</button>
              <button type="submit" class="secondary">Guardar / Actualizar</button>
            </div>
          </form>
          <video id="previewProd" autoplay muted playsinline class="hidden"></video>

          <div style="margin-top:10px" class="grid col2">
            <div>
              <div class="small-label">Carga r√°pida v√≠a CSV</div>
              <input id="csvFile" type="file" accept=".csv" />
              <button id="btnImport" class="ghost" type="button">Importar CSV</button>
              <div class="muted">Formato: <code>nombre,precio,stock,codigo_barras</code></div>
            </div>
            <div style="text-align:right;">
              <span class="pill">üîî Alerta stock &lt; stock_minimo</span>
            </div>
          </div>

          <table>
            <thead><tr><th>ID</th><th>Nombre</th><th>Precio</th><th>Stock</th><th>M√≠n.</th><th>C√≥digo</th></tr></thead>
            <tbody id="tablaProductos"></tbody>
          </table>
        </div>

        <!-- INVENTARIO -->
        <div id="vistaInventario" class="hidden section">
          <div class="flex-between">
            <h3>üìä Movimientos de Inventario</h3>
            <span class="small-label">Entradas por c√≥digo de barras</span>
          </div>
          <form id="formEntrada" class="grid col3">
            <input id="invCodigo" type="text" placeholder="C√≥digo de barras" required />
            <input id="invCantidad" type="number" placeholder="Cantidad" required />
            <button type="submit" class="secondary">Registrar Entrada</button>
          </form>
          <table>
            <thead><tr><th>Producto</th><th>C√≥digo</th><th>Tipo</th><th>Cantidad</th><th>Fecha</th><th>Motivo</th></tr></thead>
            <tbody id="tablaInventario"></tbody>
          </table>
        </div>

        <!-- REPORTES -->
        <div id="vistaReportes" class="hidden section">
          <div class="flex-between">
            <h3>üìë Reporte Diario</h3>
            <span class="small-label">Corte por d√≠a calendario</span>
          </div>
          <div class="grid col3">
            <button id="btnCargarReporte" class="secondary" type="button">Actualizar reporte de hoy</button>
            <button id="btnCerrarDia" class="ghost" type="button">üßæ Cerrar d√≠a (corte imprimible)</button>
            <div class="muted" style="display:flex;align-items:center;">Basado en ventas registradas en la tabla <code>ventas</code>.</div>
          </div>
          <div id="resumenKPIs" class="kpi-row"></div>
          <pre id="reporteContenido" class="json" style="margin-top:10px;"></pre>
        </div>

        <!-- VENTAS -->
        <div id="vistaVentas" class="hidden section">
          <div class="flex-between">
            <h3>üõí Registrar Venta</h3>
            <span class="small-label">Esc√°ner + efectivo + ticket</span>
          </div>

          <!-- Buscar por c√≥digo + escanear -->
          <div class="grid col3">
            <input id="codigoBarras" type="text" placeholder="C√≥digo de barras" />
            <button id="btnBuscarCodigo" class="ghost" type="button">Buscar / Agregar</button>
            <button id="btnStartScanner" class="ghost" type="button">üì∑ Escanear con c√°mara</button>
          </div>
          <video id="preview" autoplay muted playsinline class="hidden"></video>

          <!-- Selecci√≥n manual -->
          <form id="formVenta" class="grid col3" style="margin-top:10px;">
            <select id="ventaProducto"></select>
            <input id="ventaCantidad" type="number" placeholder="Cantidad" required />
            <button type="submit" class="secondary">Agregar al Carrito</button>
          </form>

          <h4 style="margin:12px 0 6px;">Carrito</h4>
          <table>
            <thead><tr><th>Producto</th><th>Cant</th><th>Precio</th><th>Subtotal</th></tr></thead>
            <tbody id="tablaCarrito"></tbody>
          </table>

          <div class="grid col3" style="align-items:center;margin-top:10px;">
            <div>
              <div class="muted">Total:</div>
              <div style="font-weight:800;font-size:18px;">$<span id="totalVenta">0.00</span></div>
            </div>
            <div>
              <label class="muted">Efectivo recibido</label>
              <input id="pagoEfectivo" type="number" step="0.01" placeholder="Ej. 200" />
              <div class="muted">Cambio: <strong>$<span id="cambioTexto">0.00</span></strong></div>
            </div>
            <div style="text-align:right;">
              <button id="btnFinalizarVenta" type="button">Finalizar Venta</button>
              <button id="btnImprimir" class="ghost" type="button">üñ®Ô∏è Imprimir Ticket actual</button>
            </div>
          </div>

          <div id="ticketPreview" class="ticket-preview" style="margin-top:10px;display:none;"></div>
        </div>

        <!-- CAJA -->
        <div id="vistaCaja" class="hidden section">
          <div class="flex-between">
            <h3>üíµ Caja</h3>
            <span class="small-label">Movimientos manuales + apoyo de cambio</span>
          </div>
          <div class="grid col3">
            <div>
              <form id="formCaja" class="grid col3">
                <input id="cajaMonto" type="number" step="0.01" placeholder="Monto" required />
                <select id="cajaTipo">
                  <option value="ingreso">Ingreso (a√±adir a caja)</option>
                  <option value="egreso">Egreso (retiro)</option>
                </select>
                <button type="submit" class="secondary">Registrar movimiento</button>
              </form>
              <div class="muted" style="margin-top:4px;">Las ventas registran un ingreso autom√°tico de tipo <code>venta</code>.</div>
            </div>
            <div>
              <div class="small-label">Calculadora r√°pida de cambio</div>
              <input id="calcTotal" type="number" step="0.01" placeholder="Total de la compra" />
              <input id="calcEfectivo" type="number" step="0.01" placeholder="Efectivo recibido" />
              <div class="muted">Cambio sugerido: <strong>$<span id="calcCambio">0.00</span></strong></div>
            </div>
            <div class="muted" style="display:flex;align-items:center;">
              Usa esta secci√≥n para dep√≥sitos, retiros y cortes parciales de caja.
            </div>
          </div>
          <table>
            <thead><tr><th>Tipo</th><th>Monto</th><th>Fecha</th></tr></thead>
            <tbody id="tablaCaja"></tbody>
          </table>
        </div>

        <!-- HISTORIAL -->
        <div id="vistaHistorial" class="hidden section">
          <div class="flex-between">
            <h3>üßæ Historial de Ventas</h3>
            <span class="small-label">Detalle por ticket</span>
          </div>
          <table>
            <thead>
              <tr><th>ID</th><th>Fecha</th><th>Detalle</th><th>Total aprox.</th></tr>
            </thead>
            <tbody id="tablaHistorial"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- SCRIPT -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const SUPABASE_URL = 'https://gnguvdqdhqrupkkrtdmp.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImduZ3V2ZHFkaHFydXBra3J0ZG1wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3NjEwNTIsImV4cCI6MjA3NTMzNzA1Mn0.a5XbjmM5eyREKI1j0HrZe36Gz52SAz0_3_jzjW8bYo0';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let carrito = [];
    let productosCache = new Map();
    let currentUser = null;

    const $  = (id)=>document.getElementById(id);
    const peso = (n)=> Number(n ?? 0).toFixed(2);

    // Sonido tipo "bip" de supermercado
    const beepAudio = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
    const scanAudio = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
    function beep(){ try{ beepAudio.currentTime=0; beepAudio.play(); }catch{} }
    function bipScan(){ try{ scanAudio.currentTime=0; scanAudio.play(); }catch{} }

    // ---------- LOGIN ----------
    $('btnLogin').addEventListener('click', async ()=>{
      const email = $('email').value.trim();
      const password = $('password').value.trim();
      const out = $('resultado');
      if (!email || !password) {
        out.innerHTML = '<span class="warn">Ingresa correo y contrase√±a</span>';
        return;
      }
      out.textContent = 'Iniciando‚Ä¶';
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) { out.innerHTML = `<span class="warn">${error.message}</span>`; return; }
      currentUser = data.user;
      out.innerHTML = '<span class="ok">Login OK</span>';
      await cargarPerfil(data.user.id);
    });

    $('btnLogout').addEventListener('click', async ()=>{
      await supabase.auth.signOut();
      currentUser = null;
      $('dashboard').classList.add('hidden');
      $('loginBox').classList.remove('hidden');
      $('resultado').textContent = 'üëã Sesi√≥n cerrada.';
    });

    async function cargarPerfil(uid){
      const { data, error } = await supabase
        .from('profiles')
        .select('nombre, rol_id, rol:rol_id(nombre)')
        .eq('user_id', uid)
        .single();

      if (error || !data) {
        $('resultado').innerHTML = '<span class="warn">No se encontr√≥ perfil en tabla profiles</span>';
        return;
      }

      $('loginBox').classList.add('hidden');
      $('dashboard').classList.remove('hidden');
      $('userTitle').innerHTML = `üë§ <span>${data.nombre}</span>`;
      $('userRole').innerHTML  = `Rol: <span class="badge-role">${data.rol?.nombre ?? '‚Äî'}</span>`;

      const menu = $('menuOpciones');
      menu.innerHTML = '';
      if (data.rol?.nombre === 'admin') {
        menu.innerHTML += `<button class="secondary" data-v="vistaVentas">üõí Ventas</button>`;
        menu.innerHTML += `<button class="secondary" data-v="vistaCaja">üíµ Caja</button>`;
        menu.innerHTML += `<button class="secondary" data-v="vistaHistorial">üßæ Historial</button>`;
        menu.innerHTML += `<button class="secondary" data-v="vistaReportes">üìë Reportes</button>`;
        menu.innerHTML += `<button class="secondary" data-v="vistaInventario">üìä Inventario</button>`;
        menu.innerHTML += `<button class="secondary" data-v="vistaProductos">üì¶ Productos</button>`;
      } else {
        menu.innerHTML += `<button class="secondary" data-v="vistaVentas">üõí Ventas</button>`;
        menu.innerHTML += `<button class="secondary" data-v="vistaCaja">üíµ Caja</button>`;
        menu.innerHTML += `<button class="secondary" data-v="vistaHistorial">üßæ Historial</button>`;
        menu.innerHTML += `<button class="secondary" data-v="vistaReportes">üìë Reportes</button>`;
      }
      menu.querySelectorAll('button').forEach(b=> b.addEventListener('click', ()=> abrirVista(b.dataset.v)));
      abrirVista('vistaVentas');
    }

    function abrirVista(id){
      document.querySelectorAll('#vistas > div').forEach(d=>d.classList.add('hidden'));
      const el = $(id); if (!el) return;
      el.classList.remove('hidden');
      if (id==='vistaProductos')  cargarProductos();
      if (id==='vistaInventario') cargarInventario();
      if (id==='vistaVentas')     cargarProductosVenta();
      if (id==='vistaCaja')       cargarCaja();
      if (id==='vistaHistorial')  cargarHistorial();
      if (id==='vistaReportes')   cargarReporte();
    }

    // ==================== PRODUCTOS ====================
    async function cargarProductos(){
      const { data, error } = await supabase.from('productos').select('*').order('id');
      if (error) { console.error(error); return; }
      productosCache.clear();
      $('tablaProductos').innerHTML = (data || []).map(p=>{
        productosCache.set(p.id, p);
        const low = (p.stock < (p.stock_minimo ?? 5)) ? 'low' : '';
        return `<tr class="${low}">
          <td>${p.id}</td>
          <td>${p.nombre}</td>
          <td>$${peso(p.precio)}</td>
          <td>${p.stock}</td>
          <td>${p.stock_minimo ?? '-'}</td>
          <td>${p.codigo_barras || ''}</td>
        </tr>`;
      }).join('');
    }

    $('formProducto').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const nombre = $('prodNombre').value.trim();
      const precio = parseFloat($('prodPrecio').value);
      const stock  = parseInt($('prodStock').value || '0', 10);
      const codigo = $('prodCodigo').value.trim() || null;
      if (!nombre || isNaN(precio)) { alert('Completa nombre y precio'); return; }

      try {
        if (codigo) {
          const { error } = await supabase.rpc('upsert_producto_por_codigo', {
            p_nombre: nombre,
            p_precio: precio,
            p_codigo: codigo,
            p_stock_inicial: stock
          });
          if (error) throw error;
        } else {
          const { error } = await supabase.from('productos').insert({
            nombre,
            precio,
            stock
          });
          if (error) throw error;
        }
        e.target.reset();
        await cargarProductos();
        alert('‚úÖ Producto guardado');
      } catch(err) {
        alert('Error guardando producto: ' + err.message);
      }
    });

    $('btnImport').addEventListener('click', ()=>{
      const f = $('csvFile').files?.[0];
      if (!f) return alert('Selecciona un archivo CSV');
      const r = new FileReader();
      r.onload = async ()=>{
        const rows = String(r.result).split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
        for (const line of rows) {
          const [nombre,precio,stock,codigo] = line.split(',').map(x=>x?.trim());
          if (!nombre || !precio) continue;
          try {
            if (codigo) {
              await supabase.rpc('upsert_producto_por_codigo', {
                p_nombre: nombre,
                p_precio: parseFloat(precio),
                p_codigo: codigo,
                p_stock_inicial: parseInt(stock || '0', 10)
              });
            } else {
              await supabase.from('productos').insert({
                nombre,
                precio: parseFloat(precio),
                stock: parseInt(stock || '0', 10)
              });
            }
          } catch(e) { console.error(e); }
        }
        await cargarProductos();
        alert('‚úÖ Importaci√≥n terminada');
      };
      r.readAsText(f);
    });

    // Esc√°ner para alta de productos
    let prodStream = null;
    let prodDetector = null;
    let prodScanning = false;

    $('btnScanProducto').addEventListener('click', async ()=>{
      if (prodScanning) { stopScanProd(); return; }
      if (!('BarcodeDetector' in window)) {
        alert('Tu navegador no soporta escaneo nativo. Usa lector USB como teclado.');
        return;
      }
      const video = $('previewProd');
      video.classList.remove('hidden');
      prodStream = await navigator.mediaDevices.getUserMedia({
        video:{ facingMode:{ ideal:'environment' } }, audio:false
      });
      video.srcObject = prodStream;
      prodDetector = new window.BarcodeDetector({ formats:['ean_13','ean_8','upc_a','code_128'] });
      prodScanning = true;
      scanProdLoop(video);
    });

    function stopScanProd(){
      prodScanning = false;
      if (prodStream) { prodStream.getTracks().forEach(t=>t.stop()); prodStream = null; }
      $('previewProd').classList.add('hidden');
    }

    async function scanProdLoop(video){
      while (prodScanning && prodDetector) {
        try {
          if (!video.videoWidth) { await new Promise(r=>setTimeout(r,150)); continue; }
          const canvas = document.createElement('canvas');
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          canvas.getContext('2d').drawImage(video,0,0,canvas.width,canvas.height);
          const bmp = await createImageBitmap(canvas);
          const codes = await prodDetector.detect(bmp);
          if (codes && codes.length) {
            const code = String(codes[0].rawValue || '');
            if (code) {
              $('prodCodigo').value = code;
              bipScan();
              stopScanProd();
              break;
            }
          }
        } catch(e) { console.error(e); }
        await new Promise(r=>setTimeout(r,200));
      }
    }

    // ==================== VENTAS ====================
    async function cargarProductosVenta(){
      const { data, error } = await supabase
        .from('productos')
        .select('id,nombre,precio,stock,codigo_barras')
        .order('nombre');
      if (error) { console.error(error); return; }
      const sel = $('ventaProducto');
      sel.innerHTML = '';
      productosCache.clear();
      for (const p of (data || [])) {
        productosCache.set(p.id, p);
        sel.innerHTML += `<option value="${p.id}">
          ${p.nombre} ($${peso(p.precio)}) ‚Äî ${p.stock} en stock
        </option>`;
      }
      carrito = [];
      renderCarrito();
    }

    $('btnBuscarCodigo').addEventListener('click', async ()=>{
      const code = $('codigoBarras').value.trim();
      if (!code) return;
      await buscarYAgregarPorCodigo(code);
      $('codigoBarras').value = '';
    });

    async function buscarYAgregarPorCodigo(code){
      let found = null;
      try {
        const rpc = await supabase.rpc('buscar_producto_por_codigo', { p_codigo: code });
        if (!rpc.error && rpc.data && rpc.data.length) {
          found = rpc.data[0];
        }
      } catch(e) { console.error(e); }

      if (!found) {
        const { data } = await supabase
          .from('productos')
          .select('id,nombre,precio,stock,codigo_barras')
          .eq('codigo_barras', code)
          .maybeSingle();
        if (data) found = data;
      }

      if (!found) {
        alert('No se encontr√≥ el producto para ese c√≥digo');
        return;
      }
      addToCartFromProduct(found, 1);
      const lastRow = $('tablaCarrito').lastElementChild;
      if (lastRow) lastRow.classList.add('scan-flash');
      bipScan();
    }

    $('formVenta').addEventListener('submit', (e)=>{
      e.preventDefault();
      const id = parseInt($('ventaProducto').value,10);
      const cant = parseInt($('ventaCantidad').value,10);
      const p = productosCache.get(id);
      if (!p) { alert('Producto inexistente (cache). Recarga la p√°gina.'); return; }
      addToCartFromProduct(p, cant);
      e.target.reset();
    });

    function addToCartFromProduct(p, cantidad){
      if (!p || !cantidad || cantidad <= 0) return;
      const ya = carrito.find(x=>x.id === p.id);
      const enCarrito = ya ? ya.cantidad : 0;
      if (p.stock != null && (cantidad + enCarrito) > p.stock) {
        alert(`Solo hay ${p.stock} unidades de "${p.nombre}" en stock`);
        return;
      }
      if (ya) ya.cantidad += cantidad;
      else carrito.push({
        id: p.id,
        nombre: p.nombre,
        cantidad,
        precio: Number(p.precio ?? 0)
      });
      renderCarrito();
    }

    function renderCarrito(){
      $('tablaCarrito').innerHTML = carrito.map(c=>`
        <tr>
          <td>${c.nombre}</td>
          <td>${c.cantidad}</td>
          <td>$${peso(c.precio)}</td>
          <td>$${peso(c.cantidad * c.precio)}</td>
        </tr>
      `).join('');
      const total = carrito.reduce((s,c)=> s + c.cantidad * c.precio, 0);
      $('totalVenta').textContent = peso(total);
      actualizarCambio();
      actualizarPreviewTicket();
    }

    $('pagoEfectivo').addEventListener('input', actualizarCambio);
    function actualizarCambio(){
      const total = parseFloat($('totalVenta').textContent) || 0;
      const pago  = parseFloat($('pagoEfectivo').value || '0');
      const cambio = pago - total;
      $('cambioTexto').textContent = peso(cambio > 0 ? cambio : 0);
    }

    // Esc√°ner para ventas
    let ventaStream = null;
    let ventaDetector = null;
    let ventaScanning = false;

    $('btnStartScanner').addEventListener('click', async ()=>{
      if (ventaScanning) { stopScannerVentas(); return; }
      if (!('BarcodeDetector' in window)) {
        alert('Tu navegador no soporta escaneo nativo. Tambi√©n puedes usar lector USB como teclado.');
        return;
      }
      const video = $('preview');
      video.classList.remove('hidden');
      ventaStream = await navigator.mediaDevices.getUserMedia({
        video:{ facingMode:{ ideal:'environment' } }, audio:false
      });
      video.srcObject = ventaStream;
      ventaDetector = new window.BarcodeDetector({ formats:['ean_13','ean_8','upc_a','code_128'] });
      ventaScanning = true;
      scanVentasLoop(video);
    });

    function stopScannerVentas(){
      ventaScanning = false;
      if (ventaStream) { ventaStream.getTracks().forEach(t=>t.stop()); ventaStream = null; }
      $('preview').classList.add('hidden');
    }

    async function scanVentasLoop(video){
      while (ventaScanning && ventaDetector) {
        try {
          if (!video.videoWidth) { await new Promise(r=>setTimeout(r,150)); continue; }
          const canvas = document.createElement('canvas');
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          canvas.getContext('2d').drawImage(video,0,0,canvas.width,canvas.height);
          const bmp = await createImageBitmap(canvas);
          const codes = await ventaDetector.detect(bmp);
          if (codes && codes.length) {
            const code = String(codes[0].rawValue || '');
            if (code) {
              stopScannerVentas();
              await buscarYAgregarPorCodigo(code);
              break;
            }
          }
        } catch(e) { console.error(e); }
        await new Promise(r=>setTimeout(r,200));
      }
    }

    // finalizar venta con ticket y caja autom√°tica
    $('btnFinalizarVenta').addEventListener('click', async ()=>{
      if (!carrito.length) return alert('Carrito vac√≠o');
      const total = carrito.reduce((s,c)=> s + c.cantidad * c.precio, 0);
      const pago  = parseFloat($('pagoEfectivo').value || '0');
      if (pago < total) {
        const ok = confirm('El efectivo es menor que el total. ¬øContinuar de todos modos?');
        if (!ok) return;
      }

      // Prevalidaci√≥n: asegurar que cada ID exista en productos (evita "Producto X inexistente")
      for (const c of carrito) {
        const { data:prodCheck } = await supabase
          .from('productos')
          .select('id')
          .eq('id', c.id)
          .maybeSingle();
        if (!prodCheck) {
          alert(`Error: el producto con ID ${c.id} ya no existe en la tabla productos.`);
          return;
        }
      }

      try {
        const { data:venta, error:errV } = await supabase
          .from('ventas')
          .insert({})
          .select('id,fecha')
          .single();
        if (errV) throw errV;

for (const c of carrito) {
  const precioUnit = Number(c.precio ?? productosCache.get(c.id)?.precio ?? 0);
  const { error } = await supabase.from('ventas_items').insert({
    venta_id: venta.id,
    producto_id: c.id,
    cantidad: c.cantidad,
    precio_unitario: precioUnit
  });
  if (error) throw error;
}


        // Movimiento autom√°tico en caja
        const { error:errCaja } = await supabase.from('caja_movimientos').insert({
          monto: total,
          tipo: 'venta'
        });
        if (errCaja) console.error('Error registrando caja:', errCaja);

        alert('‚úÖ Venta registrada (#'+venta.id+')');

        const quiereTicket = confirm('¬øDeseas imprimir el ticket de esta venta?');
        if (quiereTicket) {
          imprimirTicket(venta.id, total, pago);
        }

        carrito = [];
        $('pagoEfectivo').value = '';
        renderCarrito();
        await Promise.all([
          cargarProductosVenta(),
          cargarProductos(),
          cargarHistorial(),
          cargarCaja(),
          cargarReporte()
        ]);
      } catch(e) {
        alert('Error registrando venta: ' + e.message);
      }
    });

    // Ticket actual sin registrar venta
    $('btnImprimir').addEventListener('click', ()=>{
      const total = carrito.reduce((s,c)=> s + c.cantidad * c.precio, 0);
      const pago  = parseFloat($('pagoEfectivo').value || '0');
      imprimirTicket(null, total, pago);
    });

    function armarTextoTicket(idVenta, total, pago){
      const cambio = pago - total;
      const fecha = new Date().toLocaleString();
      const folio = idVenta ?? 'PREVIEW';
      const lineas = [];
      lineas.push('        TIENDITA ESCOLAR');
      lineas.push('       POS ‚Äì Proyecto UNITEC');
      lineas.push('--------------------------------');
      lineas.push('Fecha: ' + fecha);
      lineas.push('Folio: ' + folio);
      lineas.push('--------------------------------');
      carrito.forEach(c=>{
        const sub = c.cantidad * c.precio;
        lineas.push(`${c.nombre.slice(0,22).padEnd(22)} ${String(c.cantidad).padStart(2)} x ${peso(c.precio)} = ${peso(sub)}`);
      });
      lineas.push('--------------------------------');
      lineas.push('TOTAL:           $ ' + peso(total));
      lineas.push('EFECTIVO:        $ ' + peso(pago));
      lineas.push('CAMBIO:          $ ' + peso(cambio>0?cambio:0));
      lineas.push('--------------------------------');
      lineas.push('Gracias por su compra');
      lineas.push('   Uso acad√©mico ‚Äì demo');
      return lineas.join('\n');
    }

    function imprimirTicket(idVenta, total, pago){
      const texto = armarTextoTicket(idVenta, total, pago);
      const html = `
        <pre style="font-family:monospace;font-size:13px;">${texto}</pre>
      `;
      const w = window.open('', 'ticket');
      w.document.write(html);
      w.document.close();
      w.print();
    }

    function actualizarPreviewTicket(){
      if (!carrito.length){
        $('ticketPreview').style.display='none';
        $('ticketPreview').textContent='';
        return;
      }
      const total = carrito.reduce((s,c)=> s + c.cantidad * c.precio, 0);
      const pago  = parseFloat($('pagoEfectivo').value || '0');
      const texto = armarTextoTicket('PREVIEW', total, pago);
      $('ticketPreview').style.display='block';
      $('ticketPreview').textContent = texto;
    }

    // ==================== INVENTARIO ====================
    async function cargarInventario(){
      const { data, error } = await supabase
        .from('inventario_movimientos')
        .select('producto_id,tipo,cantidad,fecha,motivo,productos(nombre,codigo_barras)')
        .order('fecha', { ascending:false });
      if (error) { console.error(error); return; }
      $('tablaInventario').innerHTML = (data || []).map(m=>`
        <tr>
          <td>${m.productos?.nombre || m.producto_id}</td>
          <td>${m.productos?.codigo_barras || ''}</td>
          <td>${m.tipo || ''}</td>
          <td>${m.cantidad}</td>
          <td>${m.fecha ? new Date(m.fecha).toLocaleString() : ''}</td>
          <td>${m.motivo || ''}</td>
        </tr>
      `).join('');
    }

    $('formEntrada').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const codigo   = $('invCodigo').value.trim();
      const cantidad = parseInt($('invCantidad').value,10);
      if (!codigo || !cantidad) { alert('Completa c√≥digo y cantidad'); return; }

      // buscar producto por c√≥digo
      const { data:prod, error:errProd } = await supabase
        .from('productos')
        .select('id')
        .eq('codigo_barras', codigo)
        .maybeSingle();
      if (errProd) { alert('Error buscando producto: '+errProd.message); return; }
      if (!prod) { alert('No se encontr√≥ producto con ese c√≥digo.'); return; }

      try {
        const { error } = await supabase.from('inventario_movimientos').insert({
          producto_id: prod.id,
          tipo: 'ENTRADA',
          cantidad,
          motivo: 'Entrada manual'
        });
        if (error) throw error;

        // Actualiza stock por si no lo maneja trigger
        await supabase.rpc('ajustar_stock_por_entrada', {
          p_producto_id: prod.id,
          p_cantidad: cantidad
        }).catch(()=>{ /* si no existe la rpc, no pasa nada */ });

        e.target.reset();
        await Promise.all([cargarInventario(), cargarProductos(), cargarProductosVenta()]);
      } catch(err) {
        alert('Error registrando inventario: ' + err.message);
      }
    });

    // ==================== CAJA ====================
    async function cargarCaja(){
      const { data, error } = await supabase
        .from('caja_movimientos')
        .select('*')
        .order('fecha', { ascending:false });
      if (error) { console.error(error); return; }
      $('tablaCaja').innerHTML = (data || []).map(c=>`
        <tr>
          <td>${c.tipo}</td>
          <td>$${peso(c.monto)}</td>
          <td>${c.fecha ? new Date(c.fecha).toLocaleString() : ''}</td>
        </tr>
      `).join('');
    }

    $('formCaja').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const monto = parseFloat($('cajaMonto').value);
      const tipo  = $('cajaTipo').value;
      if (!monto || isNaN(monto)) { alert('Monto inv√°lido'); return; }
      try {
        const { error } = await supabase.from('caja_movimientos').insert({
          monto,
          tipo
        });
        if (error) throw error;
        e.target.reset();
        await cargarCaja();
      } catch(err) {
        alert('Error registrando caja: ' + err.message);
      }
    });

    // calculadora de cambio en caja
    $('calcTotal').addEventListener('input', calcCambioCaja);
    $('calcEfectivo').addEventListener('input', calcCambioCaja);
    function calcCambioCaja(){
      const t = parseFloat($('calcTotal').value || '0');
      const e = parseFloat($('calcEfectivo').value || '0');
      const c = e - t;
      $('calcCambio').textContent = peso(c>0?c:0);
    }

    // ==================== REPORTES / HISTORIAL ====================
    $('btnCargarReporte').addEventListener('click', ()=>cargarReporte(false));
    $('btnCerrarDia').addEventListener('click', ()=>cargarReporte(true));

    async function cargarHistorial(){
      const { data, error } = await supabase
        .from('ventas')
        .select('id,fecha,ventas_items(cantidad,precio_unitario,productos(nombre))')
        .order('id', { ascending:false })
        .limit(50);
      if (error) { console.error(error); return; }
      $('tablaHistorial').innerHTML = (data || []).map(v=>{
        const detalleArr = (v.ventas_items || []).map(i=>
          `${i.productos?.nombre || '#?'} x${i.cantidad} ($${peso(i.precio_unitario)})`
        );
        const total = (v.ventas_items || []).reduce((s,i)=> s + i.cantidad * i.precio_unitario, 0);
        return `<tr>
          <td>${v.id}</td>
          <td>${v.fecha ? new Date(v.fecha).toLocaleString() : ''}</td>
          <td style="text-align:left;padding-left:6px;">${detalleArr.join(', ') || '(sin detalle)'}</td>
          <td>$${peso(total)}</td>
        </tr>`;
      }).join('');
    }

    async function cargarReporte(imprimir){
      const hoy   = new Date();
      const inicio = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate());
      const inicioIso = inicio.toISOString();

      const { data:ventas, error } = await supabase
        .from('ventas')
        .select('id,fecha,ventas_items(cantidad,precio_unitario,productos(nombre))')
        .gte('fecha', inicioIso)
        .order('id', { ascending:true });
      if (error) { console.error(error); return; }

      let totalDia = 0;
      let totalArticulos = 0;
      const productosContador = new Map();
      (ventas || []).forEach(v=>{
        (v.ventas_items || []).forEach(i=>{
          const sub = i.cantidad * i.precio_unitario;
          totalDia += sub;
          totalArticulos += i.cantidad;
          const nombre = i.productos?.nombre || 'Producto';
          productosContador.set(nombre, (productosContador.get(nombre) || 0) + i.cantidad);
        });
      });

      const top = Array.from(productosContador.entries())
        .sort((a,b)=>b[1]-a[1])
        .slice(0,5);

      // KPIs bonitos
      $('resumenKPIs').innerHTML = `
        <div class="kpi">
          <div class="kpi-title">Ventas del d√≠a</div>
          <div class="kpi-value">${ventas?.length || 0}</div>
        </div>
        <div class="kpi">
          <div class="kpi-title">Total vendido</div>
          <div class="kpi-value">$${peso(totalDia)}</div>
        </div>
        <div class="kpi">
          <div class="kpi-title">Art√≠culos vendidos</div>
          <div class="kpi-value">${totalArticulos}</div>
        </div>
        <div class="kpi">
          <div class="kpi-title">Ticket promedio</div>
          <div class="kpi-value">$${peso((ventas?.length||0)? totalDia/ventas.length : 0)}</div>
        </div>
      `;

      const reporte = {
        fecha: inicio.toISOString().slice(0,10),
        num_ventas: ventas?.length || 0,
        total_vendido: totalDia,
        articulos_vendidos: totalArticulos,
        ticket_promedio: (ventas?.length||0)? totalDia/ventas.length : 0,
        top_productos: top.map(([nombre,cant])=>({nombre,cant})),
        detalle: (ventas || []).map(v=>({
          id: v.id,
          fecha: v.fecha,
          total: (v.ventas_items || []).reduce((s,i)=> s + i.cantidad * i.precio_unitario, 0)
        }))
      };
      $('reporteContenido').textContent = JSON.stringify(reporte, null, 2);

      if (imprimir){
        const texto = [
          'CORTE DE D√çA ‚Äì TIENDITA',
          'Fecha: ' + reporte.fecha,
          '--------------------------------',
          'Ventas: ' + reporte.num_ventas,
          'Total vendido: $' + peso(reporte.total_vendido),
          'Art√≠culos vendidos: ' + reporte.articulos_vendidos,
          'Ticket promedio: $' + peso(reporte.ticket_promedio),
          '--------------------------------',
          'Top productos:'
        ];
        reporte.top_productos.forEach(p=>{
          texto.push(`- ${p.nombre} (${p.cant})`);
        });
        const w = window.open('', 'corte');
        w.document.write(`<pre style="font-family:monospace;font-size:13px;">${texto.join('\n')}</pre>`);
        w.document.close();
        w.print();
      }
    }
  </script>
</body>
</html>
