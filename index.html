<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tiendita</title>

  <style>
    :root {
      --green:#4caf50;
      --greenD:#2e7d32;
      --blue:#1e88e5;
      --red:#c62828;
      --bg:#f5f7fb;
      --card:#ffffff;
      --border:#e1e4ea;
      --text:#1a2a42;
      --muted:#5f6b7a;
    }

    * { box-sizing:border-box; margin:0; padding:0 }

    body {
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:linear-gradient(135deg,var(--green),var(--greenD));
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
      color:var(--text);
    }

    .card {
      width:100%;
      max-width:1100px;
      background:var(--card);
      border-radius:18px;
      padding:24px 24px 18px;
      box-shadow:0 20px 48px rgba(0,0,0,.25);
      animation:fade .35s ease;
    }

    h2 { margin-bottom:4px; text-align:center }
    h3 { margin:12px 0 }
    h4 { margin:8px 0 }

    input,select,button { font-size:15px }
    input,select {
      width:100%;
      padding:10px 12px;
      margin:4px 0;
      border-radius:10px;
      border:1px solid var(--border);
      background:#fff;
    }

    button {
      padding:10px 14px;
      border-radius:10px;
      border:0;
      font-weight:700;
      cursor:pointer;
      background:var(--green);
      color:#fff;
    }

    button.secondary { background:var(--blue) }
    button.destructive { background:var(--red) }
    button.ghost { background:#e9eef8; color:var(--text) }
    button:disabled { opacity:.6; cursor:not-allowed }
    button:hover:not(:disabled) { filter:brightness(.96) }

    .grid { display:grid; gap:10px }
    .col2 { grid-template-columns:1fr 1fr }
    .col3 { grid-template-columns:1fr 1fr 1fr }

    .menu {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin:14px 0 4px;
    }
    .menu button{
      background:var(--blue);
      color:#fff;
      border-radius:999px;
    }

    table {
      width:100%;
      border-collapse:collapse;
      margin-top:8px;
      background:#fff;
    }

    th,td {
      border:1px solid #eef1f6;
      padding:6px 8px;
      text-align:center;
      font-size:13px;
    }

    th { background:#f7f9fe }

    .muted { font-size:13px; color:var(--muted) }
    .section {
      background:var(--bg);
      border-radius:12px;
      padding:12px;
      margin-top:8px;
    }

    .hidden { display:none }

    video {
      width:100%;
      max-height:230px;
      border-radius:10px;
      background:#000;
    }

    .low { background:#fff1f1 }

    .ok{color:var(--greenD);font-weight:600}
    .warn{color:var(--red);font-weight:600}

    /* KPIs */
    .kpi-row {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:8px;
    }

    .kpi {
      flex:1 1 130px;
      background:#ffffff;
      border-radius:10px;
      padding:8px 10px;
      border:1px solid #dde2f2;
      font-size:13px;
    }

    .kpi label {
      display:block;
      font-size:11px;
      color:var(--muted);
      margin-bottom:2px;
    }

    .kpi strong { font-size:15px }

    /* Ticket modal */
    #ticketOverlay {
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.42);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:9999;
    }

    #ticketBox {
      background:#fff;
      border-radius:16px;
      width:100%;
      max-width:420px;
      padding:16px 18px 18px;
      box-shadow:0 18px 40px rgba(0,0,0,.35);
      position:relative;
    }

    #ticketHeader {
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      margin-bottom:6px;
    }

    #ticketContent {
      font-family:monospace;
      font-size:13px;
      border:1px dashed #ccc;
      border-radius:10px;
      padding:10px 10px 8px;
      max-height:400px;
      overflow:auto;
      background:#fafafa;
      white-space:pre-wrap;
    }

    #ticketFooter {
      margin-top:8px;
      text-align:right;
    }

    @keyframes fade {
      from { opacity:0; transform:translateY(-6px); }
      to   { opacity:1; transform:none; }
    }
  </style>
</head>

<body>
  <div class="card">
    <h2>Tiendita</h2>

    <!-- LOGIN -->
    <div id="loginBox">
      <div class="grid">
        <input id="email" type="email" placeholder="Correo" autocomplete="username" />
        <input id="password" type="password" placeholder="Contrase√±a" autocomplete="current-password" />
        <button id="btnLogin">Iniciar sesi√≥n</button>
      </div>
      <div id="resultado" class="muted">Listo para iniciar sesi√≥n‚Ä¶</div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" class="hidden">
      <div class="grid col2">
        <div>
          <div id="userTitle" class="muted">üë§ ‚Äî</div>
          <div id="userRole" class="muted">Rol: ‚Äî</div>
        </div>
        <div style="text-align:right">
          <button id="btnLogout" class="destructive">Cerrar sesi√≥n</button>
        </div>
      </div>

      <div class="menu" id="menuOpciones"></div>

      <div id="vistas" style="margin-top:10px">
        <!-- VISTA VENTAS -->
        <div id="vistaVentas" class="section">
          <h3>üõí Registrar venta</h3>

          <div class="grid col3">
            <input id="codigoBarras" type="text" placeholder="C√≥digo de barras" />
            <button id="btnBuscarCodigo" class="ghost">Buscar / Agregar</button>
            <button id="btnStartScanner" class="ghost">üì∑ Escanear</button>
          </div>
          <video id="preview" autoplay muted playsinline class="hidden" style="margin-top:6px"></video>

          <form id="formVenta" class="grid col3" style="margin-top:10px">
            <select id="ventaProducto"></select>
            <input id="ventaCantidad" type="number" min="1" placeholder="Cantidad" required />
            <button type="submit" class="secondary">Agregar al Carrito</button>
          </form>

          <h4 style="margin:10px 0 4px">Carrito</h4>
          <table>
            <thead>
              <tr><th>Producto</th><th>Cant</th><th>Precio</th><th>Subtotal</th></tr>
            </thead>
            <tbody id="tablaCarrito"></tbody>
          </table>

          <div class="grid col3" style="align-items:center;margin-top:10px">
            <div>
              <div class="muted">Total venta:</div>
              <div style="font-weight:800;font-size:18px">$<span id="totalVenta">0.00</span></div>
            </div>
            <div>
              <div class="muted">Efectivo recibido:</div>
              <input id="efectivoRecibido" type="number" min="0" step="0.01" placeholder="0.00" />
              <div class="muted">Cambio: $<span id="cambioCalculado">0.00</span></div>
            </div>
            <div style="text-align:right">
              <button id="btnFinalizarVenta">Finalizar venta</button>
            </div>
          </div>
        </div>

        <!-- VISTA INVENTARIO -->
        <div id="vistaInventario" class="hidden section">
          <h3>üìä Movimientos de inventario</h3>
          <p class="muted">
            Registrar entradas manuales por <strong>c√≥digo de barras</strong>. Las salidas por venta se generan autom√°ticamente.
          </p>
          <form id="formEntrada" class="grid col3" style="margin-top:8px">
            <input id="invCodigo" type="text" placeholder="C√≥digo de barras" required />
            <input id="invCantidad" type="number" min="1" placeholder="Cantidad" required />
            <button type="submit" class="secondary">Registrar Entrada</button>
          </form>
          <table>
            <thead>
              <tr><th>Producto</th><th>Tipo</th><th>Cantidad</th><th>Fecha</th><th>Motivo</th></tr>
            </thead>
            <tbody id="tablaInventario"></tbody>
          </table>
        </div>

        <!-- VISTA PRODUCTOS (solo Administrador) -->
        <div id="vistaProductos" class="hidden section">
          <h3>üì¶ Productos</h3>
          <form id="formProducto" class="grid col3">
            <input id="prodNombre" type="text" placeholder="Nombre" required />
            <input id="prodPrecio" type="number" step="0.01" placeholder="Precio" required />
            <input id="prodStock" type="number" min="0" placeholder="Stock inicial" required />
            <div class="grid col3" style="grid-column:1 / -1;gap:8px">
              <input id="prodCodigo" type="text" placeholder="C√≥digo de barras" />
              <button type="button" id="btnScanProducto" class="ghost">üì∑ Escanear</button>
              <button type="submit" class="secondary">Guardar</button>
            </div>
          </form>
          <video id="previewProd" autoplay muted playsinline class="hidden" style="margin-top:6px"></video>
          <table>
            <thead>
              <tr><th>ID</th><th>Nombre</th><th>Precio</th><th>Stock</th><th>M√≠n.</th><th>C√≥digo</th></tr>
            </thead>
            <tbody id="tablaProductos"></tbody>
          </table>
        </div>

        <!-- VISTA CAJA -->
        <div id="vistaCaja" class="hidden section">
          <h3>üíµ Caja</h3>
          <p class="muted">
            Los movimientos se generan autom√°ticamente con cada venta (entrada = total, salida = cambio). Tambi√©n puedes registrar fondos iniciales manuales.
          </p>

          <form id="formFondoCaja" class="grid col3" style="margin-top:8px">
            <input id="montoFondo" type="number" min="0" step="0.01" placeholder="Monto fondo inicial" />
            <button type="submit" class="secondary">Registrar fondo inicial</button>
          </form>

          <div class="kpi-row">
            <div class="kpi">
              <label>Entradas</label>
              <strong>$<span id="cajaEntradas">0.00</span></strong>
            </div>
            <div class="kpi">
              <label>Salidas</label>
              <strong>$<span id="cajaSalidas">0.00</span></strong>
            </div>
            <div class="kpi">
              <label>Saldo</label>
              <strong>$<span id="cajaSaldo">0.00</span></strong>
            </div>
          </div>

          <table style="margin-top:8px">
            <thead>
              <tr><th>Tipo</th><th>Monto</th><th>Motivo</th><th>Fecha</th></tr>
            </thead>
            <tbody id="tablaCaja"></tbody>
          </table>
        </div>

        <!-- VISTA HISTORIAL -->
        <div id="vistaHistorial" class="hidden section">
          <h3>üßæ Historial de ventas</h3>
          <table>
            <thead>
              <tr><th>Folio</th><th>Fecha</th><th>Art√≠culos</th><th>Total</th></tr>
            </thead>
            <tbody id="tablaHistorial"></tbody>
          </table>
        </div>

        <!-- VISTA REPORTE (solo Administrador) -->
        <div id="vistaReportes" class="hidden section">
          <h3>üìà Reporte diario</h3>
          <div class="grid col2">
            <button id="btnCargarReporte" class="secondary">Refrescar reporte</button>
            <button id="btnSimularCierre" class="ghost">Simular cierre del d√≠a</button>
          </div>
          <div id="reporteResumen" class="kpi-row"></div>
          <pre id="reporteDetalle" class="muted" style="margin-top:8px;background:#0b1020;color:#c4d0ff;border-radius:10px;padding:10px;max-height:260px;overflow:auto;white-space:pre-wrap"></pre>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL TICKET -->
  <div id="ticketOverlay">
    <div id="ticketBox">
      <div id="ticketHeader">
        <div>
          <strong>Ticket de venta</strong>
          <div class="muted" style="font-size:12px">Tiendita Las Palmas ¬∑ RFC TLP010203AB1</div>
          <div class="muted" style="font-size:11px">Av. Siempre Viva 123, CDMX</div>
        </div>
        <div style="text-align:right;font-size:12px">
          <div>Folio <span id="ticketFolio">‚Äî</span></div>
          <div id="ticketAtendio" class="muted"></div>
        </div>
      </div>
      <div id="ticketContent"></div>
      <div id="ticketFooter">
        <button id="btnCerrarTicket" class="secondary">Cerrar</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const SUPABASE_URL = 'https://gnguvdqdhqrupkkrtdmp.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImduZ3V2ZHFkaHFydXBra3J0ZG1wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3NjEwNTIsImV4cCI6MjA3NTMzNzA1Mn0.a5XbjmM5eyREKI1j0HrZe36Gz52SAz0_3_jzjW8bYo0';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const TIPO_ENTRADA = 'entrada';
    const TIPO_SALIDA  = 'salida';

    const $ = id => document.getElementById(id);
    const peso = n => Number(n ?? 0).toFixed(2);
    const sleep = ms => new Promise(r => setTimeout(r, ms));

    let carrito = [];
    let productosCache = new Map();
    let currentUser = null;
    let currentRole = null;
    let currentNombre = null;

    function beep(){
      try {
        new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg').play();
      } catch {}
    }

    // LOGIN
    $('btnLogin').addEventListener('click', async () => {
      const email = $('email').value.trim();
      const password = $('password').value.trim();
      const out = $('resultado');

      if(!email || !password){
        out.innerHTML = '<span class="warn">Ingresa correo y contrase√±a</span>';
        return;
      }

      out.textContent = 'Iniciando‚Ä¶';

      const { data, error } = await supabase.auth.signInWithPassword({ email, password });

      if(error){
        out.innerHTML = '<span class="warn">'+error.message+'</span>';
        return;
      }

      currentUser = data.user;
      out.innerHTML = '<span class="ok">Login correcto</span>';
      await cargarPerfil(currentUser.id);
    });

    $('btnLogout').addEventListener('click', async () => {
      await supabase.auth.signOut();
      currentUser = null;
      currentRole = null;
      currentNombre = null;
      $('dashboard').classList.add('hidden');
      $('loginBox').classList.remove('hidden');
      $('resultado').textContent = 'üëã Sesi√≥n cerrada.';
    });

    async function cargarPerfil(uid){
      const { data, error } = await supabase
        .from('profiles')
        .select('nombre, rol_id, rol:rol_id(nombre)')
        .eq('user_id', uid)
        .single();

      if(error || !data){
        $('resultado').innerHTML = '<span class="warn">No se encontr√≥ perfil</span>';
        return;
      }

      currentRole  = data.rol?.nombre ?? '‚Äî';
      currentNombre = data.nombre ?? '';

      $('loginBox').classList.add('hidden');
      $('dashboard').classList.remove('hidden');
      $('userTitle').textContent = 'üë§ ' + (currentNombre || 'Usuario');
      $('userRole').textContent  = 'Rol: ' + currentRole;

      const menu = $('menuOpciones');
      menu.innerHTML = '';

      menu.innerHTML += `<button class="secondary" data-v="vistaVentas">üõí Ventas</button>`;
      menu.innerHTML += `<button class="secondary" data-v="vistaInventario">üìä Inventario</button>`;
      menu.innerHTML += `<button class="secondary" data-v="vistaCaja">üíµ Caja</button>`;
      menu.innerHTML += `<button class="secondary" data-v="vistaHistorial">üßæ Historial</button>`;

      if(currentRole === 'Administrador'){
        menu.innerHTML += `<button class="secondary" data-v="vistaProductos">üì¶ Productos</button>`;
        menu.innerHTML += `<button class="secondary" data-v="vistaReportes">üìà Reporte</button>`;
      }

      menu.querySelectorAll('button').forEach(b=>{
        b.addEventListener('click',()=>abrirVista(b.dataset.v));
      });

      abrirVista('vistaVentas');

      await Promise.all([
        cargarProductosVenta(),
        cargarInventario(),
        cargarCaja(),
        cargarHistorial(),
        currentRole === 'Administrador' ? cargarReporte() : Promise.resolve()
      ]);
    }

    function abrirVista(id){
      document.querySelectorAll('#vistas > div').forEach(d=>d.classList.add('hidden'));
      const el = $(id);
      if(el) el.classList.remove('hidden');

      if(id==='vistaProductos') cargarProductos();
      if(id==='vistaInventario') cargarInventario();
      if(id==='vistaCaja') cargarCaja();
      if(id==='vistaHistorial') cargarHistorial();
      if(id==='vistaReportes' && currentRole==='Administrador') cargarReporte();
    }

    // PRODUCTOS
    async function cargarProductos(){
      const { data, error } = await supabase
        .from('productos')
        .select('*')
        .order('id');

      if(error){ console.error(error); return; }

      productosCache.clear();

      $('tablaProductos').innerHTML = (data||[]).map(p=>{
        productosCache.set(p.id,p);
        const low = p.stock < (p.stock_minimo ?? 5) ? 'low':'';
        return `
          <tr class="${low}">
            <td>${p.id}</td>
            <td>${p.nombre}</td>
            <td>$${peso(p.precio)}</td>
            <td>${p.stock}</td>
            <td>${p.stock_minimo ?? '-'}</td>
            <td>${p.codigo_barras || ''}</td>
          </tr>
        `;
      }).join('');
    }

    $('formProducto').addEventListener('submit', async e=>{
      e.preventDefault();

      const nombre = $('prodNombre').value.trim();
      const precio = parseFloat($('prodPrecio').value);
      const stock  = parseInt($('prodStock').value || '0',10);
      const codigo = $('prodCodigo').value.trim() || null;

      if(!nombre || isNaN(precio)){
        alert('Completa nombre y precio');
        return;
      }

      const { error } = await supabase.from('productos').insert({
        nombre, precio, stock, codigo_barras: codigo
      });

      if(error){
        alert('Error guardando producto: ' + error.message);
        return;
      }

      e.target.reset();
      await Promise.all([cargarProductos(), cargarProductosVenta()]);
      alert('Producto guardado');
    });

    // ESC√ÅNER PARA PRODUCTOS
    let prodStream=null, prodDetector=null, prodScanning=false;

    $('btnScanProducto').addEventListener('click', async ()=>{
      if(prodScanning){
        stopScanProd();
        return;
      }

      if(!('BarcodeDetector' in window)){
        alert('Tu navegador no soporta escaneo nativo.');
        return;
      }

      const video = $('previewProd');
      video.classList.remove('hidden');

      prodStream = await navigator.mediaDevices.getUserMedia({
        video:{ facingMode:{ ideal:'environment' } },
        audio:false
      });

      video.srcObject = prodStream;
      prodDetector = new BarcodeDetector({ formats:['ean_13','ean_8','upc_a','code_128'] });
      prodScanning = true;
      scanProdLoop(video);
    });

    function stopScanProd(){
      prodScanning=false;
      if(prodStream){ prodStream.getTracks().forEach(t=>t.stop()); prodStream=null; }
      $('previewProd').classList.add('hidden');
    }

    async function scanProdLoop(video){
      while(prodScanning && prodDetector){
        try{
          if(!video.videoWidth){ await sleep(150); continue; }

          const canvas=document.createElement('canvas');
          canvas.width=video.videoWidth;
          canvas.height=video.videoHeight;
          canvas.getContext('2d').drawImage(video,0,0,canvas.width,canvas.height);

          const bmp=await createImageBitmap(canvas);
          const codes=await prodDetector.detect(bmp);

          if(codes && codes.length){
            const code=String(codes[0].rawValue || '');
            if(code){
              $('prodCodigo').value=code;
              beep();
              stopScanProd();
              break;
            }
          }
        } catch(e){ console.error(e); }
        await sleep(200);
      }
    }

    // VENTAS
    async function cargarProductosVenta(){
      const { data, error } = await supabase
        .from('productos')
        .select('id,nombre,precio,stock,codigo_barras')
        .order('nombre');

      if(error){ console.error(error); return; }

      const sel=$('ventaProducto');
      sel.innerHTML='';
      productosCache.clear();

      for(const p of (data||[])){
        productosCache.set(p.id,p);
        sel.innerHTML += `
          <option value="${p.id}">
            ${p.nombre} ($${peso(p.precio)}) ‚Äî ${p.stock} en stock
          </option>
        `;
      }

      carrito=[];
      renderCarrito();
    }

    $('btnBuscarCodigo').addEventListener('click', async ()=>{
      const code=$('codigoBarras').value.trim();
      if(!code) return;

      const { data, error } = await supabase
        .from('productos')
        .select('*')
        .eq('codigo_barras',code)
        .maybeSingle();

      $('codigoBarras').value='';

      if(error || !data){
        alert('No se encontr√≥ producto para ese c√≥digo');
        return;
      }

      addToCartFromProduct(data,1);
      beep();
    });

    // ESC√ÅNER PARA VENTAS
    let ventaStream=null, ventaDetector=null, ventaScanning=false;

    $('btnStartScanner').addEventListener('click', async ()=>{
      if(ventaScanning){
        stopScanVenta();
        return;
      }

      if(!('BarcodeDetector' in window)){
        alert('Tu navegador no soporta escaneo nativo.');
        return;
      }

      const video = $('preview');
      video.classList.remove('hidden');

      ventaStream = await navigator.mediaDevices.getUserMedia({
        video:{ facingMode:{ ideal:'environment' } },
        audio:false
      });

      video.srcObject = ventaStream;
      ventaDetector = new BarcodeDetector({ formats:['ean_13','ean_8','upc_a','code_128'] });
      ventaScanning = true;
      scanVentaLoop(video);
    });

    function stopScanVenta(){
      ventaScanning=false;
      if(ventaStream){ ventaStream.getTracks().forEach(t=>t.stop()); ventaStream=null; }
      $('preview').classList.add('hidden');
    }

    async function scanVentaLoop(video){
      while(ventaScanning && ventaDetector){
        try{
          if(!video.videoWidth){ await sleep(150); continue; }

          const canvas=document.createElement('canvas');
          canvas.width=video.videoWidth;
          canvas.height=video.videoHeight;
          canvas.getContext('2d').drawImage(video,0,0,canvas.width,canvas.height);

          const bmp=await createImageBitmap(canvas);
          const codes=await ventaDetector.detect(bmp);

          if(codes && codes.length){
            const code=String(codes[0].rawValue || '');
            if(code){
              $('codigoBarras').value=code;
              beep();
              stopScanVenta();
              await $('btnBuscarCodigo').click();
              break;
            }
          }
        } catch(e){ console.error(e); }
        await sleep(200);
      }
    }

    // FORM VENTA
    $('formVenta').addEventListener('submit',e=>{
      e.preventDefault();

      const id=parseInt($('ventaProducto').value,10);
      const cant=parseInt($('ventaCantidad').value,10);
      const p=productosCache.get(id);

      if(!p){
        alert('Producto inexistente');
        return;
      }

      addToCartFromProduct(p,cant);
      e.target.reset();
    });

    function addToCartFromProduct(p, cantidad){
      if (!p || !cantidad || cantidad <= 0) return;

      const enCarrito = carrito.find(x => x.id === p.id)?.cantidad ?? 0;

      if (p.stock != null && (cantidad + enCarrito) > p.stock){
        alert(`Solo hay ${p.stock} unidades de "${p.nombre}" en stock`);
        return;
      }

      const ya = carrito.find(x=>x.id === p.id);

      if (ya){
        ya.cantidad += cantidad;
      } else {
        carrito.push({
          id: Number(p.id),
          nombre: String(p.nombre),
          precio: Number(p.precio),
          cantidad: Number(cantidad)
        });
      }

      renderCarrito();
    }

    function renderCarrito(){
      $('tablaCarrito').innerHTML = carrito.map(c=>`
        <tr>
          <td>${c.nombre}</td>
          <td>${c.cantidad}</td>
          <td>$${peso(c.precio)}</td>
          <td>$${peso(c.cantidad*c.precio)}</td>
        </tr>
      `).join('');

      const total = carrito.reduce((s,c)=>s+c.cantidad*c.precio,0);
      $('totalVenta').textContent=peso(total);

      const efectivo=parseFloat($('efectivoRecibido').value||'0');
      const cambio = efectivo>0 ? Math.max(efectivo-total,0):0;
      $('cambioCalculado').textContent=peso(cambio);
    }

    $('efectivoRecibido').addEventListener('input',renderCarrito);

    // FINALIZAR VENTA usando RPC registrar_venta
    $('btnFinalizarVenta').addEventListener('click', async ()=>{
      console.log("FINALIZAR PRESIONADO");
      console.log("Carrito:", JSON.parse(JSON.stringify(carrito)));

      if (!carrito.length){
        alert("Carrito vac√≠o");
        return;
      }

      const efectivo = parseFloat($('efectivoRecibido').value||'0');
      if (isNaN(efectivo) || efectivo <= 0){
        alert("Captura el efectivo recibido");
        return;
      }

      // Total y cambio calculados en frontend
      const total = carrito.reduce((s,c)=>s + c.cantidad * c.precio, 0);
      const cambio = Math.max(efectivo - total, 0);

      // Se env√≠a producto_id como espera la funci√≥n en Postgres
      const itemsLimpios = carrito.map(c => ({
        producto_id: c.id,
        cantidad: c.cantidad,
        precio: c.precio
      }));

      console.log("Mandando a RPC registrar_venta:", itemsLimpios);

      const { data, error } = await supabase.rpc('registrar_venta', {
        p_items: itemsLimpios,
        p_efectivo: efectivo
      });

      console.log("Respuesta RPC:", data, error);

      if (error){
        alert("Error registrando venta: " + error.message);
        console.error(error);
        return;
      }

      if (!data){
        alert("La funci√≥n registrar_venta no regres√≥ nada.");
        return;
      }

      const ventaId = data.venta_id || data.id || null;

      // Registrar movimientos en caja desde frontend
      try{
        await supabase.from('caja_movimientos').insert([
          {
            tipo: TIPO_ENTRADA,
            monto: total,
            motivo: ventaId ? `Venta #${ventaId}` : 'Venta'
          },
          {
            tipo: TIPO_SALIDA,
            monto: cambio,
            motivo: ventaId ? `Cambio venta #${ventaId}` : 'Cambio venta'
          }
        ]);
      }catch(e){
        console.error('Error registrando movimientos de caja:', e);
      }

      const deseaTicket = confirm(
        `Venta${ventaId ? ' #' + ventaId : ''} registrada.\n\n` +
        `Total:  $${peso(total)}\n` +
        `Efectivo: $${peso(efectivo)}\n` +
        `Cambio: $${peso(cambio)}\n\n` +
        `¬øDeseas imprimir ticket?`
      );

      if (deseaTicket){
        mostrarTicket(ventaId ?? '-', new Date().toISOString(), carrito, total, efectivo, cambio);
      }

      carrito = [];
      $('efectivoRecibido').value = '';
      renderCarrito();

      await Promise.all([
        cargarProductosVenta(),
        cargarInventario(),
        cargarCaja(),
        cargarHistorial(),
        currentRole==='Administrador'?cargarReporte():Promise.resolve()
      ]);
    });

    // TICKET
    function mostrarTicket(folio, fechaISO, items, total, efectivo, cambio){
      $('ticketFolio').textContent = folio;
      const fecha = fechaISO ? new Date(fechaISO) : new Date();
      const fechaTxt = fecha.toLocaleString();

      if(currentNombre){
        const rolLbl = currentRole ? ` (${currentRole})` : '';
        $('ticketAtendio').textContent = currentNombre + rolLbl;
      }else{
        $('ticketAtendio').textContent = '';
      }

      let lines=[];
      lines.push('        TIENDITA LAS PALMAS');
      lines.push('          RFC: TLP010203AB1');
      lines.push('   Av. Siempre Viva 123, CDMX');
      lines.push('--------------------------------');
      lines.push(`Folio: ${folio}`);
      lines.push(`Fecha: ${fechaTxt}`);
      if(currentNombre) lines.push(`Atendi√≥: ${currentNombre}`);
      lines.push('--------------------------------');
      lines.push(' PRODUCTO           CANT   IMP');
      lines.push('--------------------------------');
      for(const c of items){
        const nombre = (c.nombre||'').substring(0,16).padEnd(16,' ');
        const cant   = String(c.cantidad).padStart(3,' ');
        const imp    = peso(c.cantidad*c.precio).padStart(7,' ');
        lines.push(` ${nombre} ${cant} ${imp}`);
      }
      lines.push('--------------------------------');
      lines.push(` SUBTOTAL:         $${peso(total)}`);
      lines.push(` EFECTIVO:         $${peso(efectivo)}`);
      lines.push(` CAMBIO:           $${peso(cambio)}`);
      lines.push('--------------------------------');
      lines.push('      GRACIAS POR SU COMPRA');
      lines.push('   ESTE DOCUMENTO NO ES CFDI');

      $('ticketContent').textContent = lines.join('\n');
      $('ticketOverlay').style.display='flex';
    }

    $('btnCerrarTicket').addEventListener('click',()=>{
      $('ticketOverlay').style.display='none';
    });

    $('ticketOverlay').addEventListener('click',e=>{
      if(e.target.id==='ticketOverlay'){
        $('ticketOverlay').style.display='none';
      }
    });

    // INVENTARIO
    async function cargarInventario(){
      const { data, error } = await supabase
        .from('inventario_movimientos')
        .select('producto_id,tipo,cantidad,fecha,motivo')
        .order('fecha',{ascending:false})
        .limit(100);

      if(error){ console.error(error); return; }

      const ids=[...new Set((data||[]).map(m=>m.producto_id).filter(Boolean))];
      let nombres={};

      if(ids.length){
        const { data:prods } = await supabase
          .from('productos')
          .select('id,nombre')
          .in('id',ids);
        for(const p of (prods||[])) nombres[p.id]=p.nombre;
      }

      $('tablaInventario').innerHTML = (data||[]).map(m=>`
        <tr>
          <td>${nombres[m.producto_id] || ('#'+m.producto_id)}</td>
          <td>${(m.tipo||'').toUpperCase()}</td>
          <td>${m.cantidad}</td>
          <td>${m.fecha? new Date(m.fecha).toLocaleString():''}</td>
          <td>${m.motivo||''}</td>
        </tr>
      `).join('');
    }

    $('formEntrada').addEventListener('submit',async e=>{
      e.preventDefault();
      const codigo = $('invCodigo').value.trim();
      const cantidad = parseInt($('invCantidad').value, 10);

      if (!codigo || !cantidad || cantidad <= 0) {
        alert('Completa c√≥digo y cantidad');
        return;
      }

      const { data:p, error } = await supabase
        .from('productos')
        .select('id,stock')
        .eq('codigo_barras', codigo)
        .maybeSingle();

      if (error || !p) {
        alert('No se encontr√≥ producto con ese c√≥digo');
        return;
      }

      try {
        await supabase.from('inventario_movimientos').insert({
          producto_id: p.id,
          tipo: TIPO_ENTRADA,
          cantidad: cantidad,
          motivo: 'Entrada manual'
        });

        await supabase.from('productos')
          .update({
            stock: (p.stock || 0) + cantidad,
            actualizado_en: new Date().toISOString()
          })
          .eq('id', p.id);

        e.target.reset();

        await Promise.all([
          cargarInventario(),
          cargarProductosVenta(),
          cargarProductos()
        ]);

      } catch(err) {
        alert('Error registrando inventario: ' + err.message);
      }
    });

    // CAJA
    async function cargarCaja(){
      const { data, error } = await supabase
        .from('caja_movimientos')
        .select('*')
        .order('fecha',{ascending:false})
        .limit(200);

      if(error){console.error(error);return;}

      let entradas=0,salidas=0;
      for(const m of (data||[])){
        if(m.tipo===TIPO_ENTRADA) entradas += Number(m.monto||0);
        else if(m.tipo===TIPO_SALIDA) salidas += Number(m.monto||0);
      }

      $('cajaEntradas').textContent=peso(entradas);
      $('cajaSalidas').textContent=peso(salidas);
      $('cajaSaldo').textContent=peso(entradas-salidas);

      $('tablaCaja').innerHTML = (data||[]).map(m=>`
        <tr>
          <td>${m.tipo}</td>
          <td>$${peso(m.monto)}</td>
          <td>${m.motivo||''}</td>
          <td>${m.fecha?new Date(m.fecha).toLocaleString():''}</td>
        </tr>
      `).join('');
    }

    $('formFondoCaja').addEventListener('submit', async e=>{
      e.preventDefault();
      const monto = parseFloat($('montoFondo').value||'0');
      if(isNaN(monto) || monto<=0){
        alert('Captura un monto v√°lido para el fondo');
        return;
      }
      const { error } = await supabase.from('caja_movimientos').insert({
        tipo:TIPO_ENTRADA,
        monto,
        motivo:'Fondo inicial'
      });
      if(error){
        alert('Error registrando fondo: '+error.message);
        return;
      }
      $('montoFondo').value='';
      await cargarCaja();
      alert('Fondo inicial registrado');
    });

    // HISTORIAL
    async function cargarHistorial(){
      const { data:ventas, error } = await supabase
        .from('ventas')
        .select('id,fecha')
        .order('id',{ascending:false})
        .limit(50);
      if(error || !ventas){console.error(error);return;}
      const ids = ventas.map(v=>v.id);
      let items=[];
      if(ids.length){
        const { data:i, error:errI } = await supabase
          .from('ventas_items')
          .select('venta_id,cantidad,precio_unitario')
          .in('venta_id',ids);
        if(errI){console.error(errI);return;}
        items=i||[];
      }
      const totales={};
      for(const it of items){
        if(!totales[it.venta_id]) totales[it.venta_id]={cantidad:0,total:0};
        totales[it.venta_id].cantidad += it.cantidad;
        totales[it.venta_id].total    += it.cantidad*it.precio_unitario;
      }
      $('tablaHistorial').innerHTML = (ventas||[]).map(v=>{
        const d = totales[v.id] || {cantidad:0,total:0};
        return `<tr>
          <td>${v.id}</td>
          <td>${v.fecha?new Date(v.fecha).toLocaleString():''}</td>
          <td>${d.cantidad}</td>
          <td>$${peso(d.total)}</td>
        </tr>`;
      }).join('');
    }

    // REPORTE
    $('btnCargarReporte')?.addEventListener('click',cargarReporte);
    $('btnSimularCierre')?.addEventListener('click',()=>alert('Esto es solo una simulaci√≥n visual de cierre.'));

    async function cargarReporte(){
      if(currentRole!=='Administrador') return;
      try{
        const hoy = new Date();
        const inicio = new Date(hoy.getFullYear(),hoy.getMonth(),hoy.getDate());
        const fin    = new Date(hoy.getFullYear(),hoy.getMonth(),hoy.getDate()+1);

        const { data:ventas, error:errV } = await supabase
          .from('ventas')
          .select('id,fecha')
          .gte('fecha',inicio.toISOString())
          .lt('fecha',fin.toISOString())
          .order('id',{ascending:true});
        if(errV) throw errV;

        const ids = ventas?.map(v=>v.id) || [];
        let items=[];
        if(ids.length){
          const { data:i, error:errI } = await supabase
            .from('ventas_items')
            .select('venta_id,cantidad,precio_unitario')
            .in('venta_id',ids);
          if(errI) throw errI;
          items=i||[];
        }

        let resumenPorVenta={};
        for(const v of (ventas||[])){
          resumenPorVenta[v.id]={total:0,articulos:0};
        }
        for(const it of items){
          const r=resumenPorVenta[it.venta_id];
          if(!r) continue;
          r.total     += it.cantidad*it.precio_unitario;
          r.articulos += it.cantidad;
        }

        let totalDia=0,articulosDia=0,ventasCount=ventas.length;
        for(const id of Object.keys(resumenPorVenta)){
          totalDia    += resumenPorVenta[id].total;
          articulosDia+= resumenPorVenta[id].articulos;
        }

        const { data:caja } = await supabase
          .from('caja_movimientos')
          .select('tipo,monto')
          .gte('fecha',inicio.toISOString())
          .lt('fecha',fin.toISOString());
        let entradas=0,salidas=0;
        for(const m of (caja||[])){
          if(m.tipo===TIPO_ENTRADA) entradas+=Number(m.monto||0);
          else if(m.tipo===TIPO_SALIDA) salidas+=Number(m.monto||0);
        }

        const kpi = $('reporteResumen');
        kpi.innerHTML = `
          <div class="kpi">
            <label>Ventas del d√≠a</label>
            <strong>${ventasCount}</strong>
          </div>
          <div class="kpi">
            <label>Art√≠culos vendidos</label>
            <strong>${articulosDia}</strong>
          </div>
          <div class="kpi">
            <label>Importe vendido</label>
            <strong>$${peso(totalDia)}</strong>
          </div>
          <div class="kpi">
            <label>Efectivo neto (caja)</label>
            <strong>$${peso(entradas-salidas)}</strong>
          </div>
        `;

        let detalle=[];
        detalle.push('RESUMEN DETALLADO DEL D√çA');
        detalle.push('----------------------------------------');
        for(const v of (ventas||[])){
          const r=resumenPorVenta[v.id];
          detalle.push(
            `Venta #${v.id}  ${new Date(v.fecha).toLocaleTimeString()}  Art: ${r.articulos}  Total: $${peso(r.total)}`
          );
        }
        if(!ventas.length) detalle.push('Sin ventas registradas hoy.');
        $('reporteDetalle').textContent = detalle.join('\n');
      }catch(e){
        console.error(e);
        $('reporteDetalle').textContent = 'Error cargando reporte: '+e.message;
      }
    }
  </script>
</body>
</html>
